---
title: "Baseline comparisons of motor task performance"
author: "M.E. Johansson"
date: "25/2/2022"
output: 
  html_document: 
    toc: yes
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r set-options, echo=FALSE, cache=FALSE}
# options(width = 150)
```

# Prepare R environment

```{r libraries, echo=FALSE, message=FALSE}
# funcdir <- 'H:/sysneu/marjoh/scripts/Personalized-Parkinson-Project-Motor/R/functions/'
# funcs <- list.files(funcdir, full.names = TRUE)
# sapply(funcs, source)
library(MASS)
library(sjPlot); library(sjlabelled); library(sjmisc)
library(tidyverse)
library(cowplot)
library(readr)
options(dplyr.summarise.inform = FALSE)
library(lme4)
library(lmerTest)
library(emmeans)
emm_options(lmerTest.df = 'satterthwaite')
emm_options(lmerTest.limit = 50000)
emm_options(disable.pbkrtest=TRUE)
library(effectsize)
library(car)
library(finalfit)
library(lattice)
library(viridis)
library(extrafont)
library(kableExtra)
library(ggpubr);library(ggforce);library(gghalves);library(ggdist);library(ggeffects); library(GGally)
library(cocor)
loadfonts(device='win',quiet = TRUE)

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')

sigsize=7
lsize=0.6
legend_position <- c(0.92,1.15)
```

# Load data

## Clinical

```{r datafile-clin, echo=FALSE, warning=FALSE}

# Read data
fClin <- 'P:/3022026.01/pep/ClinVars_10-08-2023/derivatives/merged_manipulated_2023-10-18.csv'
dfClin <- read_csv(fClin, show_col_types = FALSE)

# Add additional scores
source("M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/compute_pase.R")
dfClin <- dfClin %>%
        left_join(., compute_pase(dfClin))
source("M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/compute_cognitive_composite.R")
dfClin <- dfClin %>%
        left_join(., compute_cognitive_composite(dfClin))

# Variable selection
clinvars <- c('pseudonym', 'TimepointNr', 'ParticipantType', 'CrossStudyParticipation', 'Subtype_DiagEx3_DisDurSplit', 'Age', 'Gender', 'NpsEducYears', 'PrefHand', 'MonthSinceDiag', 'ParkinMedUser', 'LEDD', 'Up3OfHoeYah', 'MostAffSide', 'Up3OfTotal', 'Up3OfAppendicularSum', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfPIGDSum_Up3Only', 'Up3OfCompositeTremorSum', 'Up3OnTotal', 'Up3OnAppendicularSum', 'Up3OnBradySum', 'Up3OnRigiditySum', 'Up3OnPIGDSum', 'Up3OnPIGDSum_Up3Only', 'Up3OnCompositeTremorSum', 'Up3TotalOnOffDelta', 'Up3AppendicularOnOffDelta', 'Up3BradySumOnOffDelta', 'Up3RigidityOnOffDelta', 'Up3OfTotal_pit', 'Up3OfAppendicularSum_pit', 'Up3OfBradySum_pit', 'Up3OfPIGDSum_pit', 'Up3OfCompositeTremorSum_pit', 'Up2Total', 'MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum','MotorComposite', 'CognitiveComposite','CognitiveComposite_raw','SCOPA_AUTSum', 'RBDSQSum', 'PASE', 'DiagParkCertain', 'DiagParkPersist', 'DiagParkReplace')
dfClin <- dfClin %>%
        filter(MriNeuroPsychTask == 'Motor') %>%
        filter(!is.na(ParticipantType)) %>%
        select(all_of(clinvars)) %>%
        rename(Subtype = Subtype_DiagEx3_DisDurSplit) %>%
        mutate(TimepointNr = factor(TimepointNr),
               ParticipantType = factor(ParticipantType),
               Gender = factor(Gender),
               Subtype = if_else(ParticipantType=='HC_PIT', '0_Healthy', Subtype),
               Subtype = if_else(is.na(Subtype),'4_Undefined',Subtype),
               Subtype = factor(Subtype))

# Binarize the MostAffSide variable to Right and Left or NA
dfClin$MostAffSide[dfClin$MostAffSide=='BiL>R'] <- 'Left'
dfClin$MostAffSide[dfClin$MostAffSide=='LeftOnly'] <- 'Left'
dfClin$MostAffSide[dfClin$MostAffSide=='BiR>L'] <- 'Right'
dfClin$MostAffSide[dfClin$MostAffSide=='Right'] <- 'Right'
dfClin$MostAffSide[dfClin$MostAffSide=='RightOnly'] <- 'Right'
dfClin$MostAffSide[dfClin$MostAffSide=='BiR=L'] <- 'Bilateral'
dfClin$MostAffSide[dfClin$MostAffSide=='None'] <- 'Bilateral'

# Create a variable of groups (fixes the faulty labels in task data)
pType <- dfClin %>%
        select(pseudonym,ParticipantType) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(across(everything(), ~first(.x)))

# Print N
dfClin %>% select(ParticipantType,TimepointNr) %>% table() %>% print()

# Merge motor sub-scores for POM and PIT. Rigidity is not included since the variables
# names in Castor match exactly between the studies
dfClin <- dfClin %>%
        unite('Up3OfTotal', Up3OfTotal, Up3OfTotal_pit, na.rm = TRUE) %>%
        unite('Up3OfAppendicularSum', Up3OfAppendicularSum, Up3OfAppendicularSum_pit,
              na.rm = TRUE) %>%
        unite('Up3OfBradySum', Up3OfBradySum, Up3OfBradySum_pit, na.rm = TRUE) %>%
        unite('Up3OfPIGDSum', Up3OfPIGDSum, Up3OfPIGDSum_pit, na.rm = TRUE) %>%
        unite('Up3OfCompositeTremorSum', Up3OfCompositeTremorSum, Up3OfCompositeTremorSum_pit,
              na.rm = TRUE) %>%
        mutate(Up3OfTotal = as.numeric(Up3OfTotal),
               Up3OfAppendicularSum = as.numeric(Up3OfAppendicularSum),
               Up3OfBradySum = as.numeric(Up3OfBradySum),
               Up3OfPIGDSum = as.numeric(Up3OfPIGDSum),
               Up3OfCompositeTremorSum = as.numeric(Up3OfCompositeTremorSum),
               Up3OnTotal = as.numeric(Up3OnTotal),
               Up3OnAppendicularSum = as.numeric(Up3OnAppendicularSum),
               Up3OnBradySum = as.numeric(Up3OnBradySum),
               Up3OnPIGDSum = as.numeric(Up3OnPIGDSum),
               Up3OnCompositeTremorSum = as.numeric(Up3OnCompositeTremorSum))

# Select ON or OFF medication scores
dfClin <- dfClin %>%
        mutate(Up3Total=Up3OfTotal, 
               Up3AppendicularSum=Up3OfAppendicularSum, 
               Up3BradySum=Up3OfBradySum,
               Up3RigiditySum=Up3OfRigiditySum)

```

## Task performance

```{r datafile-task, echo=FALSE, warning=FALSE}
# fTask <- 'P:/3022026.01/pep/bids/derivatives/merged_motor_task_mri_2023-08-11.csv'
fTask <- 'P:/3022026.01/pep/bids/derivatives/merged_motor_task_mri_2023-09-15.csv'
dfTask <- read_csv(fTask, show_col_types = FALSE)

# LEGACY COMPATIBILITY
dfTask <- dfTask %>%
        mutate(trial_type = case_when(
                trial_type == 'NChoice1' ~ '1choice',
                trial_type == 'NChoice2' ~ '2choice',
                trial_type == 'NChoice3' ~ '3choice',
        ))

# Aggregate by trial number
dfTask %>%
        group_by(pseudonym,Timepoint,trial_type,block) %>%
        summarise(response_time=mean(response_time,na.rm=T))

# FIX: Error in composite file containing task data. Two subjects have more than
# one run. The first of two runs is always a throw-away, so here we remove it
datfix1 <- dfTask %>% 
        filter(pseudonym=='sub-POMU36B301883A01F609') %>%
        filter(!row_number() %in% c(1:77))
dfTask <- dfTask %>%
        filter(pseudonym != 'sub-POMU36B301883A01F609') %>%
        bind_rows(., datfix1)
datfix2 <- dfTask %>% filter(pseudonym=='sub-POMU7272D851E73EF700') %>%
        filter(!row_number() %in% c(133:264))
dfTask <- dfTask %>%
        filter(pseudonym != 'sub-POMU7272D851E73EF700') %>%
        bind_rows(., datfix2)
# FIX: Subject did not complete task and had very poor performance
dfTask <- dfTask %>%
        filter(pseudonym != 'sub-POMU149380E0444BEC93')

# Replace button press variability variable for a better version
source("M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/compute_bp_coeff_of_var2.R")
bp_cov <- dfTask %>%
    filter(event_type=='response',
           correct_response == 'Hit') %>%
    group_by(pseudonym,Group,Timepoint) %>%
    mutate(Button.Press.CoV=bp_var(button_pressed)) %>%
    summarise(across(everything(), ~first(.x))) %>%
    ungroup() %>%
    select(pseudonym,Group,Timepoint,Button.Press.CoV)
dfTask <- dfTask %>%
        select(-Button.Press.CoV) %>%
        left_join(., bp_cov, by=c('pseudonym','Group','Timepoint'))

# Initial variable selection and clean up
dfTask <- dfTask %>%
    select(pseudonym, Group, Timepoint, trial_type, response_time, trial_number,
           event_type, correct_response, block, RespondingHand, 
           Button.Press.SwitchRatio, Button.Press.CoV) %>%
    mutate(TimepointNr = if_else(str_detect(Timepoint, 'Visit1'), '0', '2'),
           TimepointNr = factor(TimepointNr),
           trial_type=factor(trial_type),
           block=factor(block),
           RespondingHand=factor(RespondingHand),
           error = if_else(correct_response=='Incorrect',1,0),
           correct = if_else(correct_response=='Hit',1,0),
           miss = if_else(correct_response=='Miss',1,0),
           false_alarm = if_else(correct_response=='False Alarm',1,0)) %>%
    relocate(pseudonym, TimepointNr) %>%
    select(-Timepoint)

# Missed responses
misses <- dfTask %>%
        filter(is.na(response_time), event_type=='cue', correct_response=='Miss') %>%
        group_by(pseudonym, Group, TimepointNr, trial_type, block) %>%
        summarise(n_misses=n()) %>%
        ungroup()
dfTask <- dfTask %>%
        left_join(., misses) %>%
        mutate(n_misses = if_else(is.na(n_misses),0,n_misses))

# False alarms
false_alarms <- dfTask %>%
        filter(event_type == 'cue') %>%
        filter(trial_type == 'Catch') %>%
        mutate(false_alarm = if_else(correct_response=='False Alarm',1,0)) %>%
        group_by(pseudonym,Group,TimepointNr) %>%
        summarise(n_false_alarm=sum(false_alarm)) %>%
        ungroup()
dfTask <- dfTask %>%
        left_join(., false_alarms) %>%
        mutate(n_false_alarm = if_else(is.na(n_false_alarm),0,n_false_alarm))

# Divide into separate datastreams
dfTask.rt <- dfTask %>%
    filter(event_type == 'response') %>%
    filter(trial_type != 'Catch') %>%
    filter(response_time > 0.3) %>%
    filter(correct_response=='Hit') %>%
    select(pseudonym, Group, TimepointNr, trial_type, block, RespondingHand,
           response_time) %>%
    mutate(trial_type=factor(trial_type))
dfTask.err <- dfTask %>%
    filter(event_type == 'response') %>%
    filter(trial_type != 'Catch') %>%
    filter(response_time > 0.3) %>%
    select(pseudonym, Group, TimepointNr, trial_type, block, RespondingHand,
           error, correct, Button.Press.CoV, Button.Press.SwitchRatio, n_misses, n_false_alarm) %>%
    mutate(trial_type=factor(trial_type))
# Aggregate
dfTask.rt <- dfTask.rt %>%
    group_by(pseudonym, Group, TimepointNr, trial_type, block) %>%
    summarise(RespondingHand = first(RespondingHand),
              response_time = median(response_time,na.rm=TRUE)) %>%
    ungroup()
dfTask.err <- dfTask.err %>%
    group_by(pseudonym, Group, TimepointNr, trial_type, block) %>%
    summarise(RespondingHand = first(RespondingHand),
              Button.Press.CoV = first(Button.Press.CoV),
              Button.Press.SwitchRatio=first(Button.Press.SwitchRatio),
              n_errors=sum(error),
              n_corrects=sum(correct),
              n_false_alarm = first(n_false_alarm),
              n_misses = first(n_misses),
              error_rate = (n_errors/(n_errors+n_corrects)),
              correct_rate = (n_corrects/(n_errors+n_corrects)),
              miss_rate = n_misses/(n_errors+n_corrects+n_misses),
              false_alarm_rate = n_false_alarm/12) %>%
    ungroup() %>%
    group_by(pseudonym, Group, TimepointNr) %>%
    mutate(total_n_corrects = sum(n_corrects),
           total_n_errors = sum(n_errors),
           total_n_misses = sum(n_misses)) %>%
    ungroup()

# Merge
dfTask <- full_join(dfTask.rt,dfTask.err) %>%
        rename(ParticipantType = Group)

```

# Exclusion

## Diagnosis

```{r echo=FALSE, warning=FALSE}
# Define misdiagnoses
diagnosis <- dfClin %>% select(pseudonym, TimepointNr, DiagParkCertain, DiagParkPersist, DiagParkReplace)
baseline_exclusion <- diagnosis %>%
    filter(TimepointNr=='0', (DiagParkCertain == 'NeitherDisease' | DiagParkCertain == 'DoubtAboutParkinsonism' | DiagParkCertain == 'Parkinsonism')) %>% 
    select(pseudonym, DiagParkCertain)
visit2_exclusion <- diagnosis %>%
    filter(TimepointNr=='2', (DiagParkPersist == 2)) %>% 
    select(pseudonym, DiagParkPersist, DiagParkReplace)
diag_exclusions <- full_join(baseline_exclusion, visit2_exclusion, by='pseudonym') %>% 
    unique()
dfClin <- dfClin %>%
    mutate(Misdiagnosis = if_else(pseudonym %in% diag_exclusions$pseudonym,1,0))

# Report patients with confirmed non-PD diagnosis
cat('Excluding patients with confirmed non-PD diagnosis at baseline and patients who received a non-PD diagnosis at 2-year follow-up\n')
diagnosis %>% filter(TimepointNr=='0') %>% select(DiagParkCertain) %>% table() %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
diagnosis %>% filter(TimepointNr=='2') %>% select(DiagParkPersist) %>% table() %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
diagnosis %>% filter(TimepointNr=='2') %>% select(DiagParkReplace) %>% table() %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
cat('Excluded based on misdiagnosis:\n')
diag_exclusions %>% kable(., 'pipe', digits = 3, padding=0)
# write_csv(diag_exclusions, 'P:/3024006.02/Data/exclusions_diagnosis.csv')

# Exclude subjects with non-PD diagnosis
n1 <- dfTask %>%
    group_by(pseudonym,ParticipantType,TimepointNr) %>%
    summarise(across(everything(), ~first(.x))) %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nTask=n())
n3 <- dfClin %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nClin=n())
n_before <- full_join(n1, n3, by=c('ParticipantType','TimepointNr'))

dfTask <- dfTask %>%
    filter(!(pseudonym %in% diag_exclusions$pseudonym))
dfClin <- dfClin %>%
       filter(!(pseudonym %in% diag_exclusions$pseudonym)) 

n1 <- dfTask %>%
    group_by(pseudonym,ParticipantType,TimepointNr) %>%
    summarise(across(everything(), ~first(.x))) %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nTask=n())
n3 <- dfClin %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nClin=n())
n_after <- full_join(n1, n3, by=c('ParticipantType','TimepointNr'))

cat('Before diagnosis exclusions:\n', sep='')
print(n_before)
cat('After diagnosis exclusions:\n', sep='')
print(n_after)
```

## Accuracy

```{r poor_performance, echo=FALSE}

# Performance
# I've tried to balance the exclusion of subjects due to poor accuracy
# Some perform the task perfectly, just opposite of what is intended
# The subjects do not represent a problem, and excluding them would not 
# be appropriate. A decent balance is when considering average error rates across
# blocks, and by excluding sessions rather than entire subjects
# Current rule:
# If a timepoint has % correct <= 25 & trial_type == '1choice' THEN exclude that session
cat('Excluding sessions where the across-block error rate in 1choice trials is <=25%\n')
poor_performance <- dfTask %>%
    filter(trial_type=='1choice') %>%
    group_by(ParticipantType, pseudonym, TimepointNr, trial_type, block) %>%
    summarise(across(everything(), ~first(.x))) %>% 
    ungroup() %>%
    select(pseudonym, ParticipantType, TimepointNr, trial_type, block, correct_rate) %>%
    pivot_wider(id_cols = c('pseudonym','ParticipantType','TimepointNr', 'trial_type'),
                values_from = correct_rate,
                names_from = block,
                names_prefix = 'block_') %>%
    mutate(success_rate.avg = ((block_1+block_2+block_3)/3),
           poor_performance = if_else(success_rate.avg<=0.25,1,0)) %>% 
    filter(poor_performance==1) %>%
    select(pseudonym, ParticipantType, TimepointNr, block_1, block_2, block_3, success_rate.avg)
cat('Excluded sessions based on error rate:',nrow(poor_performance),'\n')
poor_performance %>% kable(., 'pipe', digits = 3, padding=0)
poor_performance %>% select(ParticipantType,TimepointNr) %>% table() %>% print()
#write_csv(poor_performance, 'P:/3024006.02/Data/exclusions_accuarcy.csv')

n_before <- dfTask %>%
    group_by(pseudonym,ParticipantType,TimepointNr) %>%
    summarise(across(everything(), ~first(.x))) %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nTask=n())

for(n in 1:nrow(poor_performance)){
    row <- poor_performance[n,]
    idx <- which(dfTask$pseudonym==row$pseudonym & dfTask$TimepointNr==row$TimepointNr)
    dfTask <- dfTask[-idx,]
}

n_after <- dfTask %>%
    group_by(pseudonym,ParticipantType,TimepointNr) %>%
    summarise(across(everything(), ~first(.x))) %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nTask=n())

cat('Before accuracy exclusions:\n', sep='')
print(n_before)
cat('After accuracy exclusions:\n', sep='')
print(n_after)
```

## Misses (NO EVAL)

```{r exclude-missresp, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

thr=60
cat('Excluding sessions where there were too many misses (n>', thr, '):\n', sep='')

n_before <- dfTask %>%
        group_by(pseudonym,ParticipantType,TimepointNr) %>%
        summarise(ParticipantType=first(ParticipantType),
                  TimepointNr=first(TimepointNr),
                  total_n_misses=first(total_n_misses)) %>%
        ungroup() %>%
        group_by(ParticipantType,TimepointNr) %>%
        summarise(N=n(),
                  Min=min(total_n_misses),
                  Max=max(total_n_misses),
                  Mean=mean(total_n_misses),
                  SD=sd(total_n_misses)) %>%
        ungroup()

poor_performance <- dfTask %>%
        group_by(pseudonym,ParticipantType,TimepointNr) %>%
        summarise(ParticipantType=first(ParticipantType),
                  TimepointNr=first(TimepointNr),
                  total_n_misses=first(total_n_misses),
                  miss_rate = mean(miss_rate,na.rm=T),
                  error_rate = mean(error_rate),
                  RT = mean(response_time,na.rm=T)) %>%
        mutate(poor_performance = if_else(total_n_misses > thr,1,0)) %>%
        filter(poor_performance == 1) %>%
        ungroup()
cat('Excluded sessions based on number of misses:',nrow(poor_performance),'\n')
poor_performance %>% kable(., 'pipe', digits = 3, padding=0)
poor_performance %>% select(ParticipantType,TimepointNr) %>% table() %>% print()
#write_csv(poor_performance, 'P:/3024006.02/Data/exclusions_misses.csv')

n_after <- dfTask %>%
        filter(total_n_misses < thr) %>%
        group_by(pseudonym,ParticipantType,TimepointNr) %>%
        summarise(ParticipantType=first(ParticipantType),
                  TimepointNr=first(TimepointNr),
                  total_n_misses=first(total_n_misses)) %>%
        ungroup() %>%
        group_by(ParticipantType,TimepointNr) %>%
        summarise(N=n(),
                  Min=min(total_n_misses),
                  Max=max(total_n_misses),
                  Mean=mean(total_n_misses),
                  SD=sd(total_n_misses)) %>%
        ungroup()

cat('Before exclusions due to too many misses:\n', sep='')
print(n_before)
cat('After exclusions due to too many misses:\n', sep='')
print(n_after)

dfTask <- dfTask %>%
        filter(total_misses_by_time < thr)

```

# Data organization

```{r data-assembly, echo=FALSE, warning=TRUE, message=TRUE}

# Merge datasets
dfTask <- dfTask %>%
        filter(TimepointNr == 0) %>%
        mutate(TimepointNr = 0)
dfClin <- dfClin %>%
        filter(TimepointNr==0) %>%
        mutate(TimepointNr = 0)
df <- full_join(dfTask, dfClin, by = c('pseudonym', 'TimepointNr', 'ParticipantType'))

# Factorize
df <- df %>%
        mutate(ParticipantType = factor(ParticipantType),
               Gender = factor(Gender),
               Subtype = factor(Subtype),
               MostAffSide = factor(MostAffSide),
               RespHandIsDominant = if_else(RespondingHand == PrefHand
                                            | RespondingHand == 'NoPref', 1, 0),
               RespHandIsDominant = factor(RespHandIsDominant),
               CrossStudyParticipation=factor(CrossStudyParticipation),
               PrefHand=factor(PrefHand),
               ParkinMedUser=factor(ParkinMedUser),
               Up3OfHoeYah=factor(Up3OfHoeYah),
               DiagParkCertain=factor(DiagParkCertain)) %>%
        mutate(across(where(is.factor), droplevels))

# Aggregate to single observation per participant per condition
df.agg1 <- df %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(response_time,
                           error_rate,correct_rate,miss_rate,false_alarm_rate), ~ mean(.x, na.rm=TRUE)),
                  across(c(n_errors, n_corrects, n_misses, n_false_alarm), ~ sum(.x, na.rm=TRUE)),
                  Subtype = first(Subtype),
                  Gender = first(Gender),
                  Age = first(Age),
                  NpsEducYears = first(NpsEducYears),
                  RespHandIsDominant = first(RespHandIsDominant),
                  Up3OfBradySum = first(Up3OfBradySum),
                  CognitiveComposite = first(CognitiveComposite),
                  CognitiveComposite_raw = first(CognitiveComposite_raw),
                  MoCASum = first(MoCASum),
                  Button.Press.CoV = first(Button.Press.CoV),
                  Button.Press.SwitchRatio = first(Button.Press.SwitchRatio),
                  CrossStudyParticipation=first(CrossStudyParticipation)) %>%
        mutate(response_time = response_time*1000,
               error_rate = error_rate*100,
               correct_rate = correct_rate*100,
               miss_rate = miss_rate*100,
               false_alarm_rate = false_alarm_rate*100) %>%
        ungroup()
# Aggregate to single observation per participant
df.agg2 <- df.agg1 %>%
        pivot_wider(id_cols = c('pseudonym','ParticipantType', 'Subtype','Gender','Age','NpsEducYears', 'RespHandIsDominant',
                                'Up3OfBradySum','CognitiveComposite','CognitiveComposite_raw','MoCASum',
                                'Button.Press.CoV', 'Button.Press.SwitchRatio','CrossStudyParticipation','n_false_alarm',
                                'false_alarm_rate'),
                    names_from = trial_type,
                    values_from = c(response_time,error_rate,correct_rate,miss_rate,
                                    n_errors, n_corrects, n_misses)) %>%
        mutate(RT_Mean = (response_time_1choice+response_time_2choice+response_time_3choice)/3,
               RT_2gt1 = response_time_2choice-response_time_1choice,
               RT_3gt1 = response_time_3choice-response_time_1choice,
               RT_23gt1 = (response_time_2choice+response_time_3choice)/2-response_time_1choice,
               ERR_Mean = (error_rate_1choice+error_rate_2choice+error_rate_3choice)/3,
               ERR_2gt1 = error_rate_2choice-error_rate_1choice,
               ERR_3gt1 = error_rate_3choice-error_rate_1choice,
               ERR_23gt1 = (error_rate_2choice+error_rate_3choice)/2-error_rate_1choice,
               Miss_Mean = (miss_rate_1choice+miss_rate_2choice+miss_rate_3choice)/3,
               Miss_2gt1 = miss_rate_2choice-miss_rate_1choice,
               Miss_3gt1 = miss_rate_3choice-miss_rate_1choice,
               Miss_23gt1 = (miss_rate_2choice+miss_rate_3choice)/2-miss_rate_1choice,
               n_errors = n_errors_1choice+n_errors_2choice+n_errors_3choice,
               n_corrects = n_corrects_1choice+n_corrects_2choice+n_corrects_3choice,
               n_misses = n_misses_1choice+n_misses_2choice+n_misses_3choice,
               across(where(is.numeric), \(x) round(x, digits=5)),
               EducTertiles = ntile(NpsEducYears, 3),
               EducTertiles = if_else(EducTertiles == 1, 'First', if_else(EducTertiles == 2, 'Second', 'Third')),
               CogCompTertiles = ntile(CognitiveComposite, 3),
               CogCompTertiles = if_else(CogCompTertiles == 1, 'First', if_else(CogCompTertiles == 2, 'Second', 'Third')),
               CogCompTertiles_raw = ntile(CognitiveComposite_raw, 3),
               CogCompTertiles_raw = if_else(CogCompTertiles_raw == 1, 'First', if_else(CogCompTertiles_raw == 2, 'Second', 'Third'))) %>%
        select(-starts_with(c('response_time','error_rate','correct_rate', 'miss_rate')))

```

# Demographics

NOTE: Demographics are not correct unless you turn Exclusion > Accuracy to eval=FALSE.
However, nothing below the demographics will be correct unless eval=TRUE.

```{r echo=FALSE, warning=FALSE}

demographics_table <- function(dat){
        tab_demo <- dat %>%
                group_by(ParticipantType) %>%
                summarise(across(where(is.numeric), list(mean=mean,sd=sd), .names = "{.col}.{.fn}", na.rm=TRUE),
                          N = n(),
                          Sex_Male=sum(Gender=='Male', na.rm=TRUE), 
                          Sex_Fem=sum(Gender=='Female', na.rm=TRUE),
                          Sex_PropMale=mean(Gender=='Male', na.rm=TRUE), 
                          Sex_PropFem=mean(Gender=='Female', na.rm=TRUE),
                          PrefHand_R=sum(PrefHand=='Right', na.rm=TRUE), 
                          PrefHand_L=sum(PrefHand=='Left', na.rm=TRUE),
                          PrefHand_PropR=mean(PrefHand=='Right', na.rm=TRUE),
                          PrefHand_PropL=mean(PrefHand=='Left', na.rm=TRUE),
                          RespHand_R=sum(RespondingHand=='Right', na.rm=TRUE), 
                          RespHand_L=sum(RespondingHand=='Left', na.rm=TRUE),
                          RespHand_PropR=mean(RespondingHand=='Right', na.rm=TRUE), 
                          RespHand_PropL=mean(RespondingHand=='Left', na.rm=TRUE),
                          RespHandDom_Y=sum(RespHandIsDominant==1, na.rm=TRUE), 
                          RespHandDom_N=sum(RespHandIsDominant==0, na.rm=TRUE),
                          RespHandDom_PropY=mean(RespHandIsDominant==1, na.rm=TRUE), 
                          RespHandDom_PropN=mean(RespHandIsDominant==0, na.rm=TRUE),
                          MostAffSide_R=sum(MostAffSide=='Right', na.rm=TRUE),
                          MostAffSide_L=sum(MostAffSide=='Left', na.rm=TRUE),
                          MostAffSide_PropR=mean(MostAffSide=='Right', na.rm=TRUE),
                          MostAffSide_PropL=mean(MostAffSide=='Left', na.rm=TRUE),
                          MedUser=sum(ParkinMedUser=='Yes', na.rm=TRUE), 
                          NonMedUser=sum(ParkinMedUser=='No', na.rm=TRUE),
                          PropMedUser=mean(ParkinMedUser=='Yes', na.rm=TRUE), 
                          PropNonMedUser=mean(ParkinMedUser=='No', na.rm=TRUE),
                          HnY_1=sum(Up3OfHoeYah==1, na.rm=TRUE), 
                          HnY_2=sum(Up3OfHoeYah==2, na.rm=TRUE),
                          HnY_3=sum(Up3OfHoeYah==3, na.rm=TRUE), 
                          HnY_4=sum(Up3OfHoeYah==4, na.rm=TRUE),
                          HnY_Prop1=mean(Up3OfHoeYah==1, na.rm=TRUE), 
                          HnY_Prop2=mean(Up3OfHoeYah==2, na.rm=TRUE),
                          HnY_Prop3=mean(Up3OfHoeYah==3, na.rm=TRUE), 
                          HnY_Prop4=mean(Up3OfHoeYah==4, na.rm=TRUE),
                          Diagnosis_PD=sum(DiagParkCertain=='PD', na.rm=TRUE), 
                          Diagnosis_Doubt=sum(DiagParkCertain=='DoubtAboutPD', na.rm=TRUE),
                          Diagnosis_PropPD=mean(DiagParkCertain=='PD', na.rm=TRUE), 
                          Diagnosis_PropDoubt=mean(DiagParkCertain=='DoubtAboutPD', na.rm=TRUE)) %>%
                mutate(across(where(is.double), round, digits=2))
        
        # Format table to show values in mean (sd) for each variable in vars1
        format_cell1 <- function(table,var){
                t2 <- table %>%
                        select(starts_with(var)) %>%
                        mutate('{var}' := paste(.[[1]], ' (',.[[2]], ')', sep='')) %>%
                        select(all_of(var))
                table <- table %>%
                        select(!contains(var))
                table <- cbind(table, t2)
                table
        }
        vars1 <- c('Age', 'NpsEducYears', 'MonthSinceDiag', 'LEDD', 'Up3OfHoeYah', 
                   'Up3OfTotal', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfCompositeTremorSum', 
                   'Up3OnTotal', 'Up3OnBradySum', 'Up3OnRigiditySum', 'Up3OnPIGDSum', 'Up3OnCompositeTremorSum', 
                   'MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum')
        for(v in vars1){
                tab_demo <- format_cell1(tab_demo, v)
        }
        # Format table to show count (proportion) for each variable in vars2
        format_cell2 <- function(table,var,var1,var2){
                t2 <- table %>%
                        select(any_of(c(var1, var2))) %>%
                        mutate('{var}' := paste(.[[var1]], ':',.[[var2]], sep='')) %>%
                        select(all_of(var))
                table <- table %>%
                        select(!any_of(c(var1, var2)))
                table <- cbind(table, t2)
                table
        }
        var1 <- c('Sex_Male', 'Sex_PropMale', 'PrefHand_R', 'PrefHand_PropR', 'RespHand_R', 'RespHand_PropR', 'RespHandDom_Y', 'RespHandDom_PropY', 'MostAffSide_R', 'MostAffSide_PropR', 'MedUser', 'PropMedUser', 'Diagnosis_PD', 'Diagnosis_PropPD')
        var2 <- c('Sex_Fem', 'Sex_PropFem', 'PrefHand_L', 'PrefHand_PropL', 'RespHand_L', 'RespHand_PropL', 'RespHandDom_N', 'RespHandDom_PropN', 'MostAffSide_L', 'MostAffSide_PropL', 'NonMedUser', 'PropNonMedUser', 'Diagnosis_Doubt', 'Diagnosis_PropDoubt')
        var <- c('Sex_MF', 'Sex_Prop_MF', 'PrefHand_RL', 'PrefHand_PropRL', 'RespHand_RL', 'RespHand_PropRL', 'RespHandDom_YN', 'RespHandDom_PropYN', 'MostAffSide_RL', 'MostAffSide_PropRL', 'Meduser_YN', 'Meduser_Prop_YN', 'Diagnosis_PDDoubt', 'Diagnosis_PropPDDoubt')
        for(v in 1:length(var)){
                tab_demo <- format_cell2(tab_demo, var[v], var1[v], var2[v])
        }
        
        tab_demo <- bind_cols(Vars = colnames(tab_demo), t(tab_demo), .name_repair = 'universal')
        # colnames(tab_demo) <- c('Variable', 'Healthy', 'PD-Off', 'PD-On')
        
        kbl(tab_demo, caption = 'Demographics') %>%
                kable_paper('hover', full_width = F)
}
compare_demographics <- function(dat,numvars,catvars){
        
        cat('\n\n\n', '#####################################', '\n')
        
        for(v in numvars){
                f <- paste(v, '~ ParticipantType')
                G1 <- dat %>% filter(ParticipantType==groups[1]) %>% select(all_of(v)) %>% na.omit()
                G2 <- dat %>% filter(ParticipantType==groups[2]) %>% select(all_of(v)) %>% na.omit()
                t <- t.test(G1,G2,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: G1-G2 = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
        }
        for(v in catvars){
                dat1 <- dat %>%
                        select(ParticipantType, any_of(v)) %>%
                        mutate(across(where(is.character),as.factor))
                c <- chisq.test(table(dat1), simulate.p.value = TRUE, B = 5000)
                msg <- paste(v,
                             ', X2 = ', round(c$statistic, digits=2),
                             ', p-val = ', round(c$p.value, digits=3),
                             sep='')
                cat('\n', msg, '\n')
                # table(dat) %>% print()
        }
        cat('\n', '#####################################', '\n\n\n')
}
compare_demographics.subs <- function(dat,numvars,catvars){
        
        cat('\n', '#####################################', '\n')
        
        for(v in numvars){
                f <- paste(v, '~ ParticipantType')
                
                G1 <- dat %>% filter(ParticipantType==groups[1]) %>% select(all_of(v)) %>% na.omit()
                G2 <- dat %>% filter(ParticipantType==groups[2]) %>% select(all_of(v)) %>% na.omit()
                G3 <- dat %>% filter(ParticipantType==groups[3]) %>% select(all_of(v)) %>% na.omit()
                t <- t.test(G1,G2,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: MMP-IM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
                t <- t.test(G1,G3,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: MMP-DM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
                t <- t.test(G2,G3,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: IM-DM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
        }
        for(v in catvars){
                dat1 <- dat %>%
                        select(ParticipantType, any_of(v)) %>%
                        mutate(across(where(is.character),as.factor))
                c <- chisq.test(table(dat1), simulate.p.value = TRUE, B = 5000)
                msg <- paste(v,
                             ', X2 = ', round(c$statistic, digits=2),
                             ', p-val = ', round(c$p.value, digits=3),
                             sep='')
                cat('\n', msg, '\n')
                # table(dat) %>% print()
        }
        cat('\n', '#####################################', '\n\n\n')
}

```

## ON vs HC

```{r echo=FALSE, warning=FALSE}
# df_demo <- df %>% 
#         filter(TimepointNr==0,
#                ParticipantType=='HC_PIT' | ParticipantType=='PD_POM') %>%
#         group_by(pseudonym,ParticipantType) %>% 
#         summarise(across(everything(), ~first(.x))) %>%
#         select(pseudonym, ParticipantType, CrossStudyParticipation, Subtype,
#                Age, Gender, NpsEducYears, PrefHand, RespondingHand, RespHandIsDominant, MonthSinceDiag,
#                ParkinMedUser, LEDD, Up3OfHoeYah, MostAffSide,
#                Up3OfTotal, Up3OfBradySum, Up3OfRigiditySum, Up3OfPIGDSum, Up3OfCompositeTremorSum, 
#                MoCASum, BDI2Sum, STAITraitSum, STAIStateSum, QUIPicdSum, DiagParkCertain) %>%
#         arrange(pseudonym,ParticipantType) %>%
#         ungroup()

dependent <- 'ParticipantType'
exploratory <- c('Age', 'Gender', 'NpsEducYears','MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum',
                 'PrefHand', 'RespondingHand', 'RespHandIsDominant','MonthSinceDiag',
                 'ParkinMedUser', 'LEDD', 'Up3OfHoeYah', 'MostAffSide', 'Up2Total','PASE','CognitiveComposite',
                 'Up3OfTotal', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfPIGDSum_Up3Only', 'Up3OfCompositeTremorSum',
                 'Up3OnTotal', 'Up3OnBradySum', 'Up3OnRigiditySum', 'Up3OnPIGDSum', 'Up3OnPIGDSum_Up3Only', 'Up3OnCompositeTremorSum')
df %>% 
        filter(ParticipantType=='HC_PIT' | ParticipantType=='PD_POM') %>%
        group_by(pseudonym,ParticipantType) %>% 
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        mutate(ParticipantType=droplevels(ParticipantType)) %>%
        summary_factorlist(dependent, 
                           exploratory[1:11],
                           add_dependent_label=TRUE,
                           p = TRUE, 
                           p_cont_para = 't.test',
                           p_cat = 'chisq',
                           na_include = TRUE) %>%
        kable(., 'pipe', digits = 3) %>% 
        print()
df %>% 
        filter(ParticipantType=='HC_PIT' | ParticipantType=='PD_POM') %>%
        group_by(pseudonym,ParticipantType) %>% 
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        mutate(ParticipantType=droplevels(ParticipantType)) %>%
        summary_factorlist(dependent, 
                           exploratory[12:31],
                           add_dependent_label=TRUE,
                           p = FALSE, 
                           p_cont_para = 't.test',
                           p_cat = 'chisq',
                           na_include = TRUE) %>%
        kable(., 'pipe', digits = 3) %>% 
        print()

# cat('Number of patients excluded due to mis-diagnosis:', length(diag_exclusions$pseudonym))
# demographics_table(df_demo)
# 
# groups <- c('HC_PIT','PD_POM')
# demo.test <- df_demo %>% filter(ParticipantType==groups[1] | ParticipantType==groups[2]) %>%
#         mutate(ParticipantType = factor(ParticipantType))
# numvars <- c('Age', 'NpsEducYears', 'MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum')
# catvars <- c('Gender', 'PrefHand', 'RespondingHand', 'RespHandIsDominant')
# cat('Controls versus PD-On')
# compare_demographics(demo.test,numvars,catvars)

```

## ON vs OFF (assessors)

This section tests the convergence between POM and PIT assessors

```{r echo=FALSE, warning=FALSE}

# Note: One PD_PIT subject lacks PD_POM clinical data, that's why 
# There's 55 patients in the table above, and 54 in the table below

# df_demo.onoff <- df %>% 
#         filter(TimepointNr==0,
#                CrossStudyParticipation==TRUE | pseudonym == 'sub-POMU667093BC227A6F9F') %>%
#         group_by(pseudonym,ParticipantType) %>% 
#         summarise(across(everything(), ~first(.x))) %>%
#         select(pseudonym, ParticipantType, CrossStudyParticipation, Subtype,
#                Age, Gender, NpsEducYears, PrefHand, RespondingHand, RespHandIsDominant, MonthSinceDiag,
#                ParkinMedUser, LEDD, Up3OfHoeYah, MostAffSide,
#                Up3OfTotal, Up3OfBradySum, Up3OfRigiditySum, Up3OfPIGDSum, Up3OfCompositeTremorSum, 
#                MoCASum, BDI2Sum, STAITraitSum, STAIStateSum, QUIPicdSum, DiagParkCertain) %>%
#         arrange(pseudonym,ParticipantType) %>%
#         ungroup()

dependent <- 'ParticipantType'
exploratory <- c('Age', 'Gender', 'NpsEducYears','ParkinMedUser','LEDD','MoCASum', 'CognitiveComposite',
                 'PrefHand', 'RespondingHand', 'RespHandIsDominant','MonthSinceDiag',
                 'Up3OfHoeYah', 'MostAffSide','Up2Total',
                 'Up3OfTotal', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfPIGDSum_Up3Only', 'Up3OfCompositeTremorSum',
                 'Up3OnTotal', 'Up3OnBradySum', 'Up3OnRigiditySum', 'Up3OnPIGDSum', 'Up3OnPIGDSum_Up3Only', 'Up3OnCompositeTremorSum')
df %>% 
        filter(CrossStudyParticipation==TRUE | pseudonym == 'sub-POMU667093BC227A6F9F') %>%
        group_by(pseudonym,ParticipantType) %>% 
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        mutate(ParticipantType=droplevels(ParticipantType)) %>%
        summary_factorlist(dependent, 
                           exploratory,
                           add_dependent_label=TRUE,
                           p = FALSE, 
                           p_cont_para = 't.test',
                           p_cat = 'chisq',
                           na_include = TRUE) %>%
        kable(., 'pipe', digits = 3) %>% 
        print()

# demographics_table(df_demo.onoff)
# 
# groups <- c('PD_PIT','PD_POM')
# demo.test <- df_demo.onoff %>% filter(ParticipantType==groups[1] | ParticipantType==groups[2]) %>%
#         mutate(ParticipantType = factor(ParticipantType))
# numvars <- c('Up3OfTotal', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfCompositeTremorSum')
# catvars <- c()
# cat('PD-Off versus PD-On')
# compare_demographics(demo.test,numvars,catvars)

```

## Subtypes

```{r echo=FALSE, warning=FALSE}

# df_demo.subs <- df %>% 
#         filter(TimepointNr==0,
#                ParticipantType=='PD_POM') %>%
#         mutate(ParticipantType=factor(Subtype)) %>%
#         group_by(pseudonym,ParticipantType) %>% 
#         summarise(across(everything(), ~first(.x))) %>%
#         select(pseudonym, ParticipantType, CrossStudyParticipation,
#                Age, Gender, NpsEducYears, PrefHand, RespondingHand, RespHandIsDominant, MonthSinceDiag,
#                ParkinMedUser, LEDD, Up3OfHoeYah, MostAffSide,
#                Up3OfTotal, Up3OfBradySum, Up3OfRigiditySum, Up3OfPIGDSum, Up3OfCompositeTremorSum, 
#                MoCASum, BDI2Sum, STAITraitSum, STAIStateSum, QUIPicdSum, DiagParkCertain
#                ) %>%
#         arrange(pseudonym,ParticipantType) %>%
#         ungroup()

dependent <- 'Subtype'
exploratory <- c('Age', 'Gender', 'NpsEducYears','MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum',
                 'PrefHand', 'RespondingHand', 'RespHandIsDominant','MonthSinceDiag',
                 'ParkinMedUser', 'LEDD', 'Up3OfHoeYah', 'MostAffSide', 'Up2Total', 'PASE','CognitiveComposite','CognitiveComposite_raw',
                 'Up3OfTotal', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfPIGDSum_Up3Only', 'Up3OfCompositeTremorSum',
                 'Up3OnTotal', 'Up3OnBradySum', 'Up3OnRigiditySum', 'Up3OnPIGDSum', 'Up3OnPIGDSum_Up3Only', 'Up3OnCompositeTremorSum')
df %>% 
        filter(ParticipantType == 'HC_PIT' | ParticipantType=='PD_POM') %>%
        group_by(pseudonym) %>% 
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        mutate(Subtype=droplevels(Subtype)) %>%
        summary_factorlist(dependent, 
                           exploratory,
                           add_dependent_label=TRUE,
                           p = FALSE, 
                           p_cont_para = 't.test',
                           p_cat = 'chisq',
                           na_include = TRUE) %>%
        kable(., 'pipe', digits = 3) %>% 
        print()

# demographics_table(df_demo.subs)

# groups <- c('1_Mild-Motor', '2_Intermediate','3_Diffuse-Malignant')
# demo.test <- df_demo.subs %>% filter(ParticipantType==groups[1] | ParticipantType==groups[2] | ParticipantType==groups[3]) %>%
#         mutate(ParticipantType = factor(ParticipantType))
# numvars <- c('Age', 'NpsEducYears', 'LEDD', 'MonthSinceDiag', 'MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum', 
#              'Up3OfTotal', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfCompositeTremorSum')
# catvars <- c('Gender', 'PrefHand', 'RespondingHand', 'RespHandIsDominant')
# cat('\n\n\n', 'Subtypes', '\n\n\n')
# compare_demographics.subs(demo.test,numvars,catvars)

```

# Effect of medication on UPDRS3

```{r echo=FALSE, warning=FALSE}

# Test in the whole POM cohort
tmp <- df %>% 
        filter(ParticipantType=='PD_POM') %>%
        group_by(pseudonym) %>% 
        select(pseudonym, Age, Gender, Up3OfTotal, Up3OfBradySum, Up3OfRigiditySum, Up3OfPIGDSum, Up3OfPIGDSum_Up3Only, Up3OfCompositeTremorSum,
               Up3OnTotal, Up3OnBradySum, Up3OnRigiditySum, Up3OnPIGDSum, Up3OnPIGDSum_Up3Only, Up3OnCompositeTremorSum) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup()
tmp <- tmp %>%
        pivot_longer(cols = starts_with('Up3'),
                     names_to = 'Var',
                     values_to = 'Val') %>%
        mutate(Medication=if_else(str_detect(Var,'Up3Of'),'OFF','ON'),
               Score=str_sub(Var,6)) %>%
        pivot_wider(id_cols = c('pseudonym', 'Age', 'Gender','Medication'),
                    names_from = Score,
                    values_from = Val) %>%
        mutate(Medication = factor(Medication)) %>% 
        na.omit()

dependent <- 'Medication'
exploratory <- c('Total', 'BradySum', 'RigiditySum', 'PIGDSum', 'PIGDSum_Up3Only', 'CompositeTremorSum')
tmp %>%
        summary_factorlist(dependent,
                           exploratory,
                           add_dependent_label=TRUE,
                           p = FALSE,
                           p_cont_para = 't.test',
                           na_include = TRUE) %>%
        kable(., 'pipe', digits = 3) %>%
        print()

m.total <- lmer(Total ~ Medication + Age + Gender + (1|pseudonym), data = tmp)
m.brady <- lmer(BradySum ~ Medication + Age + Gender + (1|pseudonym), data = tmp)
m.rig <- lmer(RigiditySum ~ Medication + Age + Gender + (1|pseudonym), data = tmp)
m.pigd <- lmer(PIGDSum ~ Medication + Age + Gender + (1|pseudonym), data = tmp)
m.trem <- lmer(CompositeTremorSum ~ Medication + Age + Gender + (1|pseudonym), data = tmp)

cat('Total\n')
summary(m.total)$coefficients
ggemmeans(m.total, terms='Medication') %>% plot(add.data=TRUE, connect.lines=TRUE)
Anova(m.total,type=3)
eta_squared(m.total, alternative = 'two.sided')

cat('Bradykinesia\n')
summary(m.brady)$coefficients
ggemmeans(m.brady, terms='Medication') %>% plot(add.data=TRUE, connect.lines=TRUE)
Anova(m.brady,type=3)
eta_squared(m.brady, alternative = 'two.sided')

cat('Rigidity\n')
summary(m.rig)$coefficients
ggemmeans(m.rig, terms='Medication') %>% plot(add.data=TRUE, connect.lines=TRUE)

cat('PIGD\n')
summary(m.pigd)$coefficients
ggemmeans(m.pigd, terms='Medication') %>% plot(add.data=TRUE, connect.lines=TRUE)

cat('Tremor\n')
summary(m.trem)$coefficients
ggemmeans(m.trem, terms='Medication') %>% plot(add.data=TRUE, connect.lines=TRUE)

# Test medication effect in the PIT cohort, but use the scores from the POM cohort
tmp <- df %>% 
        filter(CrossStudyParticipation==TRUE | pseudonym == 'sub-POMU667093BC227A6F9F',
               ParticipantType=='PD_POM') %>%
        group_by(pseudonym) %>%
        select(pseudonym, Age, Gender, Up3OfTotal, Up3OfBradySum, Up3OfRigiditySum, Up3OfPIGDSum, Up3OfPIGDSum_Up3Only, Up3OfCompositeTremorSum,
               Up3OnTotal, Up3OnBradySum, Up3OnRigiditySum, Up3OnPIGDSum, Up3OnPIGDSum_Up3Only, Up3OnCompositeTremorSum) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup()

tmp <- tmp %>%
        pivot_longer(cols = starts_with('Up3'),
                     names_to = 'Var',
                     values_to = 'Val') %>%
        mutate(Medication=if_else(str_detect(Var,'Up3Of'),'OFF','ON'),
               Score=str_sub(Var,6)) %>%
        pivot_wider(id_cols = c('pseudonym', 'Age', 'Gender','Medication'),
                    names_from = Score,
                    values_from = Val) %>%
        mutate(Medication = factor(Medication)) %>% 
        na.omit()

dependent <- 'Medication'
exploratory <- c('Total', 'BradySum', 'RigiditySum', 'PIGDSum', 'PIGDSum_Up3Only', 'CompositeTremorSum')
tmp %>%
        summary_factorlist(dependent,
                           exploratory,
                           add_dependent_label=TRUE,
                           p = FALSE,
                           p_cont_para = 't.test',
                           na_include = TRUE) %>%
        kable(., 'pipe', digits = 3) %>%
        print()
        
```


# Correlations between bradykinesia and cognitive scores

```{r echo=FALSE, message=FALSE, warning=FALSE}

df.bcor <- dfClin %>%
        filter(ParticipantType=='PD_POM',
               TimepointNr==0) %>%
        select(pseudonym, Up3OfBradySum, MoCASum, CognitiveComposite, CognitiveComposite_raw)
ggpairs(df.bcor[,2:5], progress = F, lower = list(continuous = 'smooth')) %>% print()

cor.test(df.bcor$Up3OfBradySum, df.bcor$CognitiveComposite) %>% print()

# Visualize
plotdat <- dfClin %>%
        filter(ParticipantType=='PD_POM') %>%
        group_by(pseudonym) %>%
        summarise(ParticipantType=first(ParticipantType),
                  Up3OfBradySum=first(Up3OfBradySum),
                  CognitiveComposite=first(CognitiveComposite)) %>%
        ungroup()
c <- cor.test(plotdat$Up3OfBradySum, plotdat$CognitiveComposite)
N <- plotdat  %>%
 na.omit() %>%
 nrow()
plot <- ggplot(plotdat, aes(y=CognitiveComposite, x=Up3OfBradySum)) +
        geom_point(alpha = .3, shape = 19, size = 1.5) +
        geom_smooth(method='lm', se = TRUE, lwd = 2, color='black') +
        ggtitle('Association between bradykinesia\n and cognitive performance') + 
        xlab('Bradykinesia severity') +
        ylab('Cognitive performance (z)') +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        annotate(geom='text', x=0,y=-2.5, label = paste('N = ', N, 
                                             ', Pearson\'s r = ', round(c$estimate,digits=3),
                                             ', P < 0.001', sep=''),
                  size=4, hjust=F) +
        xlim(0,45)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Corr_Brady_vs_Cog.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

```

# Relationship between clinical scores and covariates

```{r echo=FALSE, message=FALSE, warning=FALSE}

df.ccor <- df %>% 
 filter(ParticipantType=='PD_POM',
        TimepointNr==0) %>%
 group_by(pseudonym, ParticipantType) %>%
 summarise(Gender = first(Gender),
           RespHandIsDominant = first(RespHandIsDominant),
           Age = first(Age),
           NpsEducYears = first(NpsEducYears),
           Up3OfBradySum = first(Up3OfBradySum),
           CognitiveComposite = first(CognitiveComposite)) %>%
 ungroup()

ggpairs(df.ccor[,3:8], progress=F, lower = list(continuous='smooth'))

m1 <- lm(Up3OfBradySum ~ CognitiveComposite + Age + Gender + NpsEducYears + RespHandIsDominant, data = df.ccor)
s <- summary(m1)
print(s)
anova <- Anova(m1, type = 3)
print(anova)
eta_squared(m1) %>% print()

```

# Relationship between AS and MEAN RTs

```{r echo=FALSE, message=FALSE, warning=TRUE}

df.rtcor <- df.agg2 %>%
 filter(ParticipantType != 'PD_PIT') %>%
 select(pseudonym, ParticipantType, Subtype, RT_Mean, RT_2gt1, RT_3gt1, RT_23gt1)

ggpairs(df.rtcor[,4:7], progress=F, lower = list(continuous='smooth'))

```

# Response times

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_rts <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr = FALSE, digits = 3)
        anova <- Anova(fit,type=3)
        print(anova)
        eta_squared(fit, alternative = 'two.sided') %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% 
                kable(., 'pipe', digits = 3) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% 
                kable(., 'pipe', digits = 3) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        
        # Summary stats
                # emmip with plotit=FALSE gives a table of summarystats that is very handy
                # Some adjustments make it usable for the raincloudplot function below
        emm.summary <- emmip(fit, ParticipantType ~ trial_type, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        kable(emm.summary,'pipe', digits = 3) %>% print()
        
        # Plots
                # Generate rainclouds where points, boxplots and densities reflect actual data
                # Means, CIs, and lines reflect estimated marginal means
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of Parkinson\'s disease \non response times',
                              xlab='', ylab='Response time (s)',
                              xticklabs=c(paste('Control', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0.3,1.75)
        y <- 1.75
        d = 0.12
        segmap <- data.frame(
                x =    c(1.00, 1.00,  2.00,  0.85,  1.85,  0.85,  0.85,  1.85,  1.85),
                xend = c(2.00, 1.00,  2.00,  1.15,  2.15,  1.00,  1.15,  2.00,  2.15),
                y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3),
                yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3)
        )
        sigmap <- data.frame(
                x =     c(1.50,  0.92,  1.00,  1.92,  2.00),
                y =     c(y,     y-d*2, y-d*3, y-d*2, y-d*3),
                label = c('***', '***', '***', '***', '***')
        )
        plot <- plot + 
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap, 
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_HCvsON.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
        
        tplot <- emmip(fit, trial_type~ParticipantType, CIs = TRUE,
                       type='response') +
                scale_x_discrete(labels=c('Control','PD-On')) + 
                scale_colour_viridis_d(option='mako', begin = .1, end = .6,
                                       direction = -1,labels=c('One','Two','Three')) +
                ggtitle('') + ylab('Predicted response times (s)') +
                xlab('Group') + 
                guides(color=guide_legend(title='No. of choices', reverse = FALSE)) +
                theme_cowplot(font_size = 20)
        print(tplot)
        
        # Diagnostics
        plot(fit) %>% print()
        # qqmath(fit) %>% print()
        qqmath(ranef(fit)) %>% print()
        
}

f <- 'log(response_time) ~ 1 + ParticipantType*trial_type + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(trial_type != 'Catch',
               ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age, Gender, NpsEducYears, RespHandIsDominant, response_time) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T))
# Collapse across blocks for visualization purposes
tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(response_time), ~ mean(.x, na.rm=TRUE)))
compare_rts(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed)

```

## ON, RTs ~ Bradykinesia

```{r echo = FALSE, warning = TRUE}

f.clincorr <- 'log(response_time) ~ 1 + Up3OfBradySum_Dmean*trial_type + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'
tmp.clincorr <- df %>%
       filter(trial_type != 'Catch',
              ParticipantType == 'PD_POM') %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age, Gender, NpsEducYears, RespHandIsDominant, response_time, Up3OfBradySum) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               Up3OfBradySum_Dmean = Up3OfBradySum-mean(Up3OfBradySum,na.rm=T))
fit.clincorr <- lmer(f.clincorr, tmp.clincorr, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
s <- summary(fit.clincorr)
# print(s, corr=FALSE, digits = 3)
anova <- Anova(fit.clincorr,type=3)
print(anova)
eta_squared(fit.clincorr, alternative = 'two.sided') %>% print()

# Post hoc test
emt <- emtrends(fit.clincorr, ~trial_type, var='Up3OfBradySum_Dmean', type = 'response')
contrast(emt, 'revpairwise', adjust = 'mvt') %>% kable(., 'pipe', digits = 4) %>% print()
contrast(emt, 'identity', adjust = 'mvt') %>% kable(., 'pipe', digits = 4) %>% print()
emtc <- summary(emt)$Up3OfBradySum_Dmean.trend %>% mean()

em <- emmeans(fit.clincorr, revpairwise ~ trial_type, type='response', adjust='mvt')
kable(em$emmeans,'pipe', digits = 3) %>% print()
kable(em$contrasts,'pipe', digits = 3) %>% print()
emmip(fit.clincorr, ~ trial_type, type='response', CIs=TRUE) %>% print()

# Visualize
plotdat <- tmp.clincorr %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(response_time, Up3OfBradySum), ~ mean(.x, na.rm=TRUE))) %>%
        ungroup()
c <- plotdat %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(response_time, Up3OfBradySum), ~ mean(., na.rm=TRUE))) %>%
        select(pseudonym, response_time, Up3OfBradySum)
c <- cor.test(c$response_time, c$Up3OfBradySum)
N <- tmp.clincorr  %>% 
 select(pseudonym, ParticipantType, response_time, Up3OfBradySum) %>%
 group_by(pseudonym, ParticipantType) %>%
 summarise(across(everything(), ~first(.x))) %>%
 na.omit() %>%
 ungroup() %>%
 select(ParticipantType) %>%
 table()
plot <- ggplot(plotdat, aes(y=response_time, x=Up3OfBradySum, color=trial_type)) +
        geom_point(alpha = .3, shape = 19, size = 1.5) +
        geom_smooth(method='lm', se = TRUE, lwd = 2) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8,
                              direction = -1, labels = c('One','Two','Three')) +
        ggtitle('Association between response \ntimes and bradykinesia') + 
        xlab('Bradykinesia severity') +
        ylab('Response time (s)') +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        guides(color=guide_legend(title='', reverse = FALSE,
                                 title.position = 'left', label.position = 'right')) +
        theme(legend.position = legend_position,
              legend.key.size = unit(0.5,'cm')) +
        annotate(geom='text', x=0,y=1.6, label = paste('N = ', N, 
                                             ',  = ', round(s$coefficients[2,1],digits=3),
                                             ', SE = ', round(s$coefficients[2,2],digits=3),
                                             ', P < 0.001', sep=''),
                  size=4, hjust=F) +
        xlim(0,45) +
        scale_y_continuous(limits = c(0.5,1.75), breaks = seq(0.5,1.5, by=0.5))
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_Corr_Brady_ON_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

```

## ON, RTs ~ Cognitive function

```{r echo = FALSE, warning = TRUE}
# Cognitive composite
f.clincorr <- 'log(response_time) ~ 1 + CognitiveComposite_Dmean*trial_type + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'
tmp.clincorr <- df %>%
       filter(trial_type != 'Catch',
              ParticipantType == 'PD_POM') %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age, Gender, NpsEducYears, RespHandIsDominant, response_time, CognitiveComposite) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               CognitiveComposite_Dmean = CognitiveComposite-mean(CognitiveComposite,na.rm=T))
fit.clincorr <- lmer(f.clincorr, tmp.clincorr, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
s <- summary(fit.clincorr)
# print(s, corr=FALSE, digits = 3)
anova <- Anova(fit.clincorr,type=3)
print(anova)
eta_squared(fit.clincorr, alternative = 'two.sided') %>% print()

# Post hoc test
emt <- emtrends(fit.clincorr, ~trial_type, var='CognitiveComposite_Dmean', type = 'response')
contrast(emt, 'revpairwise', adjust = 'mvt') %>% kable(., 'pipe', digits = 4) %>% print()
contrast(emt, 'identity', adjust = 'mvt') %>% kable(., 'pipe', digits = 4) %>% print()
emtc <- summary(emt)$CognitiveComposite_Dmean %>% mean()

em <- emmeans(fit.clincorr, revpairwise ~ trial_type, type='response', adjust='mvt')
kable(em$emmeans,'pipe', digits = 3) %>% print()
kable(em$contrasts,'pipe', digits = 3) %>% print()
emmip(fit.clincorr, ~ trial_type, type='response', CIs=TRUE) %>% print()

# Visualize
plotdat <- tmp.clincorr %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(response_time, CognitiveComposite), ~ mean(.x, na.rm=TRUE))) %>%
        ungroup()
c <- plotdat %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(response_time, CognitiveComposite), ~ mean(., na.rm=TRUE))) %>%
        select(pseudonym, response_time, CognitiveComposite)
c <- cor.test(c$response_time, c$CognitiveComposite)
N <- tmp.clincorr  %>% 
        group_by(pseudonym, ParticipantType) %>%
 select(pseudonym, ParticipantType, response_time, CognitiveComposite) %>%
        summarise(across(everything(), ~first(.x))) %>%
        na.omit() %>%
        ungroup() %>%
        select(ParticipantType) %>%
        table()
plot <- ggplot(plotdat, aes(y=response_time, x=CognitiveComposite, color=trial_type)) +
        geom_point(alpha = .3, shape = 19, size = 1.5) +
        geom_smooth(method='lm', se = TRUE, linewidth = 2) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8,
                              direction = -1, labels = c('One','Two','Three')) +
        ggtitle('Association between response \ntimes and cognitive performance') + 
        xlab('Cognitive performance (z)') +
        ylab('Response time (s)') +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        guides(color=guide_legend(title='', reverse = FALSE,
                                 title.position = 'left', label.position = 'right')) +
        theme(legend.position = legend_position,
              legend.key.size = unit(0.5,'cm')) +
        annotate(geom='text', x=-3,y=1.6, label = paste('N = ', N, 
                                             ',  = ', round(s$coefficients[2,1],digits=3),
                                             ', SE = ', round(s$coefficients[2,2],digits=3),
                                             ', P < 0.001', sep=''),
                  size=4, hjust=F) +
        xlim(-3,2) +
        scale_y_continuous(limits = c(0.5,1.75), breaks = seq(0.5,1.5, by=0.5))
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_Corr_CogComp_ON_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
```


<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- compare_rts <- function(f, tmp, tmp.collapsed){ -->

<!--         # Fit model -->

<!--         print(paste('Fitting the following model:', f, sep=' ')) -->

<!--         fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->

<!--         s <- summary(fit) -->

<!--         print(s, corr = FALSE, digits = 3) -->

<!--         cat('\n \n Anova: ') -->

<!--         anova <- anova(fit) -->

<!--         print(anova) -->

<!--         cat('\n \n') -->

<!--         effectsize(anova) %>% print() -->

<!--         # Post hoc test -->

<!--                 # Interaction -->

<!--         cat('\n \n Post hoc tests of interaction ParticipantType x trial_type \n') -->

<!--         em <- emmeans(fit, ~ ParticipantType | trial_type) -->

<!--         print(em) -->

<!--         contrast(em, interaction = c(ParticipantType = 'revpairwise', trial_type='revpairwise'), -->

<!--                  by=NULL, adjust = 'mvt', type='response') %>% print() # by=NULL overrides the grouping of em -->

<!--         # interaction specifies the contrasts that are defined and how they are presented -->

<!--                 # Main effects -->

<!--         cat('\n \n Post hoc tests of main effect ParticipantType \n') -->

<!--         emmeans(fit, pairwise ~ ParticipantType|trial_type, type = 'response', adjust = 'mvt')$contrast %>% print() -->

<!--         cat('\n \n Post hoc tests of main effect trial_type \n') -->

<!--         emmeans(fit, pairwise ~ trial_type|ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print() -->

<!--         # Visualization -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R') -->

<!--                 # emmip with plotit=FALSE gives a table of summarystats that is very handy -->

<!--                 # Some adjustments make it usable for the raincloudplot function below -->

<!--         emm.summary <- emmip(fit, ParticipantType ~ trial_type, plotit = FALSE, type = 'response') %>% -->

<!--                 tibble() %>% -->

<!--                 rename(mean = yvar, -->

<!--                        se = SE) %>% -->

<!--                 select(-c(df, tvar, xvar)) %>% -->

<!--                 mutate(ci = se*1.96) -->

<!--                 # Generate rainclouds where points, boxplots and densities reflect actual data -->

<!--                 # Means, CIs, and lines reflect estimated marginal means -->

<!--         cat('\n \n Summary statistics \n') -->

<!--         raincloudplot_2Factor(data=tmp.collapsed, y='response_time', -->

<!--                               groupvar=c('trial_type','ParticipantType'), -->

<!--                               title='', xlab='Group', ylab='Response time (s)', -->

<!--                               xticklabs=c('Healthy','PD-Off'), legend_title = 'No. of choices', -->

<!--                               legend_labels = c('One','Two','Three'), -->

<!--                               provided_summary = 'None') %>% print() -->

<!--         tplot <- emmip(fit, trial_type~ParticipantType, CIs = TRUE, -->

<!--                        type='response') + -->

<!--                 scale_x_discrete(labels=c('Healthy','PD-Off')) +  -->

<!--                 scale_colour_viridis_d(option='mako', begin = .1, end = .6, -->

<!--                                        direction = -1,labels=c('One','Two','Three')) + -->

<!--                 ggtitle('') + ylab('Predicted response times (s)') + -->

<!--                 xlab('Group') +  -->

<!--                 guides(color=guide_legend(title='No. of choices', reverse = FALSE)) + -->

<!--                 theme_cowplot(font_size = 20) -->

<!--         print(tplot) -->

<!--         plot(fit) %>% print() -->

<!--         qqmath(fit) %>% print() -->

<!--         qqmath(ranef(fit)) -->

<!-- } -->

<!-- f <- 'log(response_time) ~ 1 + ParticipantType*trial_type*block + Age_Dmean + Gender + (1+trial_type+block|pseudonym)' -->

<!-- # removed due to non-significance -->

<!-- groups <- c('PD_PIT','HC_PIT') -->

<!-- tmp <- df %>% -->

<!--         filter(event_type == 'response') %>% -->

<!--         filter(trial_type != 'Catch') %>% -->

<!--         filter(response_time > 0.3) %>% -->

<!--         filter(correct_response=='Hit') %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(ParticipantType %in% groups) %>% -->

<!--         mutate(ParticipantType = droplevels(ParticipantType), -->

<!--                trial_type = droplevels(trial_type)) -->

<!-- tmp.collapsed <- tmp %>%  -->

<!--         group_by(pseudonym, ParticipantType, trial_type) %>% -->

<!--         summarise(across(c(response_time), ~ mean(.x))) -->

<!-- compare_rts(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed) -->

<!-- ``` -->

## ON vs. OFF

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_rts_for_medication <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr=FALSE, digits = 3)
        anova <- Anova(fit,type=3)
        print(anova)
        eta_squared(fit, alternative = 'two.sided') %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()

        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        
        # Summary stats
        emm.summary <- emmip(fit, ParticipantType ~ trial_type, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        kable(emm.summary,'pipe', digits = 3) %>% print()
        
        # Plots
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time',
                                      groupvar=c('trial_type','ParticipantType'),
                                      title='Influence of medication on \nresponse times',
                                      xlab='', ylab='Response time (s)',
                                      xticklabs=c(paste('PD-Off', ' (n=', N[1],')', sep=''),
                                                  paste('PD-On', ' (n=', N[2],')', sep='')), 
                                      legend_title = '',
                                      legend_position = legend_position,
                                      legend_labels = c('One', 'Two', 'Three'),
                                      provided_summary = 'None') +
                ylim(0.3,1.75)
        y <- 1.75
        d = 0.12
        segmap <- data.frame(
                x =    c(0.85,  0.85,  1.85,  1.85),
                xend = c(1.00,  1.15,  2.00,  2.15),
                y =    c(y-d*2, y-d*3, y-d*2, y-d*3),
                yend = c(y-d*2, y-d*3, y-d*2, y-d*3)
        )
        sigmap <- data.frame(
                x =     c(0.92,  1.00,  1.92,  2.00),
                y =     c(y-d*2, y-d*3, y-d*2, y-d*3),
                label = c('***', '***', '***', '***')
        )
        plot <- plot + 
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap, 
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_ONvsOff.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

        # Diagnostics
        plot(fit) %>% print()
        # qqmath(fit) %>% print()
        qqmath(ranef(fit))
        
}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               CrossStudyParticipation == T) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(pseudonym=first(pseudonym),
                  response_time=mean(response_time)) %>%
        na.omit() %>%
        ungroup() %>%
        select(pseudonym)
OnAndOff <- ids[duplicated(ids),]

f <- 'log(response_time) ~ 1 + ParticipantType*trial_type + block + Age + Gender + NpsEducYears + (1|pseudonym)'

groups <- c('PD_PIT','PD_POM')
tmp <- df %>%
    filter(trial_type != 'Catch',
           pseudonym %in% OnAndOff$pseudonym,
           ParticipantType %in% groups) %>%
    select(pseudonym, ParticipantType, trial_type, block, 
           Age, Gender, NpsEducYears, response_time) %>%
    mutate(ParticipantType = droplevels(ParticipantType),
           trial_type = droplevels(trial_type))

covars <- tmp %>%
    filter(ParticipantType=='PD_POM') %>%
    select(pseudonym, Age, Gender, NpsEducYears) %>%
    mutate(Gender = as.numeric(Gender)) %>%
    group_by(pseudonym) %>%
    summarise(across(c(NpsEducYears,Age, Gender), ~ mean(.x, na.rm=TRUE)))
tmp <- tmp %>%
    select(-c(Age, Gender, NpsEducYears)) %>%
    left_join(., covars, by = 'pseudonym') %>%
    mutate(Age=Age-mean(Age,na.rm=T),
           NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T))
tmp.collapsed <- tmp %>% 
    group_by(pseudonym, ParticipantType, trial_type) %>%
    summarise(response_time = mean(response_time,na.rm=T)) %>%
    ungroup()
compare_rts_for_medication(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed)

```

## Subtypes vs subtypes

```{r echo=FALSE, message=FALSE}

compare_rts_for_subtypes <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr=FALSE, digits = 3)
        anova <- Anova(fit,type=3)
        print(anova)
        eta_squared(fit, alternative = 'two.sided') %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        
        # Summary
        emm.summary <- emmip(fit, ParticipantType ~ trial_type, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        kable(emm.summary,'pipe', digits = 3) %>% print()
        
        # Plots
        # N <- tmp.collapsed %>%
        #         ungroup() %>%
        #         filter(trial_type == '1choice',
        #                block == '1') %>%
        #         select(ParticipantType) %>%
        #         table()
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time',
                                      groupvar=c('trial_type','ParticipantType'),
                                      title='Influence of subtypes on \nresponse times',
                                      xlab='', ylab='Response time (s)',
                                      xticklabs=c(paste('MMP', ' (n=', N[1],')', sep=''),
                                                  paste('IM', ' (n=', N[2],')', sep=''),
                                                  paste('DM', ' (n=', N[3],')', sep='')), 
                                      legend_title = '',
                                      legend_position = legend_position,
                                      legend_labels = c('One', 'Two', 'Three'),
                                      provided_summary = 'None') +
                ylim(0.3,1.8)
        y <- 1.75
        d = 0.12
        segmap <- data.frame(
                x =    c(1.00, 1.00,  2.00,  0.85,  1.85,  0.85,  1.15,  1.85,  2.15,  0.85,  0.85,  1.85,  1.85,  2.85,  2.85),
                xend = c(2.00, 1.00,  2.00,  1.15,  2.15,  0.85,  1.15,  1.85,  2.15,  1.00,  1.15,  2.00,  2.15,  3.00,  3.15),
                y =    c(y,    y,     y,     y-1*d, y-1*d, y-1*d, y-1*d, y-1*d, y-1*d, y-d*3, y-d*4, y-d*3, y-d*4, y-d*3, y-d*4),
                yend = c(y,    y-1*d, y-1*d, y-1*d, y-1*d, y-2*d, y-2*d, y-2*d, y-2*d, y-d*3, y-d*4, y-d*3, y-d*4, y-d*3, y-d*4)
        )
        sigmap <- data.frame(
                x =     c(1.5, 0.92,  1.00,  1.92,  2.00,  2.92,  3.00),
                y =     c(y,   y-d*3, y-d*4, y-d*3, y-d*4, y-d*3, y-d*4),
                label = c('*', '***', '***', '***', '***', '***', '***')
        )
        plot <- plot +
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap,
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize) #+
            # geom_segment(mapping = aes(x=2,xend=3,y=y,yend=y), lwd=lsize, linetype=2) +
            # geom_segment(mapping = aes(x=3,xend=3,y=y,yend=y-1*d), lwd=lsize, linetype=2) +
            # geom_segment(mapping = aes(x=2.8,xend=3.2,y=y-1*d,yend=y-1*d), lwd=lsize, linetype=2) +
            # geom_segment(mapping = aes(x=2.8,xend=2.8,y=y-1*d,yend=y-2*d), lwd=lsize, linetype=2) +
            # geom_segment(mapping = aes(x=3.2,xend=3.2,y=y-1*d,yend=y-2*d), lwd=lsize, linetype=2) +
            # annotate(x=2.5,y=1.8,geom='text',label='+', size = sigsize-4)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_Subtypes.tiff',
                  plot, dpi=300, device='tiff', base_width = 5)
        
        # Diagnostics
        plot(fit) %>% print()
        # qqmath(fit) %>% print()
        qqmath(ranef(fit))
        
}

f <- 'log(response_time) ~ 1 + ParticipantType*trial_type + block + Age + Gender + NpsEducYears + (1|pseudonym)'

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(trial_type != 'Catch',
               ParticipantType=='PD_POM' | ParticipantType == 'HC_PIT',
               Subtype %in% groups) %>%
        select(pseudonym, ParticipantType, Subtype, trial_type, block, 
               Age, Gender, NpsEducYears, PASE, response_time) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               ParticipantType=factor(Subtype,
                                      levels = c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('MMP', 'IM', 'DM')))

tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(response_time = mean(response_time,na.rm=T))
tmp.for.struc <- tmp.collapsed
compare_rts_for_subtypes(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed)

```

## Subtypes vs HC: Post hoc follow-up on the subtype x choice interaction

```{r echo=FALSE, warning=FALSE, eval=FALSE}

compare_rts_for_hcsubtypes <- function(f, tmp){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr=FALSE, digits = 3)
        anova <- Anova(fit,type=3)
        print(anova)
        eta_squared(fit, alternative = 'two.sided') %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        
        # Summary
        emm.summary <- emmip(fit, trial_type ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        kable(emm.summary,'pipe', digits = 3) %>% print()
        
        # Plots
        # N <- tmp  %>% 
        #         group_by(pseudonym, ParticipantType) %>%
        #         summarise(across(everything(), ~first(.x))) %>%
        #         na.omit() %>%
        #         ungroup() %>%
        #         select(ParticipantType) %>%
        #         table()
        # plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time',
        #                               groupvar=c('trial_type','ParticipantType'),
        #                               title='Influence of subtypes on \nresponse times',
        #                               xlab='', ylab='Response time (s)',
        #                               xticklabs=c(paste('MMP', ' (n=', N[1],')', sep=''),
        #                                           paste('IM', ' (n=', N[2],')', sep=''),
        #                                           paste('DM', ' (n=', N[3],')', sep='')), 
        #                               legend_title = '',
        #                               legend_position = legend_position,
        #                               legend_labels = c('One', 'Two', 'Three'),
        #                               provided_summary = 'None') +
        #         ylim(0.3,1.75)
        # y <- 1.75
        # d = 0.12
        # segmap <- data.frame(
        #         x =    c(1.00, 1.00,  2.00,  0.80,  1.80,  0.80,  1.20,  1.80,  2.20,  0.80,  0.80,  1.80,  1.80,  2.80,  2.80),
        #         xend = c(2.00, 1.00,  2.00,  1.20,  2.20,  0.80,  1.20,  1.80,  2.20,  1.00,  1.20,  2.00,  2.20,  3.00,  3.20),
        #         y =    c(y,    y,     y,     y-1*d, y-1*d, y-1*d, y-1*d, y-1*d, y-1*d, y-d*3, y-d*4, y-d*3, y-d*4, y-d*3, y-d*4),
        #         yend = c(y,    y-1*d, y-1*d, y-1*d, y-1*d, y-2*d, y-2*d, y-2*d, y-2*d, y-d*3, y-d*4, y-d*3, y-d*4, y-d*3, y-d*4)
        # )
        # sigmap <- data.frame(
        #         x =     c(1.5, 0.90,  1.00,  1.90,  2.00,  2.90,  3.00),
        #         y =     c(y,   y-d*3, y-d*4, y-d*3, y-d*4, y-d*3, y-d*4),
        #         label = c('*', '***', '***', '***', '***', '***', '***')
        # )
        # plot <- plot + 
        #         geom_segment(data=segmap,
        #                      mapping = aes(x=x,xend=xend,y=y,yend=yend),
        #                      inherit.aes = FALSE,
        #                      size = lsize) +
        #         geom_text(data=sigmap, 
        #                   mapping = aes(x=x,y=y,label=label),
        #                   inherit.aes = FALSE,
        #                   size = sigsize)
        # print(plot)
        # save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_Subtypes.tiff',
        #           plot, dpi=300, device='tiff', base_width = 5)
        
        # Diagnostics
        plot(fit) %>% print()
        # qqmath(fit) %>% print()
        qqmath(ranef(fit))
        
}

f <- 'log(response_time) ~ 1 + ParticipantType*trial_type + block + Age + Gender + NpsEducYears + (1|pseudonym)'

groups <- c('0_Healthy', '1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(trial_type != 'Catch',
               ParticipantType=='PD_POM' | ParticipantType == 'HC_PIT',
               Subtype %in% groups) %>%
        select(pseudonym, ParticipantType, Subtype, trial_type, block, 
               Age, Gender, NpsEducYears, response_time) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               ParticipantType=factor(Subtype,
                                      levels = c('0_Healthy', '1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('HC', 'MMP', 'IM', 'DM')))

tmp.hcvsmmp <- tmp %>%
  filter(ParticipantType == 'HC' | ParticipantType == 'MMP') %>%
  mutate(ParticipantType = droplevels(ParticipantType))
compare_rts_for_hcsubtypes(f=f, tmp=tmp.hcvsmmp)

tmp.hcvsim <- tmp %>%
  filter(ParticipantType == 'HC' | ParticipantType == 'IM') %>%
  mutate(ParticipantType = droplevels(ParticipantType))
compare_rts_for_hcsubtypes(f=f, tmp=tmp.hcvsim)

tmp.hcvsdm <- tmp %>%
  filter(ParticipantType == 'HC' | ParticipantType == 'DM') %>%
  mutate(ParticipantType = droplevels(ParticipantType))
compare_rts_for_hcsubtypes(f=f, tmp=tmp.hcvsdm)

```

# Button selection variability

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_cov <- function(f, tmp, outlier_method = 2){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lm(f, data=tmp)
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV))
        }
        fit <- lm(f, data=tmp)
        s <- summary(fit)
        # print(s, digits=3)
        anovaOutliersRetained <- Anova(fitOutliersRetained, type = 3)
        cat('\n \n Outliers retained: ')
        kable(anovaOutliersRetained, 'pipe', digits = 3) %>% print()
        cat('\n \n Outliers removed: ')
        anova <- Anova(fit,type=3)
        kable(anova, 'pipe', digits = 3) %>% print()
        cat('\n \n')
        effectsize(anova) %>% kable(., 'pipe', digits = 3) %>% print()
        # Post hoc test
        cat('\n \n EMMs \n')
        em <- emmeans(fit, ~ ParticipantType, type = 'response')
        kable(em, 'pipe', digits = 3) %>% print()
                # Main effects
        cat('\n \n Post hoc tests of main effect ParticipantType \n')
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% kable(., 'pipe', digits = 3) %>% print()
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        g <- raincloudplot_1Factor(data=tmp, y='Button.Press.CoV', groupvar='ParticipantType',
                              title = '', ylab = 'Button press variability (cov)', xlab = '',
                              xticklabs = c(paste('Control', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')), 
                              provided_summary = 'None') +
                ylim(0,0.8)
        print(g)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/BPcov_HCvsON.tiff',
          g, dpi=300, device='tiff', base_width = 5)
        
        tplot <- emmip(fit, ~ ParticipantType, CIs = TRUE, type='response')
        tplot <- tplot + 
                theme_cowplot(font_size = 20) +
                scale_x_discrete(labels = c('Control','PD-On')) +
                ggtitle('') + 
                xlab('Group')
        print(tplot)
        
        plot(fit, which = 1) %>% print()
        plot(fit, which = 2) %>% print()
        plot(fit, which = 4) %>% print()
        
}

f <- 'log(Button.Press.CoV) ~ 1 + ParticipantType + Age + Gender + NpsEducYears + RespHandIsDominant'

groups <- c('PD_POM','HC_PIT')
tmp <- df.agg2 %>%
        filter(ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, Age, Gender, NpsEducYears, RespHandIsDominant, Button.Press.CoV) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T)) %>%
        na.omit()

compare_cov(f=f, tmp=tmp)

```

## ON, CoV ~ Bradykinesia

```{r echo=FALSE, message=FALSE, warning=TRUE}

# Bradykinesia 
f <- 'log(Button.Press.CoV) ~ 1 + Up3OfBradySum_Dmean + Age + Gender + NpsEducYears + RespHandIsDominant'

groups <- c('PD_POM')
tmp <- df.agg2 %>%
        filter(ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, Age, Gender, NpsEducYears, RespHandIsDominant, Button.Press.CoV,
               Up3OfBradySum) %>%
        mutate(Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T),
               Up3OfBradySum_Dmean = Up3OfBradySum - mean(Up3OfBradySum,na.rm=T)) %>%
        na.omit()
tmp <- tmp %>%
        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV))

fit <- lm(f, tmp)
s <- summary(fit)
# print(s, corr=FALSE, digits = 3)
anova <- Anova(fit,type=3)
kable(anova, 'pipe', digits = 3) %>% print()

c <- cor.test(tmp$Button.Press.CoV, tmp$Up3OfBradySum)
N <- tmp %>%
                select(pseudonym) %>%
                summarise(N=n())
plot <- ggplot(tmp, aes(y=Button.Press.CoV, x=Up3OfBradySum)) +
        geom_point(alpha = .3, shape = 19, size = 2) +
        geom_smooth(method='lm', se = FALSE, linewidth = 2, color = 'black') +
        ggtitle('') + 
        xlab('Bradykinesia severity') +
        ylab('Button press variability (cov)') +
        annotate(geom='text', x=0,y=0.7, label = paste('N = ', N, 
                                             ',  = ', round(s$coefficients[2,1],digits=3),
                                             ', SE = ', round(s$coefficients[2,2],digits=3),
                                             ', P = ', round(s$coefficients[2,4],digits=3), sep=''),
                  size=4, hjust=F) +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
    xlim(0,45) + ylim(0,0.8)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/BPcov_Corr_Brady_ON_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

```

## ON, CoV ~ Cognitive function

```{r echo=FALSE, message=FALSE, warning=TRUE}
# Cognitive composite
f <- 'log(Button.Press.CoV) ~ 1 + CognitiveComposite + Age + Gender + NpsEducYears + RespHandIsDominant'

groups <- c('PD_POM')
tmp <- df.agg2 %>%
        filter(ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, Age, Gender, NpsEducYears, RespHandIsDominant, Button.Press.CoV,
               CognitiveComposite) %>%
        mutate(Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T),
               CognitiveComposite_Dmean = CognitiveComposite - mean(CognitiveComposite,na.rm=T)) %>%
        na.omit()
tmp <- tmp %>%
        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV))

fit <- lm(f, tmp)
s <- summary(fit)
# print(s, corr=FALSE, digits = 3)
anova <- Anova(fit,type=3)
eta_squared(fit) %>% print()
kable(anova, 'pipe', digits = 3) %>% print()

c <- cor.test(tmp$Button.Press.CoV, tmp$CognitiveComposite)
N <- tmp %>%
                select(pseudonym) %>%
                summarise(N=n())
plot <- ggplot(tmp, aes(y=Button.Press.CoV, x=CognitiveComposite)) +
        geom_point(alpha = .3, shape = 19, size = 2) +
        geom_smooth(method='lm', se = FALSE, linewidth = 2, color = 'black') +
        ggtitle('') + 
        xlab('Cognitive performance (z)') +
        ylab('Button press variability (cov)') +
        annotate(geom='text', x=-3,y=0.7, label = paste('N = ', N, 
                                             ',  = ', round(s$coefficients[2,1],digits=3),
                                             ', SE = ', round(s$coefficients[2,2],digits=3),
                                             ', P = ', round(s$coefficients[2,4],digits=3), sep=''),
                  size=4, hjust=F) +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') + 
    xlim(-3,2) + ylim(0,0.8)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/BPcov_Corr_CogComp_ON_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
```


<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- compare_cov <- function(f, tmp, outlier_method = 2){ -->

<!--         # Fit model -->

<!--         print(paste('Fitting the following model:', f, sep=' ')) -->

<!--         fitOutliersRetained <- lm(f, data=tmp) -->

<!--         if(outlier_method == 1){ -->

<!--                 outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric() -->

<!--                 tmp <- tmp[-c(outliers),] -->

<!--         }else if(outlier_method == 2){ -->

<!--                 tmp <- tmp %>% -->

<!--                         group_by(ParticipantType) %>% -->

<!--                         filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>% -->

<!--                         ungroup() -->

<!--         } -->

<!--         fit <- lm(f, data=tmp) -->

<!--         s <- summary(fit) -->

<!--         print(s, digits=3) -->

<!--         # anovaOutliersRetained <- anova(fitOutliersRetained) -->

<!--         # cat('\n \n Outliers retained: ') -->

<!--         # print(anovaOutliersRetained) -->

<!--         cat('\n \n Outliers removed: ') -->

<!--         anova <- anova(fit) -->

<!--         print(anova) -->

<!--         cat('\n \n') -->

<!--         effectsize(anova) %>% print() -->

<!--         # Post hoc test -->

<!--         cat('\n \n EMMs \n') -->

<!--         em <- emmeans(fit, ~ ParticipantType, type = 'response') -->

<!--         print(em) -->

<!--                 # Main effects -->

<!--         cat('\n \n Post hoc tests of main effect ParticipantType \n') -->

<!--         emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print() -->

<!--         # Visualization -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R') -->

<!--         cat('\n \n Summary statistics \n') -->

<!--         emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>% -->

<!--                 tibble() %>% -->

<!--                 rename(mean = yvar, -->

<!--                        se = SE) %>% -->

<!--                 select(-c(df, tvar, xvar)) %>% -->

<!--                 mutate(ci = se*1.96) -->

<!--         raincloudplot_1Factor(data=tmp, y='Button.Press.CoV', groupvar='ParticipantType', -->

<!--                               title = '', ylab = 'Coefficient of variation', xlab = 'Group', -->

<!--                               xticklabs = c('Healthy','PD-On'), provided_summary = 'None') %>% print() -->

<!--         tplot <- emmip(fit, ~ ParticipantType, CIs = TRUE, type='response') -->

<!--         tplot <- tplot +  -->

<!--                 theme_cowplot(font_size = 20) + -->

<!--                 scale_x_discrete(labels = c('Healthy','PD-Off')) + -->

<!--                 scale_colour_viridis_d(option='viridis', begin = .1, end = .6, -->

<!--                                        direction = -1) + -->

<!--                 ggtitle('') +  -->

<!--                 xlab('Group') -->

<!--         print(tplot) -->

<!--         plot(fit, which = 1) %>% print() -->

<!--         plot(fit, which = 2) %>% print() -->

<!--         plot(fit, which = 4) %>% print() -->

<!-- } -->

<!-- f <- 'log(Button.Press.CoV) ~ 1 + ParticipantType + Age_Dmean + Gender + RespHandIsDominant' -->

<!-- # removed due to non-significance -->

<!-- groups <- c('PD_PIT','HC_PIT') -->

<!-- tmp <- df %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(ParticipantType %in% groups) %>% -->

<!--         mutate(ParticipantType = droplevels(ParticipantType)) %>% -->

<!--         group_by(pseudonym, ParticipantType) %>% -->

<!--         summarise(across(everything(), ~first(.x))) %>% -->

<!--         ungroup() -->

<!-- compare_cov(f=f, tmp=tmp) -->

<!-- ``` -->

## OFF vs. ON

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_cov_for_medication <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV))
        }
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr = FALSE, digits=3)
        anovaOutliersRetained <- Anova(fitOutliersRetained,type=3)
        cat('\n \n Outliers retained: ')
        kable(anovaOutliersRetained, 'pipe', digits = 3) %>% print()
        cat('\n \n Outliers removed: ')
        anova <- Anova(fit,type=3)
        kable(anova, 'pipe', digits = 3) %>% print()
        cat('\n \n')
        # effectsize(anova) %>% kable(., 'pipe', digits = 3) %>% print()
        # Post hoc test
        cat('\n \n EMMs \n')
        em <- emmeans(fit, ~ ParticipantType, type = 'response')
        kable(em, 'pipe', digits = 3) %>% print()
                # Main effects
        cat('\n \n Post hoc tests of main effect ParticipantType \n')
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% kable(., 'pipe', digits = 3) %>% print()
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        g <- raincloudplot_1Factor(data=tmp, y='Button.Press.CoV', groupvar='ParticipantType',
                              title = '', ylab = 'Button press variability (cov)', xlab = '',
                              xticklabs = c(paste('PD-Off', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')), provided_summary = 'None') +
                ylim(0,0.8)
        print(g)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/BPcov_ONvsOFF.tiff',
          g, dpi=300, device='tiff', base_width = 5)
        
        # tplot <- emmip(fit, ParticipantType ~ Up3OfAppendicularSum_Dmean, cov.reduce=range,
        #                CIs = TRUE, type='response', dodge=2)
        # tplot <- tplot + 
        #         theme_cowplot(font_size = 20) +
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1, labels = c('PD-Off','PD-On')) +
        #         ggtitle('') + 
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='Group', reverse = TRUE))
        # print(tplot)
        
        plot(fit) %>% print()
        
}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               CrossStudyParticipation == T) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(pseudonym=first(pseudonym),
                  Button.Press.CoV=mean(Button.Press.CoV)) %>%
        na.omit() %>%
        ungroup() %>%
        select(pseudonym)
OnAndOff <- ids[duplicated(ids),]

f <- 'log(Button.Press.CoV) ~ 1 + ParticipantType + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'
# removed due to non-significance

groups <- c('PD_POM','PD_PIT')
tmp <- df.agg2 %>%
        filter(pseudonym %in% OnAndOff$pseudonym,
               ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, Age, Gender, NpsEducYears, RespHandIsDominant, Button.Press.CoV)
covars <- tmp %>%
  filter(ParticipantType=='PD_POM') %>%
  select(pseudonym, Age, Gender, NpsEducYears, RespHandIsDominant)
tmp <- tmp %>%
        select(-c(Age, Gender, NpsEducYears, RespHandIsDominant)) %>%
        left_join(., covars, by = 'pseudonym') %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T))

compare_cov_for_medication(f=f, tmp=tmp)
```

## Subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_cov_for_subtypes <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lm(f, data=tmp)
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>%
                ungroup()
        }
        fit <- lm(f, data=tmp)
        s <- summary(fit)
        # print(s, digits=3)
        anovaOutliersRetained <- Anova(fitOutliersRetained,type=3)
        cat('\n \n Outliers retained: ')
        kable(anovaOutliersRetained, 'pipe', digits = 3) %>% print()
        cat('\n \n Outliers removed: ')
        anova <- Anova(fit,type=3)
        kable(anova, 'pipe', digits = 3) %>% print()
        cat('\n \n')
        effectsize(anova) %>% kable(., 'pipe', digits = 3) %>% print()
        # Post hoc test
        cat('\n \n EMMs \n')
        em <- emmeans(fit, ~ ParticipantType, type = 'response')
        kable(em, 'pipe', digits = 3) %>% print()
                # Main effects
        cat('\n \n Post hoc tests of main effect ParticipantType \n')
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% kable(., 'pipe', digits = 3) %>% print()
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
                # emmip with plotit=FALSE gives a table of summarystats that is very handy
                # Some adjustments make it usable for the raincloudplot function below
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        g <- raincloudplot_1Factor(data=tmp, y='Button.Press.CoV', groupvar='ParticipantType',
                              title = '', ylab = 'Button press variability (cov)', xlab = '',
                              xticklabs = c(paste('MMP', ' (n=', N[1],')', sep=''),
                                          paste('IM', ' (n=', N[2],')', sep=''),
                                          paste('DM', ' (n=', N[3],')', sep='')),
                              color_scheme='viridis', provided_summary = 'None') +
                ylim(0,0.8)
        print(g)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/BPcov_Subtypes.tiff',
          g, dpi=300, device='tiff', base_width = 5)
        
        # tplot <- emmip(fit, ParticipantType ~ Up3OfAppendicularSum_Dmean, cov.reduce=range,
        #                CIs = TRUE, dodge=2)
        # tplot <- tplot + 
        #         theme_cowplot(font_size = 20) +
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1) +
        #         ggtitle('') + 
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='Subtype', reverse = TRUE))
        # print(tplot)
        
        plot(fit, which = 1) %>% print()
        plot(fit, which = 2) %>% print()
        plot(fit, which = 4) %>% print()
        
}

f <- 'log(Button.Press.CoV) ~ 1 + ParticipantType + Age + Gender + NpsEducYears + RespHandIsDominant'
# removed due to non-significance

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df.agg2 %>%
        filter(ParticipantType=='PD_POM',
               Subtype %in% groups) %>%
        select(pseudonym, ParticipantType, Subtype, Age, Gender, NpsEducYears, RespHandIsDominant, Button.Press.CoV) %>%
        mutate(Subtype = droplevels(Subtype),
               ParticipantType=factor(Subtype,
                                      levels = c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('MMP', 'IM', 'DM')),
               Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T)) %>%
        na.omit()

compare_cov_for_subtypes(f=f, tmp=tmp)

# cat('\n\n\n\n')
# 
# groups <- c('1_Mild-Motor', '2_Intermediate')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_cov_for_subtypes(f=f, tmp=tmp)
# 
# cat('\n\n\n\n')
# 
# groups <- c('1_Mild-Motor', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_cov_for_subtypes(f=f, tmp=tmp)
# 
# cat('\n\n\n\n')
# 
# groups <- c('2_Intermediate', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_cov_for_subtypes(f=f, tmp=tmp)
```

# Switch ratio

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_switch <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lm(f, data=tmp)
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.SwitchRatio - mean(Button.Press.SwitchRatio)) < 3*sd(Button.Press.SwitchRatio)) %>%
                        ungroup()
        }
        fit <- lm(f, data=tmp)
        s <- summary(fit)
        # print(s, digits=3)
        anovaOutliersRetained <- Anova(fitOutliersRetained, type=3)
        cat('\n \n Outliers retained: ')
        kable(anovaOutliersRetained, 'pipe', digits = 3) %>% print()
        cat('\n \n Outliers removed: ')
        anova <- Anova(fit,type=3)
        kable(anova, 'pipe', digits = 3) %>% print()
        cat('\n \n')
        effectsize(anova) %>% kable(., 'pipe', digits = 3) %>% print()
        # Post hoc test
        cat('\n \n EMMs \n')
        em <- emmeans(fit, ~ ParticipantType, type = 'response')
        kable(em, 'pipe', digits = 3) %>% print()
                # Main effects
        cat('\n \n Post hoc tests of main effect ParticipantType \n')
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% kable(., 'pipe', digits = 3) %>% print()
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        g <- raincloudplot_1Factor(data=tmp, y='Button.Press.SwitchRatio', groupvar='ParticipantType',
                              title = '', ylab = 'Switch ratio', xlab = '',
                              xticklabs = c(paste('Control', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')), provided_summary = 'None') +
                ylim(0,1)
        print(g)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/BPswitch_HCvsON.tiff',
          g, dpi=300, device='tiff', base_width = 5)
        
        tplot <- emmip(fit, ~ ParticipantType, CIs = TRUE, type='response')
        tplot <- tplot + 
                theme_cowplot(font_size = 20) +
                scale_x_discrete(labels = c('Control','PD-On')) +
                ggtitle('') + 
                xlab('Group')
        print(tplot)
        
        plot(fit, which = 1) %>% print()
        plot(fit, which = 2) %>% print()
        plot(fit, which = 4) %>% print()
        
}

f <- 'log(Button.Press.SwitchRatio) ~ 1 + ParticipantType + Age + Gender + NpsEducYears + RespHandIsDominant'
# removed due to non-significance

groups <- c('PD_POM','HC_PIT')
tmp <- df.agg2 %>%
        filter(ParticipantType %in% groups,
               Button.Press.SwitchRatio > 0.001) %>%
        select(pseudonym, ParticipantType, Age, Gender, NpsEducYears, RespHandIsDominant, Button.Press.SwitchRatio) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T)) %>%
        na.omit()

compare_switch(f=f, tmp=tmp)
```

## ON, Switch ~ Bradykinesia

```{r echo=FALSE, message=FALSE, warning=TRUE}

# Bradykinesia
f <- 'log(Button.Press.SwitchRatio) ~ 1 + Up3OfBradySum_Dmean + Age + Gender + NpsEducYears + RespHandIsDominant'

groups <- c('PD_POM')
tmp <- df.agg2 %>%
        filter(ParticipantType %in% groups,
               Button.Press.SwitchRatio > 0.001) %>%
        select(pseudonym, ParticipantType, Age, Gender, NpsEducYears, RespHandIsDominant, Button.Press.SwitchRatio,
               Up3OfBradySum) %>%
        mutate(Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T),
               Up3OfBradySum_Dmean=Up3OfBradySum-mean(Up3OfBradySum,na.rm=T)) %>%
        na.omit()
tmp <- tmp %>%
  filter(abs(Button.Press.SwitchRatio - mean(Button.Press.SwitchRatio)) < 3*sd(Button.Press.SwitchRatio))
fit <- lm(f, tmp)
s <- summary(fit)
# print(s, corr=FALSE, digits = 3)
anova <- Anova(fit,type=3)
kable(anova,'pipe', digits = 3) %>% print()
eta_squared(fit) %>% print()

c <- cor.test(tmp$Button.Press.SwitchRatio, tmp$Up3OfBradySum)
N <- tmp %>%
                select(pseudonym) %>%
                summarise(N=n())

plot <- ggplot(tmp, aes(y=Button.Press.SwitchRatio, x=Up3OfBradySum)) +
        geom_point(alpha = .3, shape = 19, size = 2) +
        geom_smooth(method='lm', se = FALSE, linewidth = 2, color = 'black') +
        ggtitle('') + 
        xlab('Bradykinesia severity') +
        ylab('Switch ratio') +
        annotate(geom='text', x=0,y=1, label = paste('N = ', N, 
                                             ',  = ', round(s$coefficients[2,1],digits=3),
                                             ', SE = ', round(s$coefficients[2,2],digits=3),
                                             ', P = ', round(s$coefficients[2,4],digits=3), sep=''),
                  size=4, hjust=F) + 
        theme_sjplot2(base_size = 16, base_family = 'Calibri') + 
    xlim(0,45) + ylim(0,1)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/BPswitch_Corr_Brady_ON_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

```

## ON, Switch ~ Cognitive function

```{r echo=FALSE, message=FALSE, warning=TRUE}
# Cognitive composite
f <- 'log(Button.Press.SwitchRatio) ~ 1 + CognitiveComposite_Dmean + Age + Gender + NpsEducYears + RespHandIsDominant'

groups <- c('PD_POM')
tmp <- df.agg2 %>%
        filter(ParticipantType %in% groups,
               Button.Press.SwitchRatio > 0.001) %>%
        select(pseudonym, ParticipantType, Age, Gender, NpsEducYears, RespHandIsDominant, Button.Press.SwitchRatio,
               CognitiveComposite) %>%
        mutate(Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T),
               CognitiveComposite_Dmean=CognitiveComposite-mean(CognitiveComposite,na.rm=T)) %>%
        na.omit()
tmp <- tmp %>%
  filter(abs(Button.Press.SwitchRatio - mean(Button.Press.SwitchRatio)) < 3*sd(Button.Press.SwitchRatio))
fit <- lm(f, tmp)
s <- summary(fit)
# print(s, corr=FALSE, digits = 3)
anova <- Anova(fit,type=3)
kable(anova,'pipe', digits = 3) %>% print()
eta_squared(fit) %>% print()

c <- cor.test(tmp$Button.Press.SwitchRatio, tmp$CognitiveComposite)
N <- tmp %>%
                select(pseudonym) %>%
                summarise(N=n())

plot <- ggplot(tmp, aes(y=Button.Press.SwitchRatio, x=CognitiveComposite)) +
        geom_point(alpha = .3, shape = 19, size = 2) +
        geom_smooth(method='lm', se = FALSE, linewidth = 2, color = 'black') +
        ggtitle('') + 
        xlab('Cognitive performance (z)') +
        ylab('Switch ratio') +
        annotate(geom='text', x=-3,y=1, label = paste('N = ', N, 
                                             ',  = ', round(s$coefficients[2,1],digits=3),
                                             ', SE = ', round(s$coefficients[2,2],digits=3),
                                             ', P = ', round(s$coefficients[2,4],digits=3), sep=''),
                  size=4, hjust=F) + 
        theme_sjplot2(base_size = 16, base_family = 'Calibri') + 
    xlim(-3,2) + ylim(0,1)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/BPswitch_Corr_CogCom_ON_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
```


<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- compare_switch <- function(f, tmp, outlier_method = 2){ -->

<!--         # Fit model -->

<!--         print(paste('Fitting the following model:', f, sep=' ')) -->

<!--         fitOutliersRetained <- lm(f, data=tmp) -->

<!--         if(outlier_method == 1){ -->

<!--                 outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric() -->

<!--                 tmp <- tmp[-c(outliers),] -->

<!--         }else if(outlier_method == 2){ -->

<!--                 tmp <- tmp %>% -->

<!--                         group_by(ParticipantType) %>% -->

<!--                         filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>% -->

<!--                         ungroup() -->

<!--         } -->

<!--         fit <- lm(f, data=tmp) -->

<!--         s <- summary(fit) -->

<!--         print(s, digits=3) -->

<!--         # anovaOutliersRetained <- anova(fitOutliersRetained) -->

<!--         # cat('\n \n Outliers retained: ') -->

<!--         # print(anovaOutliersRetained) -->

<!--         cat('\n \n Outliers removed: ') -->

<!--         anova <- anova(fit) -->

<!--         print(anova) -->

<!--         cat('\n \n') -->

<!--         effectsize(anova) %>% print() -->

<!--         # Post hoc test -->

<!--         cat('\n \n EMMs \n') -->

<!--         em <- emmeans(fit, ~ ParticipantType, type = 'response') -->

<!--         print(em) -->

<!--                 # Main effects -->

<!--         cat('\n \n Post hoc tests of main effect ParticipantType \n') -->

<!--         emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print() -->

<!--         # Visualization -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R') -->

<!--         cat('\n \n Summary statistics \n') -->

<!--         emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>% -->

<!--                 tibble() %>% -->

<!--                 rename(mean = yvar, -->

<!--                        se = SE) %>% -->

<!--                 select(-c(df, tvar, xvar)) %>% -->

<!--                 mutate(ci = se*1.96) -->

<!--         raincloudplot_1Factor(data=tmp, y='Button.Press.SwitchRatio', groupvar='ParticipantType', -->

<!--                               title = '', ylab = 'Switch ratio', xlab = 'Group', -->

<!--                               xticklabs = c('Healthy','PD-On'), provided_summary = 'None') %>% print() -->

<!--         tplot <- emmip(fit, ~ ParticipantType, CIs = TRUE, type='response') -->

<!--         tplot <- tplot +  -->

<!--                 theme_cowplot(font_size = 20) + -->

<!--                 scale_x_discrete(labels = c('Healthy','PD-Off')) + -->

<!--                 ggtitle('') +  -->

<!--                 xlab('Group') -->

<!--         print(tplot) -->

<!--         plot(fit, which = 1) %>% print() -->

<!--         plot(fit, which = 2) %>% print() -->

<!--         plot(fit, which = 4) %>% print() -->

<!-- } -->

<!-- f <- 'log(Button.Press.SwitchRatio) ~ 1 + ParticipantType + Age_Dmean + Gender + RespHandIsDominant' -->

<!-- # removed due to non-significance -->

<!-- groups <- c('PD_PIT','HC_PIT') -->

<!-- tmp <- df %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(ParticipantType %in% groups) %>% -->

<!--         mutate(ParticipantType = droplevels(ParticipantType)) %>% -->

<!--         group_by(pseudonym, ParticipantType) %>% -->

<!--         summarise(across(everything(), ~first(.x))) %>% -->

<!--         ungroup() -->

<!-- compare_switch(f=f, tmp=tmp) -->

<!-- ``` -->

## OFF vs. ON

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_switch_repeated <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa',
                                                                       optCtrl=list(maxfun=2e5)))
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.SwitchRatio - mean(Button.Press.SwitchRatio)) < 3*sd(Button.Press.SwitchRatio))
        }
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr = FALSE, digits=3)
        anovaOutliersRetained <- Anova(fitOutliersRetained,type=3)
        cat('\n \n Outliers retained: ')
        kable(anovaOutliersRetained, 'pipe', digits = 3) %>% print()
        cat('\n \n Outliers removed: ')
        anova <- Anova(fit,type=3)
        kable(anova, 'pipe', digits = 3) %>% print()
        cat('\n \n')
        # effectsize(anova) %>% kable(., 'pipe', digits = 3) %>% print()
        # Post hoc test
        cat('\n \n EMMs \n')
        em <- emmeans(fit, ~ ParticipantType, type = 'response')
        kable(em, 'pipe', digits = 3) %>% print()
                # Main effects
        cat('\n \n Post hoc tests of main effect ParticipantType \n')
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% kable(., 'pipe', digits = 3) %>% print()
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        g <- raincloudplot_1Factor(data=tmp, y='Button.Press.SwitchRatio', groupvar='ParticipantType',
                              title = '', ylab = 'Switch ratio', xlab = '',
                              xticklabs = c(paste('PD-Off', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')), provided_summary = 'None') +
                ylim(0,1)
        print(g)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/BPswitch_ONvsOFF.tiff',
          g, dpi=300, device='tiff', base_width = 5)
        
        # tplot <- emmip(fit, ParticipantType~Up3OfAppendicularSum, CIs = TRUE,
        #                type='response', cov.reduce=range, dodge=2) +
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1, labels = c('PD-Off','PD-On')) +
        #         ggtitle('') + ylab('Predicted switch ratio') +
        #         xlab('Bradykinesia-rigidity severity') + 
        #         guides(color=guide_legend(title='Group', reverse = FALSE)) +
        #         theme_cowplot(font_size = 20)
        # print(tplot)
        
        # g <- ggplot(tmp, aes(y=Button.Press.SwitchRatio, x=Up3OfAppendicularSum, color = ParticipantType, group = ParticipantType)) +
        #         geom_point(alpha = .3, shape = 19, size = 2) +
        #         geom_smooth(method='lm', se = FALSE, lwd = 2) +
        #         scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
        #                                direction = -1, labels = c('PD-Off','PD-On')) +
        #         ggtitle('') + xlab('MDS-UPDRS III (bradykineisa + rigidity)') + ylab('Switch ratio') + 
        #         guides(color=guide_legend(title='Group', reverse = FALSE)) + 
        #         theme_cowplot(font_size = 20)
        # print(g)
        # 
        # dOff <- tmp %>% filter(ParticipantType=='PD_PIT')
        # cOff <- cor.test(dOff$Button.Press.SwitchRatio, dOff$Up3OfAppendicularSum)
        # dOn <- tmp %>% filter(ParticipantType=='PD_POM')
        # cOn <- cor.test(dOn$Button.Press.SwitchRatio, dOn$Up3OfAppendicularSum)
        # 
        # N <- tmp %>%
        #         select(pseudonym) %>%
        #         unique() %>%
        #         nrow()
        # 
        # plot <- ggplot(tmp, aes(y=Button.Press.SwitchRatio, x=Up3OfAppendicularSum, 
        #                             color = ParticipantType)) +
        #         geom_point(alpha = .3, shape = 19, size = 2, show.legend = FALSE) +
        #         geom_smooth(method='lm', se = FALSE, lwd = 2) +
        #         scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
        #                                direction = -1,
        #                                labels = c(paste('PD-Off', ' (n=', N[1],')',
        #                                                 ', r=', round(cOff$estimate,digits=3), sep=''),
        #                                   paste('PD-On', ' (n=', N[1],')',
        #                                                 ', r=', round(cOn$estimate,digits=3), sep=''))) +
        #         ggtitle('Influence of medication on the association \nbetween switches and disease severity') +
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') + ylab('Switch ratio') + 
        #         guides(color=guide_legend(title='', reverse = FALSE)) + 
        #         theme_cowplot(font_size = 35, font_family = 'Calibri') +
        #         theme(legend.position = c(.05,.85)) +
        #         xlim(0,50) +
        #         geom_segment(x=47,xend=47,y=0.475,yend=0.365,size=lsize) +
        #         geom_text(x=48,y=0.415,label='*',size=sigsize, show.legend = FALSE)
        #         
        # print(plot)
        # save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/ONvsOFF_Switch_Severity.tiff',
        #   plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)
        
        plot(fit) %>% print()
        
}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               CrossStudyParticipation == T) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(pseudonym=first(pseudonym),
                  Button.Press.SwitchRatio=mean(Button.Press.SwitchRatio)) %>%
        na.omit() %>%
        ungroup() %>%
        select(pseudonym)
OnAndOff <- ids[duplicated(ids),]

f <- 'log(Button.Press.SwitchRatio) ~ 1 + ParticipantType + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('PD_POM','PD_PIT')
tmp <- df.agg2 %>%
        filter(pseudonym %in% OnAndOff$pseudonym,
               ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, Age, Gender, NpsEducYears, RespHandIsDominant, Button.Press.SwitchRatio)
covars <- tmp %>%
  filter(ParticipantType=='PD_POM') %>%
  select(pseudonym, Age, Gender, NpsEducYears, RespHandIsDominant)
tmp <- tmp %>%
        select(-c(Age, Gender, NpsEducYears, RespHandIsDominant)) %>%
        left_join(., covars, by = 'pseudonym') %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T))

compare_switch_repeated(f=f, tmp=tmp)
```

## Subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_switch_for_subtypes <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lm(f, data=tmp)
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.SwitchRatio - mean(Button.Press.SwitchRatio)) < 3*sd(Button.Press.SwitchRatio)) %>%
                        ungroup()
        }
        fit <- lm(f, data=tmp)
        s <- summary(fit)
        # print(s, digits=3)
        anovaOutliersRetained <- Anova(fitOutliersRetained,type=3)
        cat('\n \n Outliers retained: ')
        kable(anovaOutliersRetained, 'pipe', digits = 3) %>% print()
        cat('\n \n Outliers removed: ')
        anova <- Anova(fit,type=3)
        kable(anova, 'pipe', digits = 3) %>% print()
        cat('\n \n')
        effectsize(anova) %>% kable(., 'pipe', digits = 3) %>% print()
        # Post hoc test
        cat('\n \n EMMs \n')
        em <- emmeans(fit, ~ ParticipantType, type = 'response')
        kable(em, 'pipe', digits = 3) %>% print()
                # Main effects
        cat('\n \n Post hoc tests of main effect ParticipantType \n')
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% kable(., 'pipe', digits = 3) %>% print()
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        g <- raincloudplot_1Factor(data=tmp, y='Button.Press.SwitchRatio', groupvar='ParticipantType',
                              title = '', ylab = 'Switch ratio', xlab = '',
                              xticklabs = c(paste('MMP', ' (n=', N[1],')', sep=''),
                                          paste('IM', ' (n=', N[2],')', sep=''),
                                          paste('DM', ' (n=', N[3],')', sep='')),
                              color_scheme = 'viridis', provided_summary = 'None') +
                ylim(0,1)
        print(g)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/BPswitch_Subtypes.tiff',
          g, dpi=300, device='tiff', base_width = 5)
        
        # tplot <- emmip(fit, ParticipantType ~ Up3OfAppendicularSum_Dmean, cov.reduce=range,
        #                CIs = TRUE, type = 'response', dodge = 2)
        # tplot <- tplot + 
        #         theme_cowplot(font_size = 20) +
        #         
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1) +
        #         ggtitle('') + 
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='Subtype', reverse = TRUE))
        # print(tplot)
        
        plot(fit, which = 1) %>% print()
        plot(fit, which = 2) %>% print()
        plot(fit, which = 4) %>% print()
        
}

f <- 'log(Button.Press.SwitchRatio) ~ 1 + ParticipantType + Age + Gender + NpsEducYears + RespHandIsDominant'
# removed due to non-significance

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df.agg2 %>%
        filter(ParticipantType=='PD_POM',
               Subtype %in% groups,
               Button.Press.SwitchRatio > 0.001) %>%
        select(pseudonym, ParticipantType, Subtype, Age, Gender, NpsEducYears, RespHandIsDominant, Button.Press.SwitchRatio) %>%
        mutate(Subtype = droplevels(Subtype),
               ParticipantType=factor(Subtype,
                                      levels = c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('MMP', 'IM', 'DM')),
               Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T)) %>%
        na.omit()

compare_switch_for_subtypes(f=f, tmp=tmp)

# cat('\n\n\n\n')
# 
# groups <- c('1_Mild-Motor', '2_Intermediate')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_switch_for_subtypes(f=f, tmp=tmp)
# 
# cat('\n\n\n\n')
# 
# groups <- c('1_Mild-Motor', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_switch_for_subtypes(f=f, tmp=tmp)
# 
# cat('\n\n\n\n')
# 
# groups <- c('2_Intermediate', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_switch_for_subtypes(f=f, tmp=tmp)
```

# Misses

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_misses <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial, weights = weight,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, pairwise ~ trial_type, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()

        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='miss_rate',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of Parkinson\'s \ndisease on miss rates',
                              xlab='', ylab='Misses (%)',
                              xticklabs=c(paste('Control', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,60)
        y <- 60
        d = 6
        segmap <- data.frame(
                x =    c(1.00, 1.00,  2.00,  0.85,  1.85),
                xend = c(2.00, 1.00,  2.00,  1.15,  2.15),
                y =    c(y,    y,     y,     y-d*1, y-d*1),
                yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1)
        )
        sigmap <- data.frame(
                x =     c(1.50),
                y =     c(y),
                label = c('**')
        )
        plot <- plot +
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap,
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Miss_HCvsON.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
        
        # Forest plot
        plot <- plot_model(fit, vline.color = 'black',
                           title = '',
                           colors = 'bw',
                           terms = c('ParticipantTypePD_POM', 'trial_type2choice', 'trial_type3choice',
                                     'ParticipantTypePD_POM:trial_type2choice',
                                     'ParticipantTypePD_POM:trial_type3choice'),
                           axis.labels = c('PD-On > Ctrl, Three > One',
                                           'PD-On > Ctrl, Two > One',
                                           'Three > One',
                                           'Two > One',
                                           'PD-On > Ctrl'),
                           show.values = T,
                           value.offset = .3,
                   width = .2) + 
            theme_bw()
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Miss_HCvsON_fp.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

}

f <- 'miss_rate ~ 1 + ParticipantType*trial_type + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(trial_type != 'Catch',
               ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age, Gender, NpsEducYears, RespHandIsDominant, miss_rate, n_errors, n_corrects, n_misses) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               weight = n_errors + n_corrects + n_misses)
        
tmp.collapsed <- tmp %>%
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(miss_rate), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(miss_rate = miss_rate*100) %>%
        ungroup()

compare_misses(f=f, tmp=tmp, tmp.collapsed = tmp.collapsed)

```

## ON, Miss ~ Bradykinesia

```{r echo=FALSE, message=FALSE, warning=TRUE}

# Bradykinesia
f <- 'miss_rate ~ 1 + trial_type*Up3OfBradySum_Dmean + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('PD_POM')
tmp <- df %>%
        filter(trial_type != 'Catch',
               ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, trial_type, block, Up3OfBradySum,
               Age, Gender, NpsEducYears, RespHandIsDominant, miss_rate, n_errors, n_corrects, n_misses) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               weight = n_errors + n_corrects + n_misses,
               Up3OfBradySum_Dmean=Up3OfBradySum-mean(Up3OfBradySum,na.rm=T)) %>%
    na.omit()

# Fit model
print(paste('Fitting the following model:', f, sep=' '))
fit <- glmer(f, data=tmp, family = binomial, weights = weight,
             control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
s <- summary(fit)
print(s)
anova <- Anova(fit, type = 'III')
print(anova)
se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()

# Post hoc
emt <- emtrends(fit, ~ trial_type, var='Up3OfBradySum_Dmean', type = 'response')
contrast(emt, 'pairwise', adjust = 'mvt') %>% kable(., 'pipe', digits = 3) %>% print()

# Visualization
plotdat <- tmp %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(miss_rate, Up3OfBradySum), ~ mean(.x, na.rm=TRUE))) %>%
        ungroup()
c <- plotdat %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(miss_rate, Up3OfBradySum), ~ mean(., na.rm=TRUE))) %>%
        select(pseudonym, miss_rate, Up3OfBradySum)
c <- cor.test(c$miss_rate, c$Up3OfBradySum)
N <- tmp  %>% 
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        na.omit() %>%
        ungroup() %>%
        select(ParticipantType) %>%
        table()
plot <- ggplot(plotdat, aes(y=miss_rate*100, x=Up3OfBradySum, color=trial_type)) +
        geom_point(alpha = .3, shape = 19, size = 1.5) +
        geom_smooth(method='lm', se = TRUE, lwd = 2) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8,
                              direction = -1, labels = c('One','Two','Three')) +
        ggtitle('Association between miss rates \nand bradykinesia') +
        xlab('Bradykinesia severity') +
        ylab('Misses (%)') +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        guides(color=guide_legend(title='', reverse = FALSE,
                                 title.position = 'left', label.position = 'right')) +
        theme(legend.position = legend_position,
              legend.key.size = unit(0.5,'cm')) +
        geom_text(x=0,y=55, label = paste('N = ', N, 
                                             ', OR = ', round(exp(tab[4,1]),digits=3),
                                             ', SE = ', round(exp(tab[4,2]),digits=3),
                                             ', P = 0.001', sep=''),
                  size=4, inherit.aes = FALSE, hjust = F) +
        ylim(0,60) + xlim(0,45)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Miss_Corr_Brady_ON_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

# Forest plot
plot <- plot_model(fit, vline.color = 'black',
                   title = '',
                   colors = 'bw',
                   terms = c('Up3OfBradySum_Dmean',
                             'trial_type2choice:Up3OfBradySum_Dmean',
                             'trial_type3choice:Up3OfBradySum_Dmean'),
                   axis.labels = c('Bradykinesia, Three > One',
                                   'Bradykinesia, Two > One',
                                   'Bradykinesia'),
                   show.values = T,
                   value.offset = .3,
                   width = .2) + 
    theme_bw()
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Miss_Corr_Brady_ON_Severity_fp.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

```

## ON, Miss ~ Cognitive function

```{r echo=FALSE, message=FALSE, warning=TRUE}
# Cognitive function
f <- 'miss_rate ~ 1 + trial_type*CognitiveComposite_Dmean + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('PD_POM')
tmp <- df %>%
        filter(trial_type != 'Catch',
               ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, trial_type, block, CognitiveComposite,
               Age, Gender, NpsEducYears, RespHandIsDominant, miss_rate, n_errors, n_corrects, n_misses) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               weight = n_errors + n_corrects + n_misses,
               CognitiveComposite_Dmean=CognitiveComposite-mean(CognitiveComposite,na.rm=T)) %>%
    na.omit()

# Fit model
print(paste('Fitting the following model:', f, sep=' '))
fit <- glmer(f, data=tmp, family = binomial, weights = weight,
             control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
s <- summary(fit)
print(s)
anova <- Anova(fit, type = 'III')
print(anova)
se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()

# Post hoc
emt <- emtrends(fit, ~ trial_type, var='CognitiveComposite_Dmean', type = 'response')
contrast(emt, 'pairwise', adjust = 'mvt') %>% kable(., 'pipe', digits = 3) %>% print()

# Visualization
plotdat <- tmp %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(miss_rate, CognitiveComposite), ~ mean(.x, na.rm=TRUE))) %>%
        ungroup()
c <- plotdat %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(miss_rate, CognitiveComposite), ~ mean(., na.rm=TRUE))) %>%
        select(pseudonym, miss_rate, CognitiveComposite)
c <- cor.test(c$miss_rate, c$CognitiveComposite)
N <- tmp  %>% 
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        na.omit() %>%
        ungroup() %>%
        select(ParticipantType) %>%
        table()
plot <- ggplot(plotdat, aes(y=miss_rate*100, x=CognitiveComposite, color=trial_type)) +
        geom_point(alpha = .3, shape = 19, size = 1.5) +
        geom_smooth(method='lm', se = TRUE, lwd = 2) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8,
                              direction = -1, labels = c('One','Two','Three')) +
        ggtitle('Association between miss rates \nand cognitive performance') +
        xlab('Cognitive performance (z)') +
        ylab('Misses (%)') +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        guides(color=guide_legend(title='', reverse = FALSE,
                                 title.position = 'left', label.position = 'right')) +
        theme(legend.position = legend_position,
              legend.key.size = unit(0.5,'cm')) +
        geom_text(x=-3,y=55, label = paste('N = ', N, 
                                             ', OR = ', round(exp(tab[4,1]),digits=3),
                                             ', SE = ', round(exp(tab[4,2]),digits=3),
                                             ', P < 0.001', sep=''),
                  size=4, inherit.aes = FALSE, hjust = F) +
        ylim(0,60) + xlim(-3,2)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Miss_Corr_CogCom_ON_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

plot <- plot_model(fit, vline.color = 'black',
                   title = '',
                   colors = 'bw',
                   terms = c('CognitiveComposite_Dmean',
                             'trial_type2choice:CognitiveComposite_Dmean',
                             'trial_type3choice:CognitiveComposite_Dmean'),
                   axis.labels = c('Cognitive performance, Three > One',
                                   'Cognitive performance, Two > One',
                                   'Cognitive performance'),
                   show.values = T,
                   value.offset = .3,
                   width = .2) + 
    theme_bw()
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Miss_Corr_CogCom_ON_Severity_fp.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
```


## OFF vs ON

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_misses <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial, weights = weight,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, pairwise ~ trial_type, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()

        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='miss_rate',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of medication \non miss rates',
                              xlab='', ylab='Misses (%)',
                              xticklabs=c(paste('PD-Off', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,60)
        y <- 60
        d = 6
        segmap <- data.frame(
                x =    c(1.00, 1.00,  2.00,  0.85,  1.85,  0.85,  1.15,  1.85,  2.15,  0.85),
                xend = c(2.00, 1.00,  2.00,  1.15,  2.15,  0.85,  1.15,  1.85,  2.15,  1.15),
                y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*3),
                yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*2, y-d*2, y-d*3)
        )
        sigmap <- data.frame(
                x =     c(1.50,  1.00),
                y =     c(y,     y-d*3),
                label = c('*', '*')
        )
        plot <- plot +
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap,
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Miss_ONvsOFF.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
        
        # Forest plot
        plot <- plot_model(fit, vline.color = 'black',
                           title = '',
                           colors = 'bw',
                           terms = c('ParticipantTypePD_POM', 'trial_type2choice', 'trial_type3choice',
                                     'ParticipantTypePD_POM:trial_type2choice',
                                     'ParticipantTypePD_POM:trial_type3choice'),
                           axis.labels = c('PD-Off > PD-On, One > Three',
                                           'PD-Off > PD-On, One > Two',
                                           'Three > One',
                                           'Two > One',
                                           'PD-On > Ctrl'),
                           show.values = T,
                           value.offset = .3,
                   width = .2) + 
            theme_bw()
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Miss_ONvsOFF_fp.tiff',
                  plot, dpi=300, device='tiff', base_width = 5)

}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               CrossStudyParticipation == T) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(pseudonym=first(pseudonym),
                  miss_rate=mean(miss_rate)) %>%
        na.omit() %>%
        ungroup() %>%
        select(pseudonym)
OnAndOff <- ids[duplicated(ids),]

f <- 'miss_rate ~ 1 + ParticipantType*trial_type + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('PD_POM','PD_PIT')
tmp <- df %>%
        filter(trial_type != 'Catch',
               pseudonym %in% OnAndOff$pseudonym,
               ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age, Gender, NpsEducYears, RespHandIsDominant, miss_rate, n_errors, n_corrects, n_misses) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               weight = n_errors + n_corrects + n_misses)
        
tmp.collapsed <- tmp %>%
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(miss_rate), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(miss_rate = miss_rate*100) %>%
        ungroup()
covars <- tmp %>%
  filter(ParticipantType=='PD_POM') %>%
  group_by(pseudonym) %>%
  summarise(Age=first(Age), 
            Gender=first(Gender), 
            NpsEducYears=first(NpsEducYears),
            RespHandIsDominant=first(RespHandIsDominant))
tmp <- tmp %>%
        select(-c(Age, Gender, NpsEducYears, RespHandIsDominant)) %>%
        left_join(., covars, by = 'pseudonym') %>%
        mutate(Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T))

compare_misses(f=f, tmp=tmp, tmp.collapsed = tmp.collapsed)

```

## Subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_misses <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial, weights = weight,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, pairwise ~ trial_type, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()

        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='miss_rate',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of subtype \non miss rates',
                              xlab='', ylab='Misses (%)',
                              xticklabs=c(paste('MMP', ' (n=', N[1],')', sep=''),
                                          paste('IM', ' (n=', N[2],')', sep=''),
                                          paste('DM', ' (n=', N[3],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,60)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Miss_Subtypes.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
        
        # Forest plot
        plot <- plot_model(fit, vline.color = 'black',
                           title = '',
                           colors = 'bw',
                           terms = c('ParticipantTypeIM', 'ParticipantTypeDM', 'trial_type2choice', 'trial_type3choice',
                                     'ParticipantTypeIM:trial_type2choice',
                                     'ParticipantTypeDM:trial_type2choice',
                                     'ParticipantTypeIM:trial_type3choice',
                                     'ParticipantTypeDM:trial_type3choice'),
                           axis.labels = c('DM > MMP, Three > One',
                                           'IM > MMP, Three > One',
                                           'DM > MMP, Two > One',
                                           'IM > MMP, Two > One',
                                           'Three > One',
                                           'Two > One',
                                           'DM > MMP',
                                           'IM > MMP'),
                           show.values = T,
                           value.offset = .3,
                   width = .2) + 
            theme_bw()
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Miss_Subtypes_fp.tiff',
                  plot, dpi=300, device='tiff', base_width = 5)

}

f <- 'miss_rate ~ 1 + ParticipantType*trial_type + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(trial_type != 'Catch',
               ParticipantType=='PD_POM',
               Subtype %in% groups) %>%
        select(pseudonym, ParticipantType, Subtype, trial_type, block, 
               Age, Gender, NpsEducYears, RespHandIsDominant, miss_rate, n_errors, n_corrects, n_misses) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               weight = n_errors + n_corrects + n_misses,
               ParticipantType=factor(Subtype,
                                      levels = c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('MMP', 'IM', 'DM')))
        
tmp.collapsed <- tmp %>%
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(miss_rate), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(miss_rate = miss_rate*100) %>%
        ungroup()

compare_misses(f=f, tmp=tmp, tmp.collapsed = tmp.collapsed)

```

# Percentage correct (multiple-choice conditions)

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_correct <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial, weights = weight,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, pairwise ~ trial_type, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()

        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='error_rate',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of Parkinson\'s \ndisease on error rates',
                              xlab='', ylab='Errors (%)',
                              xticklabs=c(paste('Control', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,70)
        y <- 70
        d = 6
        segmap <- data.frame(
                x =    c(1.00, 1.00,  2.00,  0.85,  1.85,  0.85,  1.15,  1.85,  2.15,  1.85,  1.85,  2.00),
                xend = c(2.00, 1.00,  2.00,  1.15,  2.15,  0.85,  1.15,  1.85,  2.15,  2.00,  2.15,  2.15),
                y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*3, y-d*4, y-d*5),
                yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*2, y-d*2, y-d*3, y-d*4, y-d*5)
        )
        sigmap <- data.frame(
                x =     c(1.50, 1.925, 2.00,  2.075),
                y =     c(y,    y-d*3,    y-d*4, y-d*5),
                label = c('*',  '*',  '***', '***')
        )
        plot <- plot +
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap,
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_HCvsON.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
        
        # Forest plot
        plot <- plot_model(fit, vline.color = 'black',
                           title = '',
                           colors = 'bw',
                           terms = c('ParticipantTypePD_POM', 'trial_type2choice', 'trial_type3choice',
                                     'ParticipantTypePD_POM:trial_type2choice',
                                     'ParticipantTypePD_POM:trial_type3choice'),
                           axis.labels = c('Ctrl > PD-On, One > Three',
                                           'Ctrl > PD-On, One > Two',
                                           'Three > One',
                                           'Two > One',
                                           'PD-On > Ctrl'),
                           show.values = T,
                           value.offset = .3,
                   width = .2) + 
            theme_bw()
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_HCvsON_fp.tiff',
                  plot, dpi=300, device='tiff', base_width = 5)

}

f <- 'error_rate ~ 1 + ParticipantType*trial_type + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(trial_type != 'Catch',
               ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age, Gender, NpsEducYears, RespHandIsDominant, error_rate, correct_rate, n_errors, n_corrects, n_misses) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               weight = n_corrects + n_errors + n_misses)
tmp.collapsed <- tmp %>%
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(error_rate, correct_rate), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(error_rate = error_rate*100,
               correct_rate = correct_rate*100) %>%
        ungroup()

compare_correct(f=f, tmp=tmp, tmp.collapsed = tmp.collapsed)

```

## ON, Accuracy ~ Bradykinesia

```{r echo=FALSE, message=FALSE, warning=TRUE}

# Bradykinesia
f <- 'error_rate ~ 1 + trial_type*Up3OfBradySum_Dmean + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('PD_POM')
tmp <- df %>%
        filter(trial_type != 'Catch',
               ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, trial_type, block, Up3OfBradySum,
               Age, Gender, NpsEducYears, RespHandIsDominant, error_rate, n_errors, n_corrects) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               weight = n_errors + n_corrects,
               Up3OfBradySum_Dmean=Up3OfBradySum-mean(Up3OfBradySum,na.rm=T)) %>%
    na.omit()

# Fit model
print(paste('Fitting the following model:', f, sep=' '))
fit <- glmer(f, data=tmp, family = binomial, weights = weight,
             control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
s <- summary(fit)
print(s)
anova <- Anova(fit, type = 'III')
print(anova)
se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()

# Post hoc
emt <- emtrends(fit, ~ trial_type, var='Up3OfBradySum_Dmean', type = 'response')
contrast(emt, 'pairwise', adjust = 'mvt') %>% kable(., 'pipe', digits = 3) %>% print()

# Visualization
plotdat <- tmp %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(error_rate, Up3OfBradySum), ~ mean(.x, na.rm=TRUE))) %>%
        ungroup()
c <- plotdat %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(error_rate, Up3OfBradySum), ~ mean(., na.rm=TRUE))) %>%
        select(pseudonym, error_rate, Up3OfBradySum)
c <- cor.test(c$error_rate, c$Up3OfBradySum)
N <- tmp  %>% 
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        na.omit() %>%
        ungroup() %>%
        select(ParticipantType) %>%
        table()
plot <- ggplot(plotdat, aes(y=error_rate*100, x=Up3OfBradySum, color=trial_type)) +
        geom_point(alpha = .3, shape = 19, size = 1.5) +
        geom_smooth(method='lm', se = TRUE, lwd = 2) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8,
                              direction = -1, labels = c('One','Two','Three')) +
        ggtitle('Association between error rates \nand bradykinesia') +
        xlab('Bradykinesia severity') +
        ylab('Errors (%)') +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        guides(color=guide_legend(title='', reverse = FALSE,
                                 title.position = 'left', label.position = 'right')) +
        theme(legend.position = legend_position,
              legend.key.size = unit(0.5,'cm')) +
        geom_text(x=0,y=55, label = paste('N = ', N, 
                                             ', OR = ', round(exp(tab[4,1]),digits=3),
                                             ', SE = ', round(exp(tab[4,2]),digits=3),
                                             ', P < 0.001', sep=''),
                  size=4, inherit.aes = FALSE, hjust=FALSE) +
        ylim(0,70) + xlim(0,45) +
  geom_segment(x=44,xend=44,y=2,yend=10,size=lsize) +
  geom_segment(x=43,xend=44,y=2,yend=2,size=lsize) +
  geom_segment(x=43,xend=44,y=10,yend=10,size=lsize) +
  geom_text(x=46.3,y=4,label='**', size=sigsize, inherit.aes = FALSE)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_Corr_Brady_ON_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

# Forest plot
plot <- plot_model(fit, vline.color = 'black',
                   title = '',
                   colors = 'bw',
                   terms = c('Up3OfBradySum_Dmean',
                             'trial_type2choice:Up3OfBradySum_Dmean',
                             'trial_type3choice:Up3OfBradySum_Dmean'),
                   axis.labels = c('Bradykinesia x Three > One',
                                   'Bradykinesia x Two > One',
                                   'Bradykinesia'),
                   show.values = T,
                   value.offset = .3,
                   width = .2) + 
    theme_bw()
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_Corr_Brady_ON_Severity_fp.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

```

## ON, Accuracy ~ Cognitive function

```{r echo=FALSE, message=FALSE, warning=TRUE}

# Cognitive function
f <- 'error_rate ~ 1 + trial_type*CognitiveComposite_Dmean + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('PD_POM')
tmp <- df %>%
        filter(trial_type != 'Catch',
               ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, trial_type, block, CognitiveComposite,
               Age, Gender, NpsEducYears, RespHandIsDominant, error_rate, n_errors, n_corrects) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               weight = n_errors + n_corrects,
               CognitiveComposite_Dmean=CognitiveComposite-mean(CognitiveComposite,na.rm=T)) %>%
    na.omit()

# Fit model
print(paste('Fitting the following model:', f, sep=' '))
fit <- glmer(f, data=tmp, family = binomial, weights = weight,
             control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
s <- summary(fit)
print(s)
anova <- Anova(fit, type = 'III')
print(anova)
se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()

# Post hoc
emt <- emtrends(fit, ~ trial_type, var='CognitiveComposite_Dmean', type = 'response')
contrast(emt, 'pairwise', adjust = 'mvt') %>% kable(., 'pipe', digits = 3) %>% print()

# Visualization
plotdat <- tmp %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(error_rate, CognitiveComposite), ~ mean(.x, na.rm=TRUE))) %>%
        ungroup()
c <- plotdat %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(error_rate, CognitiveComposite), ~ mean(., na.rm=TRUE))) %>%
        select(pseudonym, error_rate, CognitiveComposite)
c <- cor.test(c$error_rate, c$CognitiveComposite)
N <- tmp  %>% 
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        na.omit() %>%
        ungroup() %>%
        select(ParticipantType) %>%
        table()
plot <- ggplot(plotdat, aes(y=error_rate*100, x=CognitiveComposite, color=trial_type)) +
        geom_point(alpha = .3, shape = 19, size = 1.5) +
        geom_smooth(method='lm', se = TRUE, lwd = 2) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8,
                              direction = -1, labels = c('One','Two','Three')) +
        ggtitle('Association between error rates \nand cognitive performance') +
        xlab('Cognitive performance (z)') +
        ylab('Errors (%)') +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        guides(color=guide_legend(title='', reverse = FALSE,
                                 title.position = 'left', label.position = 'right')) +
        theme(legend.position = legend_position,
              legend.key.size = unit(0.5,'cm')) +
        geom_text(x=-3,y=55, label = paste('N = ', N, 
                                             ', OR = ', round(exp(tab[4,1]),digits=3),
                                             ', SE = ', round(exp(tab[4,2]),digits=3),
                                             ', P < 0.001', sep=''),
                  size=4, inherit.aes = FALSE, hjust=FALSE) +
        ylim(0,70) + xlim(-3,2) +
  geom_segment(x=-3,xend=-3,y=5,yend=18,size=lsize) +
  geom_segment(x=-2.8,xend=-3,y=5,yend=5,size=lsize) +
  geom_segment(x=-2.8,xend=-3,y=18,yend=18,size=lsize) +
  geom_text(x=-3,y=9,label='**', size=sigsize, inherit.aes = FALSE)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_Corr_CogCom_ON_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

plot <- plot_model(fit, vline.color = 'black',
                   title = '',
                   colors = 'bw',
                   terms = c('CognitiveComposite_Dmean',
                             'trial_type2choice:CognitiveComposite_Dmean',
                             'trial_type3choice:CognitiveComposite_Dmean'),
                   axis.labels = c('Cognitive performance, Three > One',
                                   'Cognitive performance, Two > One',
                                   'Cognitive performance'),
                   show.values = T,
                   value.offset = .3,
                   width = .2) + 
    theme_bw()
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_Corr_CogCom_ON_Severity_fp.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

```


<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- compare_correct <- function(f, tmp){ -->

<!--         # Fit model -->

<!--         print(paste('Fitting the following model:', f, sep=' ')) -->

<!--         fit <- glmer(f, data=tmp, family = binomial, -->

<!--                      control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->

<!--         s <- summary(fit) -->

<!--         print(s, corr = FALSE) -->

<!--         cat('\n \n') -->

<!--         anova <- Anova(fit, type = 'III') -->

<!--         print(anova) -->

<!--         cat('\n \n Odds ratios:') -->

<!--         se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/ -->

<!--         tab <- cbind(Est = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se) -->

<!--         exp(tab) %>% print() -->

<!--         # Post hoc test -->

<!--         emm_options(lmer.df = 'satterthwaite') -->

<!--                 # Interaction -->

<!--         cat('\n \n Post hoc tests \n \n') -->

<!--         em <- emmeans(fit, ~ ParticipantType | trial_type, type = 'response') -->

<!--         print(em) -->

<!--         contrast(em, 'eff', interaction = c(ParticipantType = 'pairwise', trial_type = 'revpairwise'), -->

<!--                  by=NULL, adjust = 'mvt') %>% print() # by=NULL overrides the grouping of em -->

<!--         # interaction specifies the contrasts that are defined and how they are presented -->

<!--                 # Main effects -->

<!--         cat('\n \n Post hoc tests of main effect ParticipantType \n') -->

<!--         emmeans(fit, pairwise ~ ParticipantType|trial_type, type = 'response', adjust = 'mvt')$contrast %>% print() -->

<!--         cat('\n \n Post hoc tests of main effect trial_type \n') -->

<!--         emmeans(fit, revpairwise ~ trial_type|ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print() -->

<!--         # Visualization -->

<!--         tplot <- emmip(fit, trial_type ~ ParticipantType, type = 'response', CIs=TRUE) + -->

<!--                 scale_x_discrete(labels=c('Healthy','PD-Off')) + -->

<!--                 scale_colour_viridis_d(option='mako', begin = .1, end = .6, -->

<!--                                        direction = -1,labels=c('One','Two','Three')) + -->

<!--                 ggtitle('') + ylab('Predicted probability of correct response') + -->

<!--                 xlab('Group') + -->

<!--                 guides(color=guide_legend(title='No. of choices', reverse = FALSE)) + -->

<!--                 theme_cowplot(font_size = 20) -->

<!--         print(tplot) -->

<!--         plot(fit) %>% print() -->

<!-- } -->

<!-- f <- 'correct_response ~ 1 + ParticipantType*trial_type + block + Age_Dmean + Gender + (1|pseudonym)' -->

<!-- # removed due to non-significance -->

<!-- groups <- c('PD_PIT','HC_PIT') -->

<!-- tmp <- df %>% -->

<!--         filter(event_type == 'response') %>% -->

<!--         filter(trial_type != 'Catch') %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(ParticipantType %in% groups) %>% -->

<!--         mutate(ParticipantType = droplevels(ParticipantType), -->

<!--                trial_type = droplevels(trial_type), -->

<!--                correct_response = factor(if_else(correct_response=='Hit',1,0))) -->

<!-- compare_correct(f=f, tmp=tmp) -->

<!-- ``` -->

## ON vs. OFF

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_correct_for_medication <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial, weights = weight,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr=FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, pairwise ~ ParticipantType, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, pairwise ~ trial_type, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()

        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='error_rate',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of medication \non error rates',
                              xlab='', ylab='Errors (%)',
                              xticklabs=c(paste('PD-Off', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,70)
        y <- 70
        d = 6
        segmap <- data.frame(
                x =    c(0.80,  1.00,  1.80,  2.00),
                xend = c(1.20,  1.20,  2.20,  2.20),
                y =    c(y-d*3, y-d*4, y-d*3, y-d*4),
                yend = c(y-d*3, y-d*4, y-d*3, y-d*4)
        )
        sigmap <- data.frame(
                x =     c(1.00,  1.10,  2.00,  2.10),
                y =     c(y-d*3, y-d*4, y-d*3, y-d*4+3),
                label = c('**', '*',  '**', '+')
        )
        plot <- plot +
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap,
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = c(sigsize,sigsize,sigsize,sigsize-4))
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_ONvsOFF.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
        
                # Forest plot
        plot <- plot_model(fit, vline.color = 'black',
                           title = '',
                           colors = 'bw',
                           terms = c('ParticipantTypePD_POM', 'trial_type2choice', 'trial_type3choice',
                                     'ParticipantTypePD_POM:trial_type2choice',
                                     'ParticipantTypePD_POM:trial_type3choice'),
                           axis.labels = c('PD-On > PD-Off, Three > One',
                                           'PD-On > PD-Off, Two > One',
                                           'Three > One',
                                           'Two > One',
                                           'PD-On > Ctrl'),
                           show.values = T,
                           value.offset = .3,
                   width = .2) + 
            theme_bw()
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_ONvsOFF_fp.tiff',
                  plot, dpi=300, device='tiff', base_width = 5)

}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               CrossStudyParticipation == T) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(pseudonym=first(pseudonym),
                  error_rate=mean(error_rate)) %>%
        ungroup() %>%
        na.omit() %>%
        select(pseudonym)
OnAndOff <- ids[duplicated(ids),]

f <- 'error_rate ~ 1 + ParticipantType*trial_type + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('PD_POM','PD_PIT')
tmp <- df %>%
        filter(trial_type != 'Catch',
               pseudonym %in% OnAndOff$pseudonym,
               ParticipantType %in% groups) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age, Gender, NpsEducYears, RespHandIsDominant, error_rate, n_errors, n_corrects) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               weight = n_errors + n_corrects)
        
tmp.collapsed <- tmp %>%
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(error_rate), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(error_rate = error_rate*100) %>%
        ungroup()
covars <- tmp %>%
  filter(ParticipantType=='PD_POM') %>%
  group_by(pseudonym) %>%
  summarise(Age=first(Age), 
            Gender=first(Gender), 
            NpsEducYears=first(NpsEducYears),
            RespHandIsDominant=first(RespHandIsDominant))
tmp <- tmp %>%
        select(-c(Age, Gender, NpsEducYears, RespHandIsDominant)) %>%
        left_join(., covars, by = 'pseudonym') %>%
        mutate(Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T))

compare_correct_for_medication(f=f, tmp=tmp, tmp.collapsed = tmp.collapsed)
```

## Subtypes vs subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_correct_for_subtypes <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial, weights = weight,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 2) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, pairwise ~ trial_type, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()

        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='error_rate',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of subtypes \non error rates',
                              xlab='', ylab='Errors (%)',
                              xticklabs=c(paste('MMP', ' (n=', N[1],')', sep=''),
                                          paste('IM', ' (n=', N[2],')', sep=''),
                                          paste('DM', ' (n=', N[3],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,70)
        y <- 67
        d = 6
        segmap <- data.frame(
                x =    c(1.00, 1.00,  3.00, 0.85,  2.85,  0.85,  1.00,  1.85,  2.00,  2.85,  3.00),
                xend = c(3.00, 1.00,  3.00, 1.15,  3.15,  1.15,  1.15,  2.15,  2.15,  3.15,  3.15),
                y =    c(y,    y,     y,    y-d*1,y-d*1, y-d*2, y-d*3, y-d*2, y-d*3, y-d*2, y-d*3),
                yend = c(y,    y-d*1, y-d*1,y-d*1,y-d*1, y-d*2, y-d*3, y-d*2, y-d*3, y-d*2, y-d*3)
        )
        sigmap <- data.frame(
                x =     c(1.00,  1.075,  2.00,  2.075,  3.00,  3.075),
                y =     c(y-d*2, y-d*3, y-d*2, y-d*3, y-d*2, y-d*3),
                label = c('***', '***',  '***', '**',  '***', '**')
        )
        sigmap2 <- data.frame(
                x =     c(2.00),
                y =     c(y+2.5),
                label = c('+')
        )
        plot <- plot +
            geom_segment(data=segmap,
                         mapping = aes(x=x,xend=xend,y=y,yend=yend),
                         inherit.aes = FALSE,
                         size = lsize) +
            geom_text(data=sigmap,
                      mapping = aes(x=x,y=y,label=label),
                      inherit.aes = FALSE,
                      size = sigsize) + 
            geom_text(data=sigmap2,
                      mapping = aes(x=x,y=y,label=label),
                      inherit.aes = FALSE,
                      size = 6)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_Subtypes.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
        
        # Forest plot
        plot <- plot_model(fit, vline.color = 'black',
                           title = '',
                           colors = 'bw',
                           terms = c('ParticipantTypeIM', 'ParticipantTypeDM', 'trial_type2choice', 'trial_type3choice',
                                     'ParticipantTypeIM:trial_type2choice',
                                     'ParticipantTypeDM:trial_type2choice',
                                     'ParticipantTypeIM:trial_type3choice',
                                     'ParticipantTypeDM:trial_type3choice'),
                           axis.labels = c('MMP > DM, One > Three',
                                           'MMP > IM, One > Three',
                                           'MMP > DM, One > Two',
                                           'MMP > IM, One > Two',
                                           'Three > One',
                                           'Two > One',
                                           'DM > MMP',
                                           'IM > MMP'),
                           show.values = T,
                           value.offset = .3,
                   width = .2) + 
            theme_bw()
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Miss_Subtypes_fp.tiff',
                  plot, dpi=300, device='tiff', base_width = 5)

}

f <- 'error_rate ~ 1 + ParticipantType*trial_type + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(trial_type != 'Catch',
               ParticipantType=='PD_POM',
               Subtype %in% groups) %>%
        select(pseudonym, ParticipantType, Subtype, trial_type, block, 
               Age, Gender, NpsEducYears, RespHandIsDominant, error_rate, n_errors, n_corrects) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               weight = n_errors + n_corrects,
               ParticipantType=factor(Subtype,
                                      levels = c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('MMP', 'IM', 'DM')))
        
tmp.collapsed <- tmp %>%
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(error_rate), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(error_rate = error_rate*100) %>%
        ungroup()

compare_correct_for_subtypes(f=f, tmp=tmp, tmp.collapsed = tmp.collapsed)

```

<!-- ## Subtypes vs HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- compare_correct_for_subtypes <- function(f, tmp, tmp.collapsed){ -->

<!--         # Fit model -->

<!--         print(paste('Fitting the following model:', f, sep=' ')) -->

<!--         fit <- glmer(f, data=tmp, family = binomial, -->

<!--                      control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->

<!--         s <- summary(fit) -->

<!--         print(s, corr = FALSE) -->

<!--         cat('\n \n') -->

<!--         anova <- Anova(fit, type = 'III') -->

<!--         print(anova) -->

<!--         cat('\n \n Odds ratios:') -->

<!--         se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/ -->

<!--         tab <- cbind(Est = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se) -->

<!--         exp(tab) %>% print() -->

<!--         # Post hoc test -->

<!--         cat('\n \n Post hoc tests of interactions \n') -->

<!--         em <- emmeans(fit, ~ ParticipantType*trial_type | block, type='response') -->

<!--         contrast(em, interaction = c('pairwise','pairwise','pairwise'), adjust='mvt', type='response') %>% print() -->

<!--         emmip(fit, ParticipantType ~ trial_type | block, type='response') %>% print() -->

<!--         em1 <- emmeans(fit, ~ block|ParticipantType, type='response') -->

<!--         contrast(em1, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print() -->

<!--         emmip(fit, ParticipantType ~ block, type='response') %>% print() -->

<!--         em2 <- emmeans(fit, ~ trial_type|ParticipantType, type='response') -->

<!--         contrast(em2, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print() -->

<!--         emmip(fit, ParticipantType ~ trial_type, type='response') %>% print() -->

<!--         em3 <- emmeans(fit, ~ block|trial_type, type='response') -->

<!--         contrast(em3, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print() -->

<!--         emmip(fit, trial_type ~ block, type='response') %>% print() -->

<!--         cat('\n \n') -->

<!--         # contrast(emm, interaction = c('revpairwise','revpairwise', 'identity'), adjust = 'mvt', by = NULL) %>% print() -->

<!--         # Visualization -->

<!--         # tplot <- emmip(fit, trial_type~Up3OfAppendicularSum_Dmean|ParticipantType, CIs = TRUE, -->

<!--         #                type='response', cov.reduce=range, dodge=7) + -->

<!--         #         scale_colour_viridis_d(option='mako', begin = .1, end = .6, -->

<!--         #                                direction = -1, labels = c('One','Two', 'Three')) + -->

<!--         #         ggtitle('') + ylab('Predicted probability of correct response') + -->

<!--         #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') + -->

<!--         #         guides(color=guide_legend(title='No. of choices', reverse = FALSE)) + -->

<!--         #         theme_cowplot(font_size = 20) -->

<!--         # print(tplot) -->

<!--         N <- tmp %>% -->

<!--                 group_by(pseudonym, ParticipantType) %>% -->

<!--                 filter(trial_type == '1choice') %>% -->

<!--                 summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>% -->

<!--                 ungroup() %>% -->

<!--                 select(ParticipantType) %>% -->

<!--                 table() -->

<!--         tplot <- emmip(fit, trial_type ~ ParticipantType, -->

<!--                        type = 'response', CIs=TRUE, plotit=FALSE) %>% -->

<!--                 ggplot(aes(x=xvar,y=yvar*100, color=tvar)) + -->

<!--                 geom_point(position=position_dodge(width=0.6),size=8) + -->

<!--                 geom_errorbar(aes(ymin=LCL*100,ymax=UCL*100), lwd=2, width=0.5, -->

<!--                               position=position_dodge(width=0.6)) + -->

<!--                 scale_x_discrete(labels=c(paste('HC', ' (n=', N[1],')', sep=''), -->

<!--                                           paste('MMP', ' (n=', N[2],')', sep=''), -->

<!--                                           paste('IM', ' (n=', N[3],')', sep=''), -->

<!--                                           paste('DM', ' (n=', N[4],')', sep=''))) + -->

<!--                 scale_colour_viridis_d(option='mako', begin = .1, end = .6, -->

<!--                                        direction = -1,labels=c('One','Two','Three')) + -->

<!--                 ggtitle('Influence of subtype \non accuracy') + ylab('Correct (%)') + -->

<!--                 xlab('') + -->

<!--                 guides(color=guide_legend(title='', reverse = FALSE)) + -->

<!--                 theme_cowplot(font_size = 60, font_family = 'Calibri') + -->

<!--                 theme(legend.position = c(0.78, 1.25)) + -->

<!--                 ylim(96.5,100.5) #+ -->

<!-- # -->

<!-- #                 geom_text(x=2,y=1.0075,label='**',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=1,xend=3,y=1.007,yend=1.007,size=lsize) + -->

<!-- #                 geom_segment(x=1,xend=1,y=1.007,yend=1.006,size=lsize) + -->

<!-- #                 geom_segment(x=3,xend=3,y=1.007,yend=1.006,size=lsize) + -->

<!-- #                 geom_segment(x=0.8,xend=1.2,y=1.006,yend=1.006,size=lsize) + -->

<!-- #                 geom_segment(x=2.8,xend=3.2,y=1.006,yend=1.006,size=lsize) + -->

<!-- #                 geom_segment(x=0.8,xend=0.8,y=1.006,yend=1.005,size=lsize) + -->

<!-- #                 geom_segment(x=1.2,xend=1.2,y=1.006,yend=1.005,size=lsize) + -->

<!-- #                 geom_segment(x=2.8,xend=2.8,y=1.006,yend=1.005,size=lsize) + -->

<!-- #                 geom_segment(x=3.2,xend=3.2,y=1.006,yend=1.005,size=lsize) + -->

<!-- # -->

<!-- #                 geom_text(x=1,y=1.0045,label='***',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=0.8,xend=1.2,y=1.004,yend=1.004,size=lsize) + -->

<!-- #                 geom_text(x=1.1,y=1.0025,label='***',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=1,xend=1.2,y=1.002,yend=1.002,size=lsize) + -->

<!-- # -->

<!-- #                 geom_text(x=2,y=1.0045,label='***',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=1.8,xend=2.2,y=1.004,yend=1.004,size=lsize) + -->

<!-- #                 geom_text(x=2.1,y=1.0025,label='***',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=2,xend=2.2,y=1.002,yend=1.002,size=lsize) + -->

<!-- # -->

<!-- #                 geom_text(x=3,y=1.0045,label='***',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=2.8,xend=3.2,y=1.004,yend=1.004,size=lsize) + -->

<!-- #                 geom_text(x=3.1,y=1.0025,label='***',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=3,xend=3.2,y=1.002,yend=1.002,size=lsize) -->

<!--         print(tplot) -->

<!--         # save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_SubtypesHc.tiff', -->

<!--         #           tplot, dpi=300, device='tiff') -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R') -->

<!--         N <- tmp.collapsed %>% -->

<!--                 ungroup() %>% -->

<!--                 filter(trial_type == '1choice') %>% -->

<!--                 select(ParticipantType) %>% -->

<!--                 table() -->

<!--         plot <- raincloudplot_2Factor(data=tmp.collapsed, y='Percentage.Incorrect', -->

<!--                               groupvar=c('trial_type','ParticipantType'), -->

<!--                               title='Influence of subtypes \non accuracy', -->

<!--                               xlab='', ylab='Errors (%)', -->

<!--                               xticklabs=c(paste('HC', ' (n=', N[1],')', sep=''), -->

<!--                                           paste('MMP', ' (n=', N[2],')', sep=''), -->

<!--                                           paste('IM', ' (n=', N[3],')', sep=''), -->

<!--                                           paste('DM', ' (n=', N[4],')', sep='')), -->

<!--                               legend_title = '', -->

<!--                               legend_labels = c('One','Two','Three'), -->

<!--                               legend_position = legend_position, -->

<!--                               provided_summary = 'None') + -->

<!--                 ylim(0,70) -->

<!--         # y <- 70 -->

<!--         # d = 3 -->

<!--         # segmap <- data.frame( -->

<!--         #         x =    c(), -->

<!--         #         xend = c(), -->

<!--         #         y =    c(), -->

<!--         #         yend = c() -->

<!--         # ) -->

<!--         # sigmap <- data.frame( -->

<!--         #         x =     c(), -->

<!--         #         y =     c(), -->

<!--         #         label = c() -->

<!--         # ) -->

<!--         # plot <- plot + -->

<!--         #         geom_segment(data=segmap, -->

<!--         #                      mapping = aes(x=x,xend=xend,y=y,yend=yend), -->

<!--         #                      inherit.aes = FALSE, -->

<!--         #                      size = lsize) + -->

<!--         #         geom_text(data=sigmap, -->

<!--         #                   mapping = aes(x=x,y=y,label=label), -->

<!--         #                   inherit.aes = FALSE, -->

<!--         #                   size = sigsize) -->

<!--         print(plot) -->

<!--         save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_SubtypesHc_v2.tiff', -->

<!--           plot, dpi=300, device='tiff') -->

<!-- } -->

<!-- f <- 'correct_response ~ 1 + ParticipantType*trial_type + block + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)' -->

<!-- # Random slopes and Gender removed to solve singular fits and convergence issues -->

<!-- groups <- c('0_Healthy', '1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant') -->

<!-- tmp <- df %>% -->

<!--         filter(ParticipantType=='PD_POM' | ParticipantType == 'HC_PIT') %>% -->

<!--         filter(event_type == 'response') %>% -->

<!--         filter(trial_type != 'Catch') %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(Subtype %in% groups) %>% -->

<!--         mutate(Subtype = droplevels(Subtype), -->

<!--                trial_type = droplevels(trial_type), -->

<!--                ParticipantType=factor(Subtype), -->

<!--                correct_response = factor(if_else(correct_response=='Hit',1,0))) -->

<!-- tmp.collapsed <- tmp %>% -->

<!--         group_by(pseudonym, ParticipantType, trial_type) %>% -->

<!--         summarise(across(c(Percentage.Correct), ~ mean(.x, na.rm=TRUE))) %>% -->

<!--         mutate(Percentage.Incorrect = (1-Percentage.Correct)*100) -->

<!-- compare_correct_for_subtypes(f=f, tmp=tmp, tmp.collapsed = tmp.collapsed) -->

<!-- cat('\n\n\n\n') -->

<!-- ``` -->

# Percentage correct (catch)

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_catch_correct <- function(f, tmp){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial, weights = weight,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')
        kable(em$emmeans, 'pipe', digits = 3) %>% print()
        kable(em$contrasts, 'pipe', digits = 3) %>% print()
        
        # Visualization
        emmip(fit, ~ ParticipantType, type = 'response', CIs=TRUE) %>% print()

}

f <- 'false_alarm_rate ~ 1 + ParticipantType + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'
# Random slope of block removed due to convergence issues

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
    filter(ParticipantType %in% groups) %>%
    group_by(pseudonym,ParticipantType) %>%
    summarise(Age = first(Age),
              Gender = first(Gender),
              NpsEducYears = first(NpsEducYears),
              RespHandIsDominant = first(RespHandIsDominant),
              false_alarm_rate = first(false_alarm_rate),
              weight = 12) %>%
    mutate(ParticipantType = droplevels(ParticipantType),
               Age=Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T)) %>%
    ungroup()
compare_catch_correct(f=f, tmp=tmp)

```

<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- f <- 'correct_response ~ 1 + ParticipantType*block*Up3OfAppendicularSum_Dmean + Age_Dmean + Gender + (1|pseudonym)' -->

<!-- # Random slope of block removed due to convergence issues -->

<!-- groups <- c('PD_PIT','HC_PIT') -->

<!-- tmp <- df %>% -->

<!--         filter(event_type == 'cue') %>% -->

<!--         filter(trial_type == 'Catch') %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(ParticipantType %in% groups) %>% -->

<!--         mutate(ParticipantType = droplevels(ParticipantType), -->

<!--                trial_type = droplevels(trial_type), -->

<!--                correct_response = factor(if_else(correct_response=='False Alarm',1,0))) -->

<!-- compare_catch_correct(f=f, tmp=tmp) -->

<!-- ``` -->

## ON vs. OFF

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_catch_correct_for_medication <- function(f, tmp){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial, weights = weight,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')
        kable(em$emmeans, 'pipe', digits = 3) %>% print()
        kable(em$contrasts, 'pipe', digits = 3) %>% print()
        
        # Visualization
        emmip(fit, ~ ParticipantType, type = 'response', CIs=TRUE) %>% print()

}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               CrossStudyParticipation == T) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(pseudonym=first(pseudonym),
                  false_alarm_rate=mean(false_alarm_rate)) %>%
        na.omit() %>%
        ungroup() %>%
        select(pseudonym)
OnAndOff <- ids[duplicated(ids),]

f <- 'false_alarm_rate ~ 1 + ParticipantType + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('PD_POM','PD_PIT')
tmp <- df %>%
    filter(pseudonym %in% OnAndOff$pseudonym,
           ParticipantType %in% groups) %>%
    group_by(pseudonym, ParticipantType) %>%
    summarise(Age = first(Age),
              Gender = first(Gender),
              NpsEducYears = first(NpsEducYears),
              RespHandIsDominant = first(RespHandIsDominant),
              false_alarm_rate = first(false_alarm_rate)) %>%
    mutate(ParticipantType = droplevels(ParticipantType),
           weight = 12) %>%
    ungroup()

covars <- tmp %>%
  filter(ParticipantType=='PD_POM') %>%
  group_by(pseudonym) %>%
  summarise(Age=first(Age), 
            Gender=first(Gender), 
            NpsEducYears=first(NpsEducYears),
            RespHandIsDominant=first(RespHandIsDominant))
tmp <- tmp %>%
        select(-c(Age, Gender, NpsEducYears, RespHandIsDominant)) %>%
        left_join(., covars, by = 'pseudonym') %>%
        mutate(Age = Age-mean(Age,na.rm=T),
               NpsEducYears = NpsEducYears-mean(NpsEducYears,na.rm=T))

compare_catch_correct_for_medication(f=f, tmp=tmp)
```

## Subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_catch_correct_for_subtypes <- function(f, tmp){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial, weights = weight,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        # print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% kable(., 'pipe', digits = 3) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')
        kable(em$emmeans, 'pipe', digits = 3) %>% print()
        kable(em$contrasts, 'pipe', digits = 3) %>% print()
        
        # Visualization
        emmip(fit, ~ ParticipantType, type = 'response', CIs=TRUE) %>% print()

}

f <- 'false_alarm_rate ~ 1 + ParticipantType + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
    filter(trial_type != 'Catch',
           ParticipantType=='PD_POM',
           Subtype %in% groups) %>%
    group_by(pseudonym, Subtype) %>%
    summarise(Age = first(Age),
              Gender = first(Gender),
              NpsEducYears = first(NpsEducYears),
              RespHandIsDominant = first(RespHandIsDominant),
              false_alarm_rate = first(false_alarm_rate)) %>%
    ungroup() %>%
    mutate(Age=Age-mean(Age,na.rm=T),
           NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
           weight = 12,
           ParticipantType=factor(Subtype,
                                  levels = c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                  labels = c('MMP', 'IM', 'DM')))

```

# Brain activity

## ON vs. HC

```{r echo=FALSE, warning=FALSE, message=FALSE}

# SPM VOI eigenvariate
# fmri.onvshc <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcOn_x_ExtInt2Int3Catch_NoOutliers/'
# vois <- dir(fmri.onvshc, 'VOI.*csv', full.names = TRUE)
# MarsBar ROI betas
fmri.onvshc <- 'P:/3024006.02/Analyses/BRAIN_2023/fMRI/Group_comparisons/HcOn_x_ExtInt2Int3Catch_NoOutliers/marsbar/'
vois <- dir(fmri.onvshc, '*csv', full.names = TRUE)
regions <- c('Putamen (MAS)', 'Pre-central (4a)', 'CB (V)', 'Putamen (LAS)', 'Putamen (LAS)', 'MTG (TE1p)')

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
outliers <- c()
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                filter(Cond != 'Catch') %>%
                mutate(Group = factor(Group,
                                      levels = c('HC_PIT','PD_POM')),
                       Cond = factor(Cond,
                                     levels = c('Ext','Int2','Int3'),
                                     labels = c('1choice','2choice','3choice'))) %>%
                rename(Beta = Vals)
        
        bn <- basename(csvfile)
        fmridat.subset <- fmridat
        fmridat.subset <- fmridat.subset %>% pivot_wider(id_cols = c('pseudonym','Group'),
                                       names_from = Cond,
                                       values_from = Beta) %>%
          mutate(Avg = (`3choice` + `2choice` + `1choice`)/3,
                 IvL = `2choice` - `1choice`,
                 HvL = `3choice` - `1choice`,
                 Avg.Outlier = if_else(abs(Avg-mean(Avg)) > 3*sd(Avg), 1, 0),
                 IvL.Outlier = if_else(abs(IvL-mean(IvL)) > 3*sd(IvL), 1, 0),
                 HvL.Outlier = if_else(abs(HvL-mean(HvL)) > 3*sd(HvL), 1, 0)) %>%
          select(-c(`1choice`,`2choice`,`3choice`))
        print(bn)
        outs <- fmridat.subset %>% filter(Avg.Outlier == TRUE | IvL.Outlier == TRUE | HvL.Outlier == TRUE) 
        outs %>% kable(., 'pipe', digits = 3) %>% print()
        outliers <- c(outliers, outs$pseudonym)
        
        if(str_detect(bn, '(IntExt)')){
                fmridat <- fmridat %>%
                        group_by(pseudonym, Group) %>%
                        summarise(across(c(Beta), ~ mean(.x, na.rm=TRUE))) %>%
                        ungroup()
                raincloudplot_1Factor(fmridat, 'Beta', c('Group'), 
                                      title = str_glue(basename(csvfile),': ', regions[v]),
                                      xlab='Group', ylab='Beta', xticklabs = c('Control','PD-On'),
                                      color_scheme = 'viridis') %>% 
                        print()   
        }else{
                raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), 
                                      title = str_glue(basename(csvfile),': ', regions[v]),
                                      xlab='Group', ylab='Beta', xticklabs = c('Control','PD-On'),
                                      legend_title = 'No. of choices', legend_labels = c('One','Two','Three'),
                                      color_scheme = 'mako') %>% print()        
        }
}

##### Putamen #####
putamen <- vois[1]
csvfile <- putamen
fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Group = factor(Group,
                              levels = c('HC_PIT','PD_POM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
         rename(Beta = Vals) #%>%
        # group_by(pseudonym, Group) %>%
        # summarise(across(c(Beta), ~ mean(.x, na.rm=TRUE))) %>%
        # ungroup()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()

plot <- raincloudplot_2Factor(fmridat2, 'Beta', c('Cond','Group'), 
                              title = 'Influence of Parkinson\'s disease\non left putamen activity',
                              xlab='', ylab='Beta', 
                              xticklabs = c(paste('Control', ' (n=', N[1],')', sep=''),
                                            paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_position = legend_position, legend_labels = c('One','Two','Three'),
                              color_scheme = 'mako', cloud = T) + 
        ylim(-2.5,5)
y <- 5
d = 0.45
segmap <- data.frame(
        x =    c(1.00, 1.00, 0.85,  2.00,  1.85),
        xend = c(2.00, 1.00, 1.15,  2.00,  2.15),
        y =    c(y,    y,    y-d*1, y,     y-d*1),
        yend = c(y,    y-d*1,y-d*1, y-d*1, y-d*1)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('***')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HCvsON.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

# fmridat.c <- fmridat %>%
#         group_by(pseudonym, Group) %>%
#         summarise(across(c(Beta), ~ mean(.x, na.rm=TRUE))) %>%
#         ungroup()
# plot <- raincloudplot_1Factor(data=fmridat.c, y='Beta', groupvar='Group',
#                               title = 'Influence of Parkinson\'s disease\non putamen activity',
#                               ylab = 'Beta (mean)', xlab = '',
#                               xticklabs = c(paste('Control', ' (n=', N[1],')', sep=''),
#                                           paste('PD-On', ' (n=', N[2],')', sep='')), provided_summary = 'None')
# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HCvsON_agg.tiff',
#           plot, dpi=300, device='tiff', base_width = 4)

# # Association with response times
fmridat.rts <- fmridat %>%
  rename(trial_type=Cond,
         ParticipantType=Group)
groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type)) %>%
        select(pseudonym, ParticipantType, trial_type, block,
               Age, Gender, NpsEducYears, response_time)
tmp.collapsed <- tmp %>%
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(response_time), ~ mean(.x, na.rm=TRUE))) %>%
  ungroup()
t <- left_join(fmridat.rts, tmp.collapsed, by=c('pseudonym', 'ParticipantType','trial_type')) %>%
  pivot_wider(id_cols = c('pseudonym', 'ParticipantType'),
              names_from = trial_type,
              values_from = c(Beta,response_time)) %>%
  mutate(Beta.avg = (Beta_1choice+Beta_2choice+Beta_3choice)/3,
         RT.avg = (response_time_1choice+response_time_2choice+response_time_3choice)/3) %>%
  select(-starts_with('Beta_'),
         -starts_with('response_time'))

ggplot(t, aes(x=Beta.avg,y=RT.avg, fill=ParticipantType)) +
  geom_point() +
  geom_smooth(method='lm')

plot <- ggplot(t, aes(y=RT.avg, x=Beta.avg, color=ParticipantType)) +
        geom_point(alpha = .3, shape = 19, size = 1.5) +
        geom_smooth(method='lm', se = FALSE, lwd = 2) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8,
                              direction = -1, labels = c('Control','PD')) +
        ggtitle('Association between response \ntimes and putamen activity') +
        xlab('Average beta') +
        ylab('Average RT (s)') +
        theme_cowplot(font_size = 14, font_family = 'Calibri') +
        guides(color=guide_legend(title='', reverse = FALSE,
                                 title.position = 'left', label.position = 'right')) +
        theme(legend.position = c(0.8,1.10),
              legend.key.size = unit(0.5,'cm'))
print(plot)

m <- lm(RT.avg ~ Beta.avg*ParticipantType, data = t)
summary(m)

#####

##### MTG interaction #####
mtg <- vois[5]
csvfile <- mtg
fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Group = factor(Group,
                              levels = c('HC_PIT','PD_POM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals)
N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Influence of Parkinson\'s disease\non right TE1p activity',
                              xlab='', ylab='Beta',
                              xticklabs = c(paste('Control', ' (n=', N[1],')', sep=''),
                                            paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_position = legend_position, legend_labels = c('One','Two','Three'),
                              color_scheme = 'mako') +
        ylim(-4,5.5)
y <- 5
d = 0.6
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.85,  1.85,  0.85,  1.15, 1.85,  2.15),
        xend = c(2.00, 1.00,  2.00,  1.15,  2.15,  0.85,  1.15, 1.85,  2.15),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('*')
)
plot <- plot +
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap,
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HCvsON_MTG_interaction.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
#####

##### Putamen interaction #####
put <- vois[4]
csvfile <- put
fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Group = factor(Group,
                              levels = c('HC_PIT','PD_POM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals)
N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Influence of Parkinson\'s disease\non right putamen activity',
                              xlab='', ylab='Beta',
                              xticklabs = c(paste('Control', ' (n=', N[1],')', sep=''),
                                            paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_position = legend_position, legend_labels = c('One','Two','Three'),
                              color_scheme = 'mako') +
        ylim(-2.5,4.5)
y <- 4.5
d = 0.6
segmap <- data.frame(
        x =    c(0.925, 0.925,  1.925,  0.85,  1.85,  0.85,  1.00, 1.85,  2.00),
        xend = c(1.925, 0.925,  1.925,  1.00,  2.00,  0.85,  1.00, 1.85,  2.00),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.4),
        y =     c(y),
        label = c('*')
)
plot <- plot +
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap,
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HCvsON_PUT_interaction.tiff',
          plot, dpi=300, device='tiff', base_width = 5)
#####
```

<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, warning=FALSE, message=FALSE} -->

<!-- fmri.offvshc <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcOff_x_ExtInt2Int3Catch_NoOutliers/' -->

<!-- vois <- dir(fmri.offvshc, 'VOI.*csv', full.names = TRUE) -->

<!-- source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->

<!-- source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R') -->

<!-- for(v in 1:length(vois)){ -->

<!--         csvfile <- vois[v] -->

<!--         fmridat <- read_csv(csvfile, show_col_types = FALSE) %>% -->

<!--                 select(-scans) %>% -->

<!--                 filter(Cond != 'Catch') %>% -->

<!--                 mutate(Group = factor(Group, -->

<!--                                       levels = c('HC_PIT','PD_PIT')), -->

<!--                        Cond = factor(Cond, -->

<!--                                      levels = c('Ext','Int2','Int3'), -->

<!--                                      labels = c('1choice','2choice','3choice'))) %>% -->

<!--                 rename(Beta = Vals) -->

<!--         bn <- basename(csvfile) -->

<!--         if(str_detect(bn, 'Mean')){ -->

<!--                 fmridat <- fmridat %>% -->

<!--                         group_by(pseudonym, Group) %>% -->

<!--                         summarise(across(c(Beta), ~ mean(.x, na.rm=TRUE))) %>% -->

<!--                         ungroup() -->

<!--                 raincloudplot_1Factor(fmridat, 'Beta', c('Group'), title = basename(csvfile), -->

<!--                                       xlab='Group', ylab='Beta', xticklabs = c('Healthy','PD-On'), -->

<!--                                       color_scheme = 'viridis') %>% print()    -->

<!--         }else{ -->

<!--                 raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), title = basename(csvfile), -->

<!--                                       xlab='Group', ylab='Beta', xticklabs = c('Healthy','PD-On'), -->

<!--                                       legend_title = 'No. of choices', legend_labels = c('One','Two','Three'), -->

<!--                                       color_scheme = 'mako') %>% print()         -->

<!--         } -->

<!-- } -->

<!-- ``` -->

## Subtypes vs subtypes

```{r echo=FALSE, warning=FALSE, message=FALSE}

##### Group analysis #####
# fmri.subtypes <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Imputed_Subtypes_x_ExtInt2Int3Catch_NoOutliers/'
# vois <- dir(fmri.subtypes, 'VOI.*csv', full.names = TRUE)
fmri.subtypes <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/Subtypes_x_ExtInt2Int3Catch_NoOutliers/marsbar'
vois <- dir(fmri.subtypes, '*csv', full.names = TRUE)
regions <- c('SFG','LOC','MFG','IPL','SPL', 'Postcentral', 'Putamen')

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype)
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                filter(Cond != 'Catch',
                       Group != 'HC_PIT') %>%
                left_join(., Subtypes, by='pseudonym') %>%
                mutate(Group = Subtype,
                       Group = factor(Group,
                                      levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant')),
                       Cond = factor(Cond,
                                     levels = c('Ext','Int2','Int3'),
                                     labels = c('1choice','2choice','3choice'))) %>%
                rename(Beta = Vals)
        
        bn <- basename(csvfile)
        if(str_detect(bn, 'HC_PD')){
          fmridat.subset <- fmridat %>%
            filter(Group == '1_Mild-Motor' | Group == '2_Intermediate' | Group == '3_Diffuse-Malignant')
        }else if(str_detect(bn, 'Inter_DM')){
          fmridat.subset <- fmridat %>%
            filter(Group == '2_Intermediate' | Group == '3_Diffuse-Malignant')
        }else if(str_detect(bn, 'MMP_DM') | str_detect(bn, 'MMP_MD')){
          fmridat.subset <- fmridat %>%
            filter(Group == '1_Mild-Motor' | Group == '3_Diffuse-Malignant')
        }
        fmridat.subset <- fmridat.subset %>% pivot_wider(id_cols = c('pseudonym','Group'),
                                       names_from = Cond,
                                       values_from = Beta) %>%
          mutate(Avg = (`3choice` + `2choice` + `1choice`)/3,
                 IvL = `2choice` - `1choice`,
                 HvL = `3choice` - `1choice`,
                 Avg.Outlier = if_else(abs(Avg-mean(Avg)) > 3*sd(Avg), 1, 0),
                 IvL.Outlier = if_else(abs(IvL-mean(IvL)) > 3*sd(IvL), 1, 0),
                 HvL.Outlier = if_else(abs(HvL-mean(HvL)) > 3*sd(HvL), 1, 0)) %>%
          select(-c(`1choice`,`2choice`,`3choice`))
        print(bn)
        fmridat.subset %>% filter(Avg.Outlier == TRUE | IvL.Outlier == TRUE | HvL.Outlier == TRUE) %>% kable(., 'pipe', digits = 3) %>% print()
        
        fmridat$Subtype <- droplevels(fmridat$Subtype)
        raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Subtype'), 
                              title = str_glue(basename(csvfile),': ', regions[v]),
                      xlab='Group', ylab='Beta', xticklabs = c('MMP','IM', 'DM', 'Undefined'),
                      legend_title = 'No. of choices', legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') %>% print()
}
#####

##### Premotor cortex #####

Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype)

# MMP > DM: 3 > 1, pmc
pmc1 <- vois[3]
csvfile1 <- pmc1
fmridat1 <- read_csv(csvfile1, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()
# N1 <- fmridat1 %>%
#         filter(Cond=='1choice') %>%
#         select(Group) %>%
#         table()
# plot <- raincloudplot_2Factor(fmridat1, 'Beta', c('Cond','Group'), 
#                               title = 'Task-related activity in the \nintraparietal sulcus (hIP8)',
#                       xlab='Group', ylab='Beta', 
#                       xticklabs = c(paste('MMP', ' (n=', N1[1],')', sep=''),
#                                     paste('IM', ' (n=', N1[2],')', sep=''),
#                                     paste('DM', ' (n=', N1[3],')', sep='')),
#                       legend_title = '',
#                       legend_position = c(0.85,1.08), legend_labels = c('One','Two','Three'),
#                       color_scheme = 'mako') +
#         ylim(-6,10) +
#         geom_segment(x=1,xend=3,y=10,yend=10,size=lsize) + 
#         geom_segment(x=1,xend=1,y=10,yend=9.7,size=lsize) + 
#         geom_segment(x=3,xend=3,y=10,yend=9.7,size=lsize) +
#         geom_segment(x=0.8,xend=1.2,y=9.7,yend=9.7,size=lsize) + 
#         geom_segment(x=2.8,xend=3.2,y=9.7,yend=9.7,size=lsize) +
#         geom_segment(x=0.8,xend=0.8,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=1.2,xend=1.2,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=2.8,xend=2.8,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=3.2,xend=3.2,y=9.7,yend=9.5,size=lsize) +
#         geom_text(x=2,y=10.2,label='**',size=sigsize,show.legend = FALSE)
# print(plot)
# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/ImputedSubtypes_MMPgtDM_INT3gtEXT_IPS.tiff',
#           plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)

# IM > DM: 3 > 1, PMC
pmc2 <- vois[1]
csvfile2 <- pmc2
fmridat2 <- read_csv(csvfile2, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()
# N2 <- fmridat2 %>%
#         filter(Cond=='1choice') %>%
#         select(Group) %>%
#         table()
# plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), 
#                               title = 'Task-related activity in the \nsuperior parietal lobule (7A)',
#                       xlab='Group', ylab='Beta', 
#                       xticklabs = c(paste('MMP', ' (n=', N2[1],')', sep=''),
#                                     paste('IM', ' (n=', N2[2],')', sep=''),
#                                     paste('DM', ' (n=', N2[3],')', sep='')),
#                       legend_title = '',
#                       legend_position = c(0.85,1.08), legend_labels = c('One','Two','Three'),
#                       color_scheme = 'mako') +
#         ylim(-6,10) +
#         geom_segment(x=1,xend=3,y=10,yend=10,size=lsize) + 
#         geom_segment(x=1,xend=1,y=10,yend=9.7,size=lsize) + 
#         geom_segment(x=3,xend=3,y=10,yend=9.7,size=lsize) +
#         geom_segment(x=0.8,xend=1.2,y=9.7,yend=9.7,size=lsize) + 
#         geom_segment(x=2.8,xend=3.2,y=9.7,yend=9.7,size=lsize) +
#         geom_segment(x=0.8,xend=0.8,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=1.2,xend=1.2,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=2.8,xend=2.8,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=3.2,xend=3.2,y=9.7,yend=9.5,size=lsize) +
#         geom_text(x=2,y=10.2,label='**',size=sigsize,show.legend = FALSE)
# print(plot)
# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/ImputedSubtypes_MMPgtDM_INT3gtEXT_IPS.tiff',
#           plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)

# MMP > DM & MMP > IM: 3 gt 1, PMC
fmridat <- fmridat1 %>%
        filter(Group != 'IM') %>%
        mutate(Group=factor(Group,levels=c('MMP','DM')))
N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()

plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Influence of subtypes on \npremotor cortex activity',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('MMP', ' (n=', N[1],')', sep=''),
                                    paste('DM', ' (n=', N[2],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-2,6)

y <- 6
d = 0.35
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.85,  0.85,  1.15,  1.85,  1.85,  2.15),
        xend = c(2.00, 1.00,  2.00,  1.15,  0.85,  1.15,  2.15,  1.85,  2.15),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.5),
        y =     c(y),
        label = c('***')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Subtypes_MMPgtDM_INT3gtEXT_PMC.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

# Alternative without IM
fmridat <- bind_cols(fmridat1, Beta2=fmridat2$Beta) %>%
        mutate(AvgBeta = (Beta+Beta2)/2)
N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()

plot <- raincloudplot_2Factor(fmridat, 'AvgBeta', c('Cond','Group'),
                              title = 'Influence of subtypes on \npremotor cortex activity',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('MMP', ' (n=', N[1],')', sep=''),
                                    paste('IM', ' (n=', N[2],')', sep=''),
                                    paste('DM', ' (n=', N[3],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-1.5,6)

y <- 6
d = 0.35
segmap <- data.frame(
        x =    c(1.00, 1.00,  3.00,  0.85,  0.85,  1.15,  2.85,  2.85,  3.15,  2.00, 2.00,  3.00,  1.85,  1.85,  2.15,  2.85,  2.85,  3.15),
        xend = c(3.00, 1.00,  3.00,  1.15,  0.85,  1.15,  3.15,  2.85,  3.15,  3.00, 2.00,  3.00,  2.15,  1.85,  2.15,  3.15,  2.85,  3.15),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*3,y-d*3, y-d*3, y-d*4, y-d*4, y-d*4, y-d*4, y-d*4, y-d*4),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2, y-d*3,y-d*4, y-d*4, y-d*4, y-d*5, y-d*5, y-d*4, y-d*5, y-d*5)
)
sigmap <- data.frame(
        x =     c(2,     2.5),
        y =     c(y,     y-d*3),
        label = c('***', '*')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Subtypes_MMPgtDM&IMgtDM_INT3gtEXT_PMC.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

#####

##### Putamen cluster #####
Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype, Up3OfBradySum)

# file <- c('P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/clusterstats/x_HCgtON_Mean_Putamen1Only_con_0001_ses-Visit1.txt','P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/clusterstats/x_HCgtON_Mean_Putamen1Only_con_0002_ses-Visit1.txt','P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/clusterstats/x_HCgtON_Mean_Putamen1Only_con_0003_ses-Visit1.txt')
# 
# con1 <- read_csv(file[1])
# con2 <- read_csv(file[2])
# con3 <- read_csv(file[3])
# fmridat.putamen <- bind_rows(con1,con2,con3)
# fmridat.putamen <- fmridat.putamen %>%
#         separate(Img, into = c('x1','x2','pseudonym','session','y1','contrast'), sep = '_') %>%
#         mutate(ParticipantType = paste(x1,x2,sep='_'),
#                contrast = str_remove(contrast, 'L2Rswap'),
#                contrast = str_remove(contrast, '.nii')) %>%
#         select(-c(x1,x2,y1,session))
# fmridat.putamen <- fmridat.putamen %>%
#         filter(ParticipantType=='PD_POM')
# fmridat.putamen <- fmridat.putamen %>%
#         left_join(., Subtypes, by = 'pseudonym')
# fmridat.putamen <- fmridat.putamen %>%
#         mutate(Group = Subtype,
#                Group = factor(Group,
#                               levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant')),
#                Cond = factor(contrast,
#                                  levels = c('0001','0002','0003'),
#                                  labels = c('1choice','2choice','3choice'))) %>%
#         na.omit() %>%
#         filter(pseudonym %in% unique(fmridat.putamen$pseudonym))
# 
# fmridat.putamen.collapsed <- fmridat.putamen %>%
#         pivot_wider(id_cols = c('pseudonym','ParticipantType','Group','Up3OfAppendicularSum'),
#                     values_from = Beta,
#                     names_from = Cond) %>%
#         mutate(Mean=(`1choice`+`2choice`+`3choice`)/3)
# 
# N <- fmridat.putamen.collapsed %>%
#         select(Group) %>%
#         table()

putamen <- vois[7]
csvfile <- putamen
fmridat.putamen <- read_csv(csvfile, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()

N <- fmridat.putamen %>%
        filter(Cond == '1choice') %>%
        select(Group) %>%
        table()

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
plot <- raincloudplot_2Factor(fmridat.putamen, 'Beta', c('Cond','Group'),
                      title = 'Influence of subtypes on\nleft putamen activity',
                      xlab='', ylab='Beta', 
                      xticklabs = c(paste('MMP', ' (n=', N[1],')', sep=''),
                                    paste('IM', ' (n=', N[2],')', sep=''),
                                    paste('DM', ' (n=', N[3],')', sep='')),
                      legend_title = '', 
                      legend_labels = c('One','Two','Three'),
                      legend_position = legend_position,
                      color_scheme = 'mako')
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Subtypes_Putamen.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

# fmridat.putamen.collapsed <- fmridat.putamen %>%
#         pivot_wider(id_cols = c('pseudonym','Group','Up3OfBradySum'),
#                     values_from = Beta,
#                     names_from = Cond) %>%
#         mutate(Mean=(`1choice`+`2choice`+`3choice`)/3)
# 
# c <- cor.test(fmridat.putamen.collapsed$Mean, fmridat.putamen.collapsed$Up3OfBradySum)
# N <- fmridat.putamen.collapsed %>%
#                 select(pseudonym) %>%
#                 summarise(N=n())
# plot <- ggplot(fmridat.putamen.collapsed, aes(y=Mean, x=Up3OfBradySum)) +
#         geom_point(alpha = .3, shape = 19, size = 2) +
#         geom_smooth(method='lm', se = FALSE, lwd = 2, color = 'black') +
#         ggtitle('Association between mean putamen activity and \ndisease severity') + 
#         xlab('Bradykinesia severity') +
#         ylab('Beta') +
#         theme_cowplot(font_size = 35, font_family = 'Calibri') +
#         geom_text(x=16,y=1.3, label = paste('N=', N, ', r=', round(c$estimate,digits=2), sep=''),
#                   size=12)
# print(plot)
# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Corr_ON_Putamen_Severity.tiff',
#           plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)

#####

##### Mean activation #####

Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype, Up3OfBradySum)

# MMP > DM, mean

poistc <- vois[6]
csvfile <- poistc
fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()

plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Influence of subtypes on\nright S1 activity',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('MMP', ' (n=', N[1],')', sep=''),
                                    paste('IM', ' (n=', N[2],')', sep=''),
                                    paste('DM', ' (n=', N[3],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-2.5,7.5)

y <- 7.5
d = 0.7
segmap <- data.frame(
        x =    c(1.00, 1.00,  3.00,  0.85, 2.85),
        xend = c(3.00, 1.00,  3.00,  1.15, 3.15),
        y =    c(y,    y,     y,     y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1)
)
sigmap <- data.frame(
        x =     c(2),
        y =     c(y),
        label = c('*')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Subtypes_MMPgtDM_Mean_Postcentral.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

#####
```

## Subtypes vs HC

```{r echo=FALSE, warning=FALSE, message=FALSE}

##### Group analysis #####
# fmri.subtypes <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcImpSubtypes_x_ExtInt2Int3Catch_NoOutliers/'
# vois <- dir(fmri.subtypes, 'VOI.*csv', full.names = TRUE)
fmri.subtypes <- 'P:/3024006.02/Analyses/BRAIN_2023/fMRI/Group_comparisons/HcSubtypes_x_ExtInt2Int3Catch_NoOutliers/marsbar'
vois <- dir(fmri.subtypes, '*csv', full.names = TRUE)
vois <- vois[!str_detect(vois, '.*/HC_.*(IntExt).*csv')]
regions <- c('SFG',
             'R_PUT',
             'FP','MFG','IPL','MTG')

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype)
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                filter(Cond != 'Catch') %>%
                left_join(., Subtypes, by='pseudonym') %>%
                mutate(Group = as.character(Subtype),
                       Group = if_else(is.na(Group),'0_Healthy', Group),
                       Group = factor(Group,
                                      levels = c('0_Healthy', '1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant')),
                       Cond = factor(Cond,
                                     levels = c('Ext','Int2','Int3'),
                                     labels = c('1choice','2choice','3choice'))) %>%
                rename(Beta = Vals)
        
        bn <- basename(csvfile)
        if(str_detect(bn, 'MMP_HC') | str_detect(bn, 'HC_MMP')){
          fmridat.subset <- fmridat %>%
            filter(Group == '1_Mild-Motor' | Group == '0_Healthy')
        }else if(str_detect(bn, 'HC_Inter') | str_detect(bn, 'Inter_HC') | str_detect(bn, 'HC_IM') | str_detect(bn, 'IM_HC')){
          fmridat.subset <- fmridat %>%
            filter(Group == '2_Intermediate' | Group == '0_Healthy')
        }else if(str_detect(bn, 'HC_DM') | str_detect(bn, 'DM_HC') | str_detect(bn, 'HC_MD') | str_detect(bn, 'MD_HC')){
          fmridat.subset <- fmridat %>%
            filter(Group == '3_Diffuse-Malignant' | Group == '0_Healthy')
        }
        fmridat.subset <- fmridat.subset %>% pivot_wider(id_cols = c('pseudonym','Group'),
                                                         names_from = Cond,
                                                         values_from = Beta) %>%
                mutate(Avg = (`3choice` + `2choice` + `1choice`)/3,
                       IvL = `2choice` - `1choice`,
                       HvL = `3choice` - `1choice`,
                       Avg.Outlier = if_else(abs(Avg-mean(Avg)) > 3*sd(Avg), 1, 0),
                       IvL.Outlier = if_else(abs(IvL-mean(IvL)) > 3*sd(IvL), 1, 0),
                       HvL.Outlier = if_else(abs(HvL-mean(HvL)) > 3*sd(HvL), 1, 0)) %>%
                select(-c(`1choice`,`2choice`,`3choice`))
        fmridat.subset %>% filter(Avg.Outlier == TRUE | IvL.Outlier == TRUE | HvL.Outlier == TRUE) %>% kable(., 'pipe', digits = 3) %>% print()
        raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), 
                              title = str_glue(basename(csvfile),': ', regions[v]),
                              xlab='Group', ylab='Beta', xticklabs = c('Control','MMP','IM', 'DM'),
                              legend_title = 'No. of choices', legend_labels = c('One','Two','Three'),
                              color_scheme = 'mako') %>% print()
        print(bn)
        
        # fmridat <- fmridat %>%
        #         filter(Group %in% c('1_Mild-Motor','3_Diffuse-Malignant'))
        
}
#####

##### Interactions #####

Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype)

# MMP > HC: 3 > 1, rIPL
mmpgthc_ipl <- vois[5]
csvfile2 <- mmpgthc_ipl
fmridat <- read_csv(csvfile2, show_col_types = FALSE) %>%
  left_join(., Subtypes, by = 'pseudonym') %>%
  select(-scans) %>%
  filter(Cond != 'Catch') %>%
  mutate(Subtype = as.character(Subtype),
         Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype)) %>%
  filter(Subtype == '0_Healthy' | Subtype == '1_Mild-Motor') %>%
  mutate(Group = factor(Subtype,
                        levels = c('0_Healthy', '1_Mild-Motor'),
                        labels = c('Control', 'MMP')),
         Cond = factor(Cond,
                       levels = c('Ext','Int2','Int3'),
                       labels = c('1choice','2choice','3choice'))) %>%
  rename(Beta = Vals) %>%
  na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot1 <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Selection-related activity in the\nright inferior parietal cortex',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('Control', ' (n=', N[1],')', sep=''),
                                    paste('MMP', ' (n=', N[2],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-5,4)
y <- 4
d = 0.4
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.85,  0.85,  1.15,  1.85,  1.85,  2.15),
        xend = c(2.00, 1.00,  2.00,  1.15,  0.85,  1.15,  2.15,  1.85,  2.15),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('***')
)
plot1 <- plot1 + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot1)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcSubtypes_MMPgtHC_INT3gtEXT_IPL.tiff',
          plot1, dpi=300, device='tiff', base_width = 5)

# # MMP > HC: 3 > 1, MTG
mmpgthc_mtg <- vois[4]
csvfile2 <- mmpgthc_mtg
fmridat <- read_csv(csvfile2, show_col_types = FALSE) %>%
  left_join(., Subtypes, by = 'pseudonym') %>%
  select(-scans) %>%
  filter(Cond != 'Catch') %>%
  mutate(Subtype = as.character(Subtype),
         Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype)) %>%
  filter(Subtype == '0_Healthy' | Subtype == '1_Mild-Motor') %>%
  mutate(Group = factor(Subtype,
                        levels = c('0_Healthy', '1_Mild-Motor'),
                        labels = c('Control', 'MMP')),
         Cond = factor(Cond,
                       levels = c('Ext','Int2','Int3'),
                       labels = c('1choice','2choice','3choice'))) %>%
  rename(Beta = Vals) %>%
  na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot1 <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Selection-related activity in\nthe right TE1p',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('Control', ' (n=', N[1],')', sep=''),
                                    paste('MMP', ' (n=', N[2],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-2,3.5)
y <- 3.5
d = 0.4
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.85,  0.85,  1.15,  1.85,  1.85,  2.15),
        xend = c(2.00, 1.00,  2.00,  1.15,  0.85,  1.15,  2.15,  1.85,  2.15),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('**')
)
plot1 <- plot1 + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot1)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcSubtypes_MMPgtHC_INT3gtEXT_MTG.tiff',
          plot1, dpi=300, device='tiff', base_width = 5)

# HC > DM: 3 > 1, PMC
hcgtdm_pmc <- vois[1]
csvfile2 <- hcgtdm_pmc
fmridat <- read_csv(csvfile2, show_col_types = FALSE) %>%
  left_join(., Subtypes, by = 'pseudonym') %>%
  select(-scans) %>%
  filter(Cond != 'Catch') %>%
  mutate(Subtype = as.character(Subtype),
         Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype)) %>%
  filter(Subtype == '0_Healthy' | Subtype == '3_Diffuse-Malignant') %>%
  mutate(Group = factor(Subtype,
                        levels = c('0_Healthy', '3_Diffuse-Malignant'),
                        labels = c('Control', 'DM')),
         Cond = factor(Cond,
                       levels = c('Ext','Int2','Int3'),
                       labels = c('1choice','2choice','3choice'))) %>%
  rename(Beta = Vals) %>%
  na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot2 <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Selection-related activity in\nthe left premotor cortex',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('Control', ' (n=', N[1],')', sep=''),
                                    paste('DM', ' (n=', N[2],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-3,6.5)
y <- 6.5
d = 0.35
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.85,  0.85,  1.15,  1.85,  1.85,  2.15),
        xend = c(2.00, 1.00,  2.00,  1.15,  0.85,  1.15,  2.15,  1.85,  2.15),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.5),
        y =     c(y),
        label = c('**')
)
plot2 <- plot2 + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot2)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcSubtypes_HCgtDM_INT3gtEXT_PMC.tiff',
          plot2, dpi=300, device='tiff', base_width = 5)

# IM > HC: 2 > 1, rPutamen
imgthc_put <- vois[2]
csvfile2 <- imgthc_put
fmridat <- read_csv(csvfile2, show_col_types = FALSE) %>%
  left_join(., Subtypes, by = 'pseudonym') %>%
  select(-scans) %>%
  filter(Cond != 'Catch') %>%
  mutate(Subtype = as.character(Subtype),
         Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype)) %>%
  filter(Subtype == '0_Healthy' | Subtype == '2_Intermediate') %>%
  mutate(Group = factor(Subtype,
                        levels = c('0_Healthy', '2_Intermediate'),
                        labels = c('Control', 'IM')),
         Cond = factor(Cond,
                       levels = c('Ext','Int2','Int3'),
                       labels = c('1choice','2choice','3choice'))) %>%
  rename(Beta = Vals) %>%
  na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot3 <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Selection-related activity in\nthe right putamen',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('Control', ' (n=', N[1],')', sep=''),
                                    paste('IM', ' (n=', N[2],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-2.5,4.5)
y <- 4.5
d = 0.35
segmap <- data.frame(
        x =    c(0.925, 0.925,  1.925,  0.85,  1.85,  0.85,  1.00, 1.85,  2.00),
        xend = c(1.925, 0.925,  1.925,  1.00,  2.00,  0.85,  1.00, 1.85,  2.00),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.4),
        y =     c(y),
        label = c('**')
)
plot3 <- plot3 +
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap,
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot3)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcSubtypes_IMgtHC_2gt1_Put.tiff',
          plot3, dpi=300, device='tiff', base_width = 5)

#####

```

## Bradykinesia

```{r echo=FALSE, warning=FALSE, message=FALSE}

fmri.oncorr1 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/ClinCorr-BA_Up3OfBradySum_T0_NoOutliers/Int2gtExt/marsbar'
fmri.oncorr2 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/ClinCorr-BA_Up3OfBradySum_T0_NoOutliers/Int3gtExt/marsbar'
fmri.oncorr3 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/ClinCorr-BA_Up3OfBradySum_T0_NoOutliers/Mean_ExtInt/marsbar'
vois <- c(dir(fmri.oncorr1, '*csv', full.names = TRUE),
          dir(fmri.oncorr2, '*csv', full.names = TRUE),
          dir(fmri.oncorr3, '*csv', full.names = TRUE))
regions <- c('R_SFG', 'L_Paracingulate', 'R_MFG', 'R_IPS', 'R_SPL', 'L_SPL', 'R_SFG', 'R_IPS/SPL',
             'L_SFG', 'L_Paracingulate', 'R_IPS', 'L_SPL', 'R_SPL',
             'L_Precentral')

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Up3OfBradySum, Subtype)
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')
        
        c <- cor.test(fmridat$Beta,fmridat$Up3OfBradySum)
        p <- ggplot(fmridat, aes(x=Up3OfBradySum, y=Beta)) + 
                geom_point(aes(color=Subtype), alpha = .3, shape = 19, size = 2) + 
                geom_smooth(aes(color=Subtype), method = 'lm', se = FALSE, lwd = 2,) +
                ggtitle(basename(paste(csvfile, unique(fmridat$Cond), ':', regions[v], 'r=', round(c$estimate, digits = 3), sep = ' '))) + 
                theme_cowplot(font_size = 20) +
                xlab('Bradykinesia severity')
        print(p)
        
}

# Putamen and subtype data
Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype, Up3OfBradySum)

putamen <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/Subtypes_x_ExtInt2Int3Catch_NoOutliers/marsbar/x_HC_PD_(IntExt)_-27_-15_6.csv'
csvfile <- putamen
fmridat.putamen <- read_csv(csvfile, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant','4_Undefined'),
                              labels = c('MMP','IM','DM','Undefined')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()
fmridat.putamen.collapsed <- fmridat.putamen %>%
        pivot_wider(id_cols = c('pseudonym','Subtype','Group','Up3OfBradySum'),
                    values_from = Beta,
                    names_from = Cond) %>%
        mutate(Mean_ExtInt=(`1choice`+`2choice`+`3choice`)/3)

##### Mean correlation #####

voi.spl <- vois[14]
voi.putamen <- fmridat.putamen.collapsed %>%
        select(pseudonym,Mean_ExtInt) %>%
        rename(Putamen=Mean_ExtInt)

severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Up3OfBradySum, Subtype)

fmridat3 <- read_csv(voi.spl, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Precentral = Vals) %>%
                left_join(., severity, by = 'pseudonym')

# fmridat <- full_join(fmridat1, fmridat3)
fmridat <- left_join(fmridat3, voi.putamen, by = 'pseudonym')
fmridat <- fmridat %>%
        pivot_longer(cols = c('Precentral','Putamen'), names_to = 'Region', values_to = 'Beta')

# Scale
fmridat <- fmridat %>%
  group_by(Region) %>%
  mutate(Beta_scaled = scale(Beta)) %>%
  ungroup() %>%
    mutate(Region=factor(Region,levels = c('Putamen','Precentral')))

# c.PMC <- cor.test(fmridat$Beta[fmridat$Region=='PMC'],
#                   fmridat$Up3OfBradySum[fmridat$Region=='PMC'])
c.PCG <- cor.test(fmridat$Beta[fmridat$Region=='Precentral'],
                  fmridat$Up3OfBradySum[fmridat$Region=='Precentral'])
c.Putamen <- cor.test(fmridat$Beta[fmridat$Region=='Putamen'],
                  fmridat$Up3OfBradySum[fmridat$Region=='Putamen'])
c.Regions <- cor.test(fmridat$Beta[fmridat$Region=='Putamen'],
                      fmridat$Beta[fmridat$Region=='Precentral'])
cocor <- cocor.dep.groups.overlap(c.PCG$estimate,
                         c.Putamen$estimate,
                         c.Regions$estimate,
                         length(unique(fmridat$pseudonym)))
print(cocor)

N <- fmridat %>%
        select(pseudonym) %>%
        unique() %>%
        summarise(N=n())

plot <- ggplot(fmridat, aes(x=Up3OfBradySum, y=Beta_scaled, color=Region)) + 
        geom_point(alpha = .3, shape = 19, size = 1.5) + 
        geom_smooth(method = 'lm', se = TRUE, lwd = 1.5) +
        scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
                               direction=1,
                               labels = c(paste('Putamen', ' (n=', N[1],')',
                                                '', sep=''),
                                          paste('Precentral', ' (n=', N[1],')',
                                                '***', sep=''))) +
        ggtitle('Correlation between motor-related\nactivity and bradykinesia') + 
        guides(color=guide_legend(title='', reverse = TRUE)) +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        theme(legend.position = c(0.25,0.95),
              legend.key.size = unit(0.5,'cm')) +
        xlab('Bradykinesia severity') +
        ylab('Standardized beta') +
        ylim(-3,5) + 
  facet_grid(~Region)
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_Brady_ON_Mean_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

# Facetted version
# fmridat <- fmridat %>%
#         mutate(Subtype=factor(Subtype))
# 
# N <- fmridat %>%
#         select(pseudonym, Subtype) %>%
#         group_by(Subtype) %>%
#         unique() %>%
#         summarise(N=n())
# 
# plot <- ggplot(fmridat, aes(x=Up3OfBradySum, y=Beta_scaled)) + 
#         geom_point(aes(color=Subtype), alpha = .5, shape = 19, size = 1.5) + 
#         geom_smooth(method = 'lm', se = TRUE, lwd = 1, color='black') +
#         scale_colour_viridis_d(option='viridis', begin = 0.1, end = .8, alpha = .8,
#                                direction=-1,
#                                labels = c(paste('MMP', ' (n=', N[1,2],')', sep=''),
#                                           paste('IM', ' (n=', N[2,2],')', sep=''),
#                                           paste('DM', ' (n=', N[3,2],')', sep=''),
#                                           paste('Undefined', ' (n=', N[4,2],')', sep=''))) +
#         ggtitle('Correlation between motor-related\nactivity and bradykinesia') + 
#         guides(color=guide_legend(title='', reverse = FALSE)) +
#         theme_cowplot(font_size = 16, font_family = 'Calibri') +
#         theme(legend.position = c(0.0,0.85),
#               legend.key.size = unit(0.5,'cm')) +
#         xlab('Bradykinesia severity') +
#         ylab('Standardized beta') + 
#   ylim(-4,8) +
#         facet_grid(~Region)
# print(plot)

# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_ON_Mean_Severity_facet.tiff',
#           plot, dpi=300, device='tiff', base_width = 5)

#####

##### Three>One correlation #####

parietal1 <- vois[12]
voi.putamen <- fmridat.putamen.collapsed %>%
        mutate(INT3gtEXT = `3choice` - `1choice`) %>%
        select(pseudonym,INT3gtEXT) %>%
        rename(Putamen=INT3gtEXT)

severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Up3OfBradySum, Subtype)

fmridat1 <- read_csv(parietal1, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')

fmridat <- fmridat1 %>%
        mutate(Cond=factor(Cond)) %>%
        rename(SPL = Beta)

fmridat.SPL_putamen <- left_join(fmridat, voi.putamen, by=c('pseudonym')) %>%
        pivot_longer(cols = c('SPL','Putamen'), names_to = 'Region', values_to = 'Beta')

# Scale
fmridat.SPL_putamen <- fmridat.SPL_putamen %>%
  group_by(Region) %>%
  mutate(Beta_scaled = scale(Beta)) %>%
  ungroup() %>%
    mutate(Region = factor(Region,levels = c('Putamen', 'SPL')))

c.SPL <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='SPL'],
                  fmridat.SPL_putamen$Up3OfBradySum[fmridat.SPL_putamen$Region=='SPL'])
c.Putamen <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='Putamen'],
                  fmridat.SPL_putamen$Up3OfBradySum[fmridat.SPL_putamen$Region=='Putamen'])
c.Regions <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='Putamen'],
                      fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='SPL'])
cocor <- cocor.dep.groups.overlap(c.SPL$estimate,
                         c.Putamen$estimate,
                         c.Regions$estimate,
                         length(unique(fmridat.SPL_putamen$pseudonym)))
print(cocor)

N <- fmridat.SPL_putamen %>%
        select(pseudonym) %>%
        unique() %>%
        summarise(N=n())
plot <- ggplot(fmridat.SPL_putamen, aes(x=Up3OfBradySum, y=Beta_scaled, color=fct_rev(Region))) + 
        geom_point(alpha = .3, shape = 19, size = 1.5, show.legend = FALSE) + 
        geom_smooth(method = 'lm', se = TRUE, lwd = 1.5) +
        scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
                               direction = -1,
                               labels = c(paste('SPL', ' (n=', N[1],')',
                                                '***', sep=''),
                                          paste('Putamen', ' (n=', N[1],')',
                                                '', sep=''))) +
        ggtitle('Correlation between selection-related\nactivity and bradykinesia') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        theme(legend.position = c(0.25,0.95),
              legend.key.size = unit(0.5,'cm')) +
        xlab('Bradykinesia severity') +
        ylab('Standardized beta') + 
  ylim(-3,6) +
  facet_grid(~Region)
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_Brady_ON_INT3gtEXT_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

#Facetted vcersion
# fmridat.SPL_putamen <- fmridat.SPL_putamen %>%
#         mutate(Subtype=factor(Subtype))
# 
# N <- fmridat.SPL_putamen %>%
#         select(pseudonym, Subtype) %>%
#         group_by(Subtype) %>%
#         unique() %>%
#         summarise(N=n())
# 
# plot <- ggplot(fmridat.SPL_putamen, aes(x=Up3OfBradySum, y=Beta_scaled)) + 
#         geom_point(aes(color=Subtype), alpha = .5, shape = 19, size = 1.5) + 
#         geom_smooth(method = 'lm', se = TRUE, lwd = 1, color='black') +
#         scale_colour_viridis_d(option='viridis', begin = 0.1, end = .8, alpha = .8,
#                                direction=-1,
#                                labels = c(paste('MMP', ' (n=', N[1,2],')', sep=''),
#                                           paste('IM', ' (n=', N[2,2],')', sep=''),
#                                           paste('DM', ' (n=', N[3,2],')', sep=''),
#                                           paste('Undefined', ' (n=', N[4,2],')', sep=''))) +
#         ggtitle('Correlation between selection-related\nactivity and bradykinesia') + 
#         guides(color=guide_legend(title='', reverse = FALSE)) +
#         theme_cowplot(font_size = 16, font_family = 'Calibri') +
#         theme(legend.position = c(0.0,0.85),
#               legend.key.size = unit(0.5,'cm')) +
#         xlab('Bradykinesia severity') +
#         ylab('Standardized beta') +
#   ylim(-4,8) +
#         facet_grid(~factor(Region, levels = c('Putamen','SPL'), labels = c('Putamen','SPL')))
# print(plot)

# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_ON_INT3gtEXT_Severity_facet.tiff',
#           plot, dpi=300, device='tiff', base_width = 5)

#####
```

## Cognitive composite

```{r echo=FALSE, warning=FALSE, message=FALSE}

fmri.oncorr1 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/ClinCorr-BA_CognitiveComposite_T0_NoOutliers/Int2gtExt/marsbar'
fmri.oncorr2 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/ClinCorr-BA_CognitiveComposite_T0_NoOutliers/Int3gtExt/marsbar'
fmri.oncorr3 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/ClinCorr-BA_CognitiveComposite_T0_NoOutliers/Mean_ExtInt/marsbar'
vois <- c(dir(fmri.oncorr1, '*csv', full.names = TRUE),
          dir(fmri.oncorr2, '*csv', full.names = TRUE),
          dir(fmri.oncorr3, '*csv', full.names = TRUE))
regions <- c('L_IPS','R_SPL','R_MFG',
             'L_V3d', 'L_IPS', 'R_SPL', 'R_SFG',
             'L_Paracingulate', 'L_Precentral', 'L_Postcentral', 'R_IPS')

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, CognitiveComposite, Subtype)
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')
        
        c <- cor.test(fmridat$Beta,fmridat$CognitiveComposite)
        p <- ggplot(fmridat, aes(x=CognitiveComposite, y=Beta)) + 
                geom_point(aes(color=Subtype), alpha = .3, shape = 19, size = 2) + 
                geom_smooth(aes(color=Subtype), method = 'lm', se = FALSE, lwd = 2,) +
                ggtitle(basename(paste(csvfile, unique(fmridat$Cond), ':', regions[v], 'r=', round(c$estimate, digits = 3), sep = ' '))) + 
                theme_cowplot(font_size = 20) +
                xlab('Cognitive performance (z)')
        print(p)
        
}

# Putamen and subtype data
Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype, CognitiveComposite)

putamen <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/Subtypes_x_ExtInt2Int3Catch_NoOutliers/marsbar/x_HC_PD_(IntExt)_-27_-15_6.csv'
csvfile <- putamen
fmridat.putamen <- read_csv(csvfile, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant','4_Undefined'),
                              labels = c('MMP','IM','DM','Undefined')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()
fmridat.putamen.collapsed <- fmridat.putamen %>%
        pivot_wider(id_cols = c('pseudonym','Subtype','Group','CognitiveComposite'),
                    values_from = Beta,
                    names_from = Cond) %>%
        mutate(Mean_ExtInt=(`1choice`+`2choice`+`3choice`)/3)

##### Mean correlation #####

voi.pcg <- vois[9]
voi.putamen <- fmridat.putamen.collapsed %>%
        select(pseudonym,Mean_ExtInt) %>%
        rename(Putamen=Mean_ExtInt)

severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, CognitiveComposite, Subtype)

fmridat3 <- read_csv(voi.pcg, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Precentral = Vals) %>%
                left_join(., severity, by = 'pseudonym')

# fmridat <- full_join(fmridat1, fmridat3)
fmridat <- left_join(fmridat3, voi.putamen, by = 'pseudonym')
fmridat <- fmridat %>%
        pivot_longer(cols = c('Precentral','Putamen'), names_to = 'Region', values_to = 'Beta')

# Scale
fmridat <- fmridat %>%
  group_by(Region) %>%
  mutate(Beta_scaled = scale(Beta)) %>%
  ungroup() %>%
    mutate(Region=factor(Region,levels = c('Putamen','Precentral')))

# c.PMC <- cor.test(fmridat$Beta[fmridat$Region=='PMC'],
#                   fmridat$Up3OfBradySum[fmridat$Region=='PMC'])
c.Precentral <- cor.test(fmridat$Beta[fmridat$Region=='Precentral'],
                  fmridat$CognitiveComposite[fmridat$Region=='Precentral'])
c.Putamen <- cor.test(fmridat$Beta[fmridat$Region=='Putamen'],
                  fmridat$CognitiveComposite[fmridat$Region=='Putamen'])
c.Regions <- cor.test(fmridat$Beta[fmridat$Region=='Putamen'],
                      fmridat$Beta[fmridat$Region=='Precentral'])
cocor <- cocor.dep.groups.overlap(c.Precentral$estimate,
                         c.Putamen$estimate,
                         c.Regions$estimate,
                         length(unique(fmridat$pseudonym)))
print(cocor)

N <- fmridat %>%
        select(pseudonym) %>%
        unique() %>%
        summarise(N=n())

plot <- ggplot(fmridat, aes(x=CognitiveComposite, y=Beta_scaled, color=Region)) + 
        geom_point(alpha = .3, shape = 19, size = 1.5) + 
        geom_smooth(method = 'lm', se = TRUE, lwd = 1.5) +
        scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
                               direction=1,
                               labels = c(paste('Putamen', ' (n=', N[1],')',
                                                '', sep=''),
                                          paste('Precentral', ' (n=', N[1],')',
                                                '***', sep=''))) +
        ggtitle('Correlation between motor-related\nactivity and cognitive performance') + 
        guides(color=guide_legend(title='', reverse = TRUE)) +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        theme(legend.position = c(0.25,0.95),
              legend.key.size = unit(0.5,'cm')) +
        xlab('Cognitive performance (z)') +
        ylab('Standardized beta') +
        ylim(-4,5) + 
  facet_grid(~Region)
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_CogCom_ON_Mean_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

# Facetted version
# fmridat <- fmridat %>%
#         mutate(Subtype=factor(Subtype))
# 
# N <- fmridat %>%
#         select(pseudonym, Subtype) %>%
#         group_by(Subtype) %>%
#         unique() %>%
#         summarise(N=n())
# 
# plot <- ggplot(fmridat, aes(x=CognitiveComposite, y=Beta_scaled)) + 
#         geom_point(aes(color=Subtype), alpha = .5, shape = 19, size = 1.5) + 
#         geom_smooth(method = 'lm', se = TRUE, lwd = 1, color='black') +
#         scale_colour_viridis_d(option='viridis', begin = 0.1, end = .8, alpha = .8,
#                                direction=-1,
#                                labels = c(paste('MMP', ' (n=', N[1,2],')', sep=''),
#                                           paste('IM', ' (n=', N[2,2],')', sep=''),
#                                           paste('DM', ' (n=', N[3,2],')', sep=''),
#                                           paste('Undefined', ' (n=', N[4,2],')', sep=''))) +
#         ggtitle('Correlation between motor-related\nactivity and cognitive function') + 
#         guides(color=guide_legend(title='', reverse = FALSE)) +
#         theme_cowplot(font_size = 16, font_family = 'Calibri') +
#         theme(legend.position = c(0.0,0.85),
#               legend.key.size = unit(0.5,'cm')) +
#         xlab('Cognitive function') +
#         ylab('Standardized beta') + 
#   ylim(-4,8) +
#         facet_grid(~Region)
# print(plot)

# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_ON_Mean_Severity_facet.tiff',
#           plot, dpi=300, device='tiff', base_width = 5)

#####

##### Three>One correlation #####

parietal1 <- vois[6]
voi.putamen <- fmridat.putamen.collapsed %>%
        mutate(INT3gtEXT = `3choice` - `1choice`) %>%
        select(pseudonym,INT3gtEXT) %>%
        rename(Putamen=INT3gtEXT)

severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, CognitiveComposite, Subtype)

fmridat1 <- read_csv(parietal1, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')

fmridat <- fmridat1 %>%
        mutate(Cond=factor(Cond)) %>%
        rename(SPL = Beta)

fmridat.SPL_putamen <- left_join(fmridat, voi.putamen, by=c('pseudonym')) %>%
        pivot_longer(cols = c('SPL','Putamen'), names_to = 'Region', values_to = 'Beta')

# Scale
fmridat.SPL_putamen <- fmridat.SPL_putamen %>%
  group_by(Region) %>%
  mutate(Beta_scaled = scale(Beta)) %>%
  ungroup() %>%
    mutate(Region = factor(Region,levels = c('Putamen', 'SPL')))

c.SPL <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='SPL'],
                  fmridat.SPL_putamen$CognitiveComposite[fmridat.SPL_putamen$Region=='SPL'])
c.Putamen <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='Putamen'],
                  fmridat.SPL_putamen$CognitiveComposite[fmridat.SPL_putamen$Region=='Putamen'])
c.Regions <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='Putamen'],
                      fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='SPL'])
cocor <- cocor.dep.groups.overlap(c.SPL$estimate,
                         c.Putamen$estimate,
                         c.Regions$estimate,
                         length(unique(fmridat.SPL_putamen$pseudonym)))
print(cocor)

N <- fmridat.SPL_putamen %>%
        select(pseudonym) %>%
        unique() %>%
        summarise(N=n())
plot <- ggplot(fmridat.SPL_putamen, aes(x=CognitiveComposite, y=Beta_scaled, color=fct_rev(Region))) + 
        geom_point(alpha = .3, shape = 19, size = 1.5, show.legend = FALSE) + 
        geom_smooth(method = 'lm', se = TRUE, lwd = 1.5) +
        scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
                               direction = -1,
                               labels = c(paste('SPL', ' (n=', N[1],')',
                                                '***', sep=''),
                                          paste('Putamen', ' (n=', N[1],')',
                                                '', sep=''))) +
        ggtitle('Correlation between selection-related\nactivity and cognitive performance') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        theme(legend.position = c(0.25,0.95),
              legend.key.size = unit(0.5,'cm')) +
        xlab('Cognitive performance (z)') +
        ylab('Standardized beta') + 
  ylim(-3,6) +
  facet_grid(~Region)
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_CogCom_ON_INT3gtEXT_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

#Facetted vcersion
# fmridat.SPL_putamen <- fmridat.SPL_putamen %>%
#         mutate(Subtype=factor(Subtype))
# 
# N <- fmridat.SPL_putamen %>%
#         select(pseudonym, Subtype) %>%
#         group_by(Subtype) %>%
#         unique() %>%
#         summarise(N=n())
# 
# plot <- ggplot(fmridat.SPL_putamen, aes(x=CognitiveComposite, y=Beta_scaled)) + 
#         geom_point(aes(color=Subtype), alpha = .5, shape = 19, size = 1.5) + 
#         geom_smooth(method = 'lm', se = TRUE, lwd = 1, color='black') +
#         scale_colour_viridis_d(option='viridis', begin = 0.1, end = .8, alpha = .8,
#                                direction=-1,
#                                labels = c(paste('MMP', ' (n=', N[1,2],')', sep=''),
#                                           paste('IM', ' (n=', N[2,2],')', sep=''),
#                                           paste('DM', ' (n=', N[3,2],')', sep=''),
#                                           paste('Undefined', ' (n=', N[4,2],')', sep=''))) +
#         ggtitle('Correlation between selection-related\nactivity and cognitive function') + 
#         guides(color=guide_legend(title='', reverse = FALSE)) +
#         theme_cowplot(font_size = 16, font_family = 'Calibri') +
#         theme(legend.position = c(0.0,0.85),
#               legend.key.size = unit(0.5,'cm')) +
#         xlab('Cognitive function') +
#         ylab('Standardized beta') +
#   ylim(-4,8) +
#         facet_grid(~factor(Region, levels = c('Putamen','SPL'), labels = c('Putamen','SPL')))
# print(plot)

# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_ON_INT3gtEXT_Severity_facet.tiff',
#           plot, dpi=300, device='tiff', base_width = 5)

#####
```

## Brady + CC

```{r echo=FALSE, warning=FALSE, message=FALSE}

fmri.oncorr1 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/ClinCorr-BA_Up3OfBradySumCognitiveComposite_T0_NoOutliers/Int2gtExt/marsbar'
fmri.oncorr2 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/ClinCorr-BA_Up3OfBradySumCognitiveComposite_T0_NoOutliers/Int3gtExt/marsbar'
fmri.oncorr3 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/ClinCorr-BA_Up3OfBradySumCognitiveComposite_T0_NoOutliers/Mean_ExtInt/marsbar'
vois <- c(dir(fmri.oncorr1, '*csv', full.names = TRUE),
          dir(fmri.oncorr2, '*csv', full.names = TRUE),
          dir(fmri.oncorr3, '*csv', full.names = TRUE))
regions <- c('L_SFG','L_SPL','R_MFG',
             'L_SPL', 'L_V3d', 'R_MFG', 'R_Precentral', 'R_dlPFC')

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Up3OfBradySum, CognitiveComposite, Subtype)
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')
        
        if(str_detect(basename(csvfile),'BA_')){
                c <- cor.test(fmridat$Beta,fmridat$Up3OfBradySum)
                print(c)
                p <- ggplot(fmridat, aes(x=Up3OfBradySum, y=Beta)) + 
                        geom_point(aes(color=Subtype), alpha = .3, shape = 19, size = 2) + 
                        geom_smooth(aes(color=Subtype), method = 'lm', se = FALSE, lwd = 2,) +
                        ggtitle(basename(paste(csvfile, unique(fmridat$Cond), ':',
                                               regions[v], 'r=', round(c$estimate, digits = 3),
                                               sep = ' '))) + 
                        theme_cowplot(font_size = 20) +
                        xlab('Bradykinesia severity')
                print(p)
        }else{
                c <- cor.test(fmridat$Beta,fmridat$CognitiveComposite)
                print(c)
                p <- ggplot(fmridat, aes(x=CognitiveComposite, y=Beta)) + 
                        geom_point(aes(color=Subtype), alpha = .3, shape = 19, size = 2) + 
                        geom_smooth(aes(color=Subtype), method = 'lm', se = FALSE, lwd = 2,) +
                        ggtitle(basename(paste(csvfile, unique(fmridat$Cond), ':',
                                               regions[v], 'r=', round(c$estimate, digits = 3),
                                               sep = ' '))) + 
                        theme_cowplot(font_size = 20) +
                        xlab('Cognitive performance (z)')
                print(p)
        }
        
}

# Putamen and subtype data
Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype, CognitiveComposite)

putamen <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/Subtypes_x_ExtInt2Int3Catch_NoOutliers/marsbar/x_HC_PD_(IntExt)_-27_-15_6.csv'
csvfile <- putamen
fmridat.putamen <- read_csv(csvfile, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant','4_Undefined'),
                              labels = c('MMP','IM','DM','Undefined')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()
fmridat.putamen.collapsed <- fmridat.putamen %>%
        pivot_wider(id_cols = c('pseudonym','Subtype','Group','CognitiveComposite'),
                    values_from = Beta,
                    names_from = Cond) %>%
        mutate(Mean_ExtInt=(`1choice`+`2choice`+`3choice`)/3)

# ##### Mean correlation #####
# 
# voi.pcg <- vois[9]
# voi.putamen <- fmridat.putamen.collapsed %>%
#         select(pseudonym,Mean_ExtInt) %>%
#         rename(Putamen=Mean_ExtInt)
# 
# severity <- dfClin %>%
#                 filter(TimepointNr==0,
#                        ParticipantType=='PD_POM') %>%
#                 select(pseudonym, CognitiveComposite, Subtype)
# 
# fmridat3 <- read_csv(voi.pcg, show_col_types = FALSE) %>%
#                 select(-scans) %>%
#                 rename(Precentral = Vals) %>%
#                 left_join(., severity, by = 'pseudonym')
# 
# # fmridat <- full_join(fmridat1, fmridat3)
# fmridat <- left_join(fmridat3, voi.putamen, by = 'pseudonym')
# fmridat <- fmridat %>%
#         pivot_longer(cols = c('Precentral','Putamen'), names_to = 'Region', values_to = 'Beta')
# 
# # Scale
# fmridat <- fmridat %>%
#   group_by(Region) %>%
#   mutate(Beta_scaled = scale(Beta)) %>%
#   ungroup() %>%
#     mutate(Region=factor(Region,levels = c('Putamen','Precentral')))
# 
# # c.PMC <- cor.test(fmridat$Beta[fmridat$Region=='PMC'],
# #                   fmridat$Up3OfBradySum[fmridat$Region=='PMC'])
# c.Precentral <- cor.test(fmridat$Beta[fmridat$Region=='Precentral'],
#                   fmridat$CognitiveComposite[fmridat$Region=='Precentral'])
# c.Putamen <- cor.test(fmridat$Beta[fmridat$Region=='Putamen'],
#                   fmridat$CognitiveComposite[fmridat$Region=='Putamen'])
# c.Regions <- cor.test(fmridat$Beta[fmridat$Region=='Putamen'],
#                       fmridat$Beta[fmridat$Region=='Precentral'])
# cocor <- cocor.dep.groups.overlap(c.Precentral$estimate,
#                          c.Putamen$estimate,
#                          c.Regions$estimate,
#                          length(unique(fmridat$pseudonym)))
# print(cocor)
# 
# N <- fmridat %>%
#         select(pseudonym) %>%
#         unique() %>%
#         summarise(N=n())
# 
# plot <- ggplot(fmridat, aes(x=CognitiveComposite, y=Beta_scaled, color=Region)) + 
#         geom_point(alpha = .3, shape = 19, size = 1.5) + 
#         geom_smooth(method = 'lm', se = TRUE, lwd = 1.5) +
#         scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
#                                direction=1,
#                                labels = c(paste('Putamen', ' (n=', N[1],')',
#                                                 '', sep=''),
#                                           paste('Precentral', ' (n=', N[1],')',
#                                                 '***', sep=''))) +
#         ggtitle('Correlation between motor-related\nactivity and cognitive function') + 
#         guides(color=guide_legend(title='', reverse = TRUE)) +
#         theme_cowplot(font_size = 16, font_family = 'Calibri') +
#         theme(legend.position = c(0.02,0.9),
#               legend.key.size = unit(0.5,'cm')) +
#         xlab('Cognitive function') +
#         ylab('Standardized beta') +
#         ylim(-4,5) + 
#   facet_grid(~Region)
# print(plot)
# 
# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_CogCom_ON_Mean_Severity.tiff',
#           plot, dpi=300, device='tiff', base_width = 5)

#####

##### BRADYKINESIA: Three>One correlation #####

parietal1 <- vois[4]
voi.putamen <- fmridat.putamen.collapsed %>%
        mutate(INT3gtEXT = `3choice` - `1choice`) %>%
        select(pseudonym,INT3gtEXT) %>%
        rename(Putamen=INT3gtEXT)

severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Up3OfBradySum, Subtype)

fmridat1 <- read_csv(parietal1, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')

fmridat <- fmridat1 %>%
        mutate(Cond=factor(Cond)) %>%
        rename(SPL = Beta)

fmridat.SPL_putamen <- left_join(fmridat, voi.putamen, by=c('pseudonym')) %>%
        pivot_longer(cols = c('SPL','Putamen'), names_to = 'Region', values_to = 'Beta')

# Scale
fmridat.SPL_putamen <- fmridat.SPL_putamen %>%
  group_by(Region) %>%
  mutate(Beta_scaled = scale(Beta)) %>%
  ungroup() %>%
    mutate(Region = factor(Region,levels = c('Putamen', 'SPL')))

c.SPL <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='SPL'],
                  fmridat.SPL_putamen$Up3OfBradySum[fmridat.SPL_putamen$Region=='SPL'])
c.Putamen <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='Putamen'],
                  fmridat.SPL_putamen$Up3OfBradySum[fmridat.SPL_putamen$Region=='Putamen'])
c.Regions <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='Putamen'],
                      fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='SPL'])
cocor <- cocor.dep.groups.overlap(c.SPL$estimate,
                         c.Putamen$estimate,
                         c.Regions$estimate,
                         length(unique(fmridat.SPL_putamen$pseudonym)))
print(cocor)

N <- fmridat.SPL_putamen %>%
        select(pseudonym) %>%
        unique() %>%
        summarise(N=n())
plot <- ggplot(fmridat.SPL_putamen, aes(x=Up3OfBradySum, y=Beta_scaled,
                                        color=fct_rev(Region))) + 
        geom_point(alpha = .3, shape = 19, size = 1.5, show.legend = FALSE) + 
        geom_smooth(method = 'lm', se = TRUE, lwd = 1.5) +
        scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
                               direction = -1,
                               labels = c(paste('SPL', ' (n=', N[1],')',
                                                '**', sep=''),
                                          paste('Putamen', ' (n=', N[1],')',
                                                '', sep=''))) +
        ggtitle('Correlation between selection-related\nactivity and bradykinesia') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        theme(legend.position = c(0.25,0.95),
              legend.key.size = unit(0.5,'cm')) +
        xlab('Bradykinesia severity') +
        ylab('Standardized beta') + 
  ylim(-3,5) +
  facet_grid(~Region)
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_BradyCogCom_BradySpecific_ON_INT3gtEXT_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

#####

##### COGNITIVE IMPAIRMENT: Three>One correlation #####

premotor1 <- vois[6]
voi.putamen <- fmridat.putamen.collapsed %>%
        mutate(INT3gtEXT = `3choice` - `1choice`) %>%
        select(pseudonym,INT3gtEXT) %>%
        rename(Putamen=INT3gtEXT)

severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, CognitiveComposite, Subtype)

fmridat1 <- read_csv(premotor1, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')

fmridat <- fmridat1 %>%
        mutate(Cond=factor(Cond)) %>%
        rename(PMC = Beta)

fmridat.PMC_putamen <- left_join(fmridat, voi.putamen, by=c('pseudonym')) %>%
        pivot_longer(cols = c('PMC','Putamen'), names_to = 'Region', values_to = 'Beta')

# Scale
fmridat.PMC_putamen <- fmridat.PMC_putamen %>%
  group_by(Region) %>%
  mutate(Beta_scaled = scale(Beta)) %>%
  ungroup() %>%
    mutate(Region = factor(Region,levels = c('Putamen', 'PMC')))

c.PMC <- cor.test(fmridat.PMC_putamen$Beta[fmridat.PMC_putamen$Region=='PMC'],
                  fmridat.PMC_putamen$CognitiveComposite[fmridat.PMC_putamen$Region=='PMC'])
c.Putamen <- cor.test(fmridat.PMC_putamen$Beta[fmridat.PMC_putamen$Region=='Putamen'],
                  fmridat.PMC_putamen$CognitiveComposite[fmridat.PMC_putamen$Region=='Putamen'])
c.Regions <- cor.test(fmridat.PMC_putamen$Beta[fmridat.PMC_putamen$Region=='Putamen'],
                      fmridat.PMC_putamen$Beta[fmridat.PMC_putamen$Region=='PMC'])
cocor <- cocor.dep.groups.overlap(c.SPL$estimate,
                         c.Putamen$estimate,
                         c.Regions$estimate,
                         length(unique(fmridat.PMC_putamen$pseudonym)))
print(cocor)

N <- fmridat.PMC_putamen %>%
        select(pseudonym) %>%
        unique() %>%
        summarise(N=n())
plot <- ggplot(fmridat.PMC_putamen, aes(x=CognitiveComposite, y=Beta_scaled,
                                        color=fct_rev(Region))) + 
        geom_point(alpha = .3, shape = 19, size = 1.5, show.legend = FALSE) + 
        geom_smooth(method = 'lm', se = TRUE, lwd = 1.5) +
        scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
                               direction = -1,
                               labels = c(paste('PMC', ' (n=', N[1],')',
                                                '**', sep=''),
                                          paste('Putamen', ' (n=', N[1],')',
                                                '', sep=''))) +
        ggtitle('Correlation between selection-related\nactivity and cognitive performance') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        theme(legend.position = c(0.25,0.95),
              legend.key.size = unit(0.5,'cm')) +
        xlab('Cognitive performance (z)') +
        ylab('Standardized beta') + 
  ylim(-3,5) +
  facet_grid(~Region)
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_BradyCogCom_CogComSpecific_ON_INT3gtEXT_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

#####
```

## Response times

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE}

fmri.oncorr1 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/ClinCorr-BA_Motor_T0_NoOutliers/Mean_ExtInt/marsbar'
fmri.oncorr2 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/ClinCorr-BA_Select2_T0_NoOutliers/Int2gtExt/marsbar'
fmri.oncorr3 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/ClinCorr-BA_Select3_T0_NoOutliers/Int3gtExt/marsbar'
vois <- c(dir(fmri.oncorr1, '*csv', full.names = TRUE),
          dir(fmri.oncorr2, '*csv', full.names = TRUE),
          dir(fmri.oncorr3, '*csv', full.names = TRUE))
vois <- c(vois[1], vois[14],
          vois[17],
          vois[30],vois[26])
regions <- c('L_PMC_SPL', 'R_IPL',
             'L_PMC_SPL',
             'L_PMC_SPL','L_mPFC')

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        severity <- df %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, trial_type, block, response_time) %>%
            group_by(pseudonym, trial_type) %>%
            summarise(response_time = mean(response_time)) %>%
            ungroup() %>%
            pivot_wider(id_cols = 'pseudonym',
                        names_from = trial_type,
                        names_prefix = 'TT_',
                        values_from = response_time) %>%
            mutate(Motor = (TT_1choice +TT_2choice +TT_3choice) /3,
                   AS_2gt1 = TT_2choice - TT_1choice,
                   AS_3gt1 = TT_3choice - TT_1choice) %>%
            select(!starts_with('TT_'))
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')
        
        if(str_detect(csvfile,'Mean_ExtInt')){
            c <- cor.test(fmridat$Beta, fmridat$Motor)
            p <- ggplot(fmridat, aes(x=Motor, y=Beta)) + 
                geom_point(alpha = .3, shape = 19, size = 2) + 
                geom_smooth(method = 'lm', se = FALSE, lwd = 2,) +
                ggtitle(basename(paste(csvfile, unique(fmridat$Cond), ':',
                                       regions[v], 'r=',
                                       round(c$estimate, digits = 3), sep = ' '))) + 
                theme_cowplot(font_size = 20) +
                xlab('Mean RT')
        }else if(str_detect(csvfile,'Int2gtExt')){
            c <- cor.test(fmridat$Beta, fmridat$AS_2gt1)
            p <- ggplot(fmridat, aes(x=AS_2gt1, y=Beta)) + 
                geom_point(alpha = .3, shape = 19, size = 2) + 
                geom_smooth(method = 'lm', se = FALSE, lwd = 2,) +
                ggtitle(basename(paste(csvfile, unique(fmridat$Cond), ':',
                                       regions[v], 'r=',
                                       round(c$estimate, digits = 3), sep = ' '))) + 
                theme_cowplot(font_size = 20) +
                xlab('Two > One')
            
        }else if(str_detect(csvfile,'Int3gtExt')){
            c <- cor.test(fmridat$Beta, fmridat$AS_3gt1)
            p <- ggplot(fmridat, aes(x=AS_3gt1, y=Beta)) + 
                geom_point(alpha = .3, shape = 19, size = 2) + 
                geom_smooth(method = 'lm', se = FALSE, lwd = 2,) +
                ggtitle(basename(paste(csvfile, unique(fmridat$Cond), ':',
                                       regions[v], 'r=',
                                       round(c$estimate, digits = 3), sep = ' '))) + 
                theme_cowplot(font_size = 20) +
                xlab('Three > One')
        }
        print(p)
}

# Putamen and subtype data
Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype, CognitiveComposite)

putamen <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/Subtypes_x_ExtInt2Int3Catch_NoOutliers/marsbar/x_HC_PD_(IntExt)_-27_-15_6.csv'
csvfile <- putamen
fmridat.putamen <- read_csv(csvfile, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant','4_Undefined'),
                              labels = c('MMP','IM','DM','Undefined')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()
fmridat.putamen.collapsed <- fmridat.putamen %>%
        pivot_wider(id_cols = c('pseudonym','Subtype','Group','CognitiveComposite'),
                    values_from = Beta,
                    names_from = Cond) %>%
        mutate(Mean_ExtInt=(`1choice`+`2choice`+`3choice`)/3)

##### Mean correlation #####

voi.pmc_spl <- vois[2]
voi.putamen <- fmridat.putamen.collapsed %>%
        select(pseudonym,Mean_ExtInt) %>%
        rename(Putamen=Mean_ExtInt)

severity <- df %>%
    filter(TimepointNr==0,
           ParticipantType=='PD_POM') %>%
    select(pseudonym, trial_type, block, response_time) %>%
    group_by(pseudonym, trial_type) %>%
    summarise(response_time = mean(response_time)) %>%
    ungroup() %>%
    pivot_wider(id_cols = 'pseudonym',
                names_from = trial_type,
                names_prefix = 'TT_',
                values_from = response_time) %>%
    mutate(Motor = (TT_1choice +TT_2choice +TT_3choice) /3) %>%
    select(!starts_with('TT_'))

fmridat3 <- read_csv(voi.pmc_spl, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(PMC_SPL = Vals) %>%
                left_join(., severity, by = 'pseudonym')

# fmridat <- full_join(fmridat1, fmridat3)
fmridat <- left_join(fmridat3, voi.putamen, by = 'pseudonym')
fmridat <- fmridat %>%
        pivot_longer(cols = c('PMC_SPL','Putamen'), names_to = 'Region', values_to = 'Beta')

# Scale
fmridat <- fmridat %>%
  group_by(Region) %>%
  mutate(Beta_scaled = scale(Beta)) %>%
  ungroup() %>%
    mutate(Region=factor(Region,levels = c('Putamen','PMC_SPL')))

# c.PMC <- cor.test(fmridat$Beta[fmridat$Region=='PMC'],
#                   fmridat$Up3OfBradySum[fmridat$Region=='PMC'])
c.PMC_SPL <- cor.test(fmridat$Beta[fmridat$Region=='PMC_SPL'],
                  fmridat$Motor[fmridat$Region=='PMC_SPL'])
c.Putamen <- cor.test(fmridat$Beta[fmridat$Region=='Putamen'],
                  fmridat$Motor[fmridat$Region=='Putamen'])
c.Regions <- cor.test(fmridat$Beta[fmridat$Region=='Putamen'],
                      fmridat$Beta[fmridat$Region=='PMC_SPL'])
cocor <- cocor.dep.groups.overlap(c.PMC_SPL$estimate,
                         c.Putamen$estimate,
                         c.Regions$estimate,
                         length(unique(fmridat$pseudonym)))
print(cocor)

N <- fmridat %>%
        select(pseudonym) %>%
        unique() %>%
        summarise(N=n())

plot <- ggplot(fmridat, aes(x=Motor, y=Beta_scaled, color=Region)) + 
        geom_point(alpha = .3, shape = 19, size = 1.5) + 
        geom_smooth(method = 'lm', se = TRUE, lwd = 1.5) +
        scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
                               direction=1,
                               labels = c(paste('Putamen', ' (n=', N[1],')',
                                                '', sep=''),
                                          paste('PMC_SPL', ' (n=', N[1],')',
                                                '***', sep=''))) +
        ggtitle('Correlation between motor-related\nactivity and mean response time') + 
        guides(color=guide_legend(title='', reverse = TRUE)) +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        theme(legend.position = c(0.25,0.95),
              legend.key.size = unit(0.5,'cm')) +
        xlab('Mean response time (s)') +
        ylab('Standardized beta') +
        ylim(-4.5,4) + 
  facet_grid(~Region)
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_RTmean_ON_Mean_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

#####

##### Three>One correlation #####

parietal1 <- vois[4]
voi.putamen <- fmridat.putamen.collapsed %>%
        mutate(INT3gtEXT = `3choice` - `1choice`) %>%
        select(pseudonym,INT3gtEXT) %>%
        rename(Putamen=INT3gtEXT)

severity <- df %>%
    filter(TimepointNr==0,
           ParticipantType=='PD_POM') %>%
    select(pseudonym, trial_type, block, response_time) %>%
    group_by(pseudonym, trial_type) %>%
    summarise(response_time = mean(response_time)) %>%
    ungroup() %>%
    pivot_wider(id_cols = 'pseudonym',
                names_from = trial_type,
                names_prefix = 'TT_',
                values_from = response_time) %>%
    mutate(AS_3gt1 = TT_3choice - TT_1choice) %>%
    select(!starts_with('TT_'))

fmridat1 <- read_csv(parietal1, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')

fmridat <- fmridat1 %>%
        mutate(Cond=factor(Cond)) %>%
        rename(PMC_SPL = Beta)

fmridat.SPL_putamen <- left_join(fmridat, voi.putamen, by=c('pseudonym')) %>%
        pivot_longer(cols = c('PMC_SPL','Putamen'), names_to = 'Region', values_to = 'Beta')

# Scale
fmridat.SPL_putamen <- fmridat.SPL_putamen %>%
  group_by(Region) %>%
  mutate(Beta_scaled = scale(Beta)) %>%
  ungroup() %>%
    mutate(Region = factor(Region,levels = c('Putamen', 'PMC_SPL')))

c.PMC_SPL <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='PMC_SPL'],
                  fmridat.SPL_putamen$AS_3gt1[fmridat.SPL_putamen$Region=='PMC_SPL'])
c.Putamen <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='Putamen'],
                  fmridat.SPL_putamen$AS_3gt1[fmridat.SPL_putamen$Region=='Putamen'])
c.Regions <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='Putamen'],
                      fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='PMC_SPL'])
cocor <- cocor.dep.groups.overlap(c.PMC_SPL$estimate,
                         c.Putamen$estimate,
                         c.Regions$estimate,
                         length(unique(fmridat.SPL_putamen$pseudonym)))
print(cocor)

N <- fmridat.SPL_putamen %>%
        select(pseudonym) %>%
        unique() %>%
        summarise(N=n())
plot <- ggplot(fmridat.SPL_putamen, aes(x=AS_3gt1, y=Beta_scaled, color=fct_rev(Region))) + 
        geom_point(alpha = .3, shape = 19, size = 1.5, show.legend = FALSE) + 
        geom_smooth(method = 'lm', se = TRUE, lwd = 1.5) +
        scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
                               direction = -1,
                               labels = c(paste('PMC_SPL', ' (n=', N[1],')',
                                                '***', sep=''),
                                          paste('Putamen', ' (n=', N[1],')',
                                                '', sep=''))) +
        ggtitle('Correlation between selection-related\nactivity and action selection') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_sjplot2(base_size = 16, base_family = 'Calibri') +
        theme(legend.position = c(0.25,0.95),
              legend.key.size = unit(0.5,'cm')) +
        xlab('Three > One (response time, s)') +
        ylab('Standardized beta') + 
  ylim(-3,6) +
  facet_grid(~Region)
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_RTas_ON_INT3gtEXT_Severity.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

#####
```

# VBM

## Prepare data

```{r echo=FALSE, message=FALSE}

prep_roi_dat <- function(roi_data, roi_to_cols=TRUE){
  
  roi_data1 <- roi_data
  
  # Demean covariates
  roi_data1 <- roi_data1 %>%
          group_by(group) %>%
          mutate(Age_Dmean = Age - mean(Age),
                 NpsEducYears_Dmean = NpsEducYears - mean(NpsEducYears),
                 TIV_Dmean = TIV - mean(TIV)) %>%
          ungroup()
  
  # Remove superfluous info from mask names
  colnames(roi_data1) <- colnames(roi_data1) %>% str_replace(., 'x_','')
  colnames(roi_data1) <- colnames(roi_data1) %>% str_replace(., 'Mask_','')
  
  # Break mask name into variables
  roi_data1 <- pivot_longer(roi_data1,
                     !c(pseudonym,group,scan,L2Rflip,Age,Age_Dmean,NpsEducYears,NpsEducYears_Dmean,PrefHand_num,TIV,TIV_Dmean),
                     names_to = c('MaskFlip','Contrast','ROI'),
                     names_pattern = '(.*)_(.*_.*)_(.*)',
                     values_to = 'Volume')
  
  # Turn ROIs into separate columns
  if(roi_to_cols){
    roi_data1 <- pivot_wider(roi_data1,
                            id_cols = c('pseudonym','group','scan','L2Rflip','Age','Age_Dmean',
                                        'PrefHand_num', 'NpsEducYears', 'NpsEducYears_Dmean', 
                                        'TIV', 'TIV_Dmean','MaskFlip','Contrast'),
                            names_from = 'ROI',
                            names_prefix = 'ROI_',
                            values_from = 'Volume') %>%
      arrange(Contrast,pseudonym)
  }
  
  # Keep:
  # Flipped contrast + Values from flipped mask
  # Regular contrast + Values from regular mask
  # roi_data1 <- roi_data1 %>%
  #   filter((L2Rflip==1 & MaskFlip=='f') | (L2Rflip==0 & MaskFlip=='nf'))
  
  # Factorize
  # roi_data1 <- roi_data1 %>%
  #   mutate(Contrast = factor(Contrast))
  
  roi_data1
  
}

# Prep data
severity <- dfClin %>%
        filter(ParticipantType == 'PD_POM',
               TimepointNr == 0) %>%
        select(pseudonym, Up3OfBradySum, CognitiveComposite)

# Investigating functional results
vbm_hc.vs.pd <- read_csv('P:/3024006.02/Analyses/CAT12/stats/VBM_shooting-custom/HCvsPD/marsbar/roi_data.csv') %>%
  prep_roi_dat(., roi_to_cols=TRUE)
vbm_hc.vs.pd <- vbm_hc.vs.pd %>%
        mutate(group = factor(group,levels = c('HC','PD'),labels = c(0,1)),
               MaskFlip = factor(MaskFlip,levels = c('nf','f'),labels = c(0,1))) %>%
    filter(Contrast %in% c('HCgtPD_Mean', 'PDgtHC_3gt1', 'PDgtHC_2gt1'))

vbm_subtypes <- read_csv('P:/3024006.02/Analyses/CAT12/stats/VBM_shooting-custom/Subtypes/marsbar/roi_data.csv') %>%
  prep_roi_dat(., roi_to_cols=TRUE)
types <- dfClin %>% filter(TimepointNr==0) %>% filter(ParticipantType!='PD_PIT') %>% select(pseudonym, Subtype) %>%
  mutate(Subtype = as.character(Subtype))
vbm_subtypes <- left_join(vbm_subtypes,types,by='pseudonym') %>%
  relocate(pseudonym, group, Subtype)
vbm_subtypes <- vbm_subtypes %>%
        mutate(Subtype = factor(Subtype,levels = c('1_Mild-Motor','2_Intermediate', '3_Diffuse-Malignant'),labels = c(0,1,2)),
               MaskFlip = factor(MaskFlip,levels = c('nf','f'),labels = c(0,1))) %>%
    filter(Contrast %in% c('MMPgtDM_3gt1','IMgtDM_3gt1','MMPgtDM_Mean'))

vbm_hc.vs.subtypes <- read_csv('P:/3024006.02/Analyses/CAT12/stats/VBM_shooting-custom/HcSubtypes/marsbar/roi_data.csv') %>%
  prep_roi_dat(., roi_to_cols=TRUE)
vbm_hc.vs.subtypes <- left_join(vbm_hc.vs.subtypes,types,by='pseudonym') %>%
        relocate(pseudonym, group, Subtype)
vbm_hc.vs.subtypes <- vbm_hc.vs.subtypes %>%
        mutate(group = factor(group,levels = c('HC','PD'),labels = c(0,1)),
               MaskFlip = factor(MaskFlip,levels = c('nf','f'),labels = c(0,1)),
               Subtype = factor(Subtype)) %>%
    filter(Contrast %in% c('MMPgtHC_3gt1','HCgtDM_3gt1','HCgtMMP_Mean','HCgtIM_Mean','HCgtDM_Mean'))

# Whole-brain VBM analysis
vbm_hcgtpd.wb <- read_csv('P:/3024006.02/Analyses/CAT12/stats/VBM_shooting-custom/HCvsPD/marsbar/roi_data_WholeBrain.csv')
vbm_hcgtpd.wb <- vbm_hcgtpd.wb %>% 
        rename(vmPFC = x_HCgtPD_Mask_2,
               occiptemp = x_HCgtPD_Mask_1) %>%
        left_join(., severity, by = 'pseudonym')
vbm_subtype.wb <- read_csv('P:/3024006.02/Analyses/CAT12/stats/VBM_shooting-custom/Subtypes/marsbar/roi_data_WholeBrain.csv')
vbm_subtype.wb <- vbm_subtype.wb %>%
        rename(vmPFC = `MMP_DM_-18_50_-3`)
vbm_subtype.wb <- left_join(vbm_subtype.wb,types,by='pseudonym') %>%
        relocate(pseudonym, group, Subtype) %>% 
        left_join(., severity, by = 'pseudonym')

# Contrasts are selected for correlation analysis based on significant group
# differences in the VBM analyses below
vbm_pd.for.corr <- read_csv('P:/3024006.02/Analyses/CAT12/stats/VBM_shooting-custom/HCvsPD/marsbar/roi_data.csv') %>%
    prep_roi_dat(., roi_to_cols=TRUE)
vbm_pd.for.corr <- vbm_pd.for.corr %>%
        mutate(group = factor(group,levels = c('HC','PD'),labels = c(0,1)),
               MaskFlip = factor(MaskFlip,levels = c('nf','f'),labels = c(0,1))) %>%
    filter(group==1) %>%
    filter(Contrast %in% c('PDgtHC_3gt1', 'MMPgtDM_Mean', 'MMPgtHC_3gt1'))

# Make a list of subjects that were included in the functional analyses, used later for the VBM comparison
fmri.onvshc <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/HcOn_x_ExtInt2Int3Catch_NoOutliers/marsbar/'
vois <- dir(fmri.onvshc, '*csv', full.names = TRUE)
funcsubs <- vois[1] %>% read_csv() %>% select(pseudonym) %>% unique()

```

## HC vs PD

```{r echo=FALSE,message=FALSE,warning=FALSE}

cons <- vbm_hc.vs.pd$Contrast %>% factor() %>% levels()
for(c in cons){
  
        cat(c)
        if(c=='HCgtPD_Mean'){
                xticks = c('L_PUT','L_PreCG (M1)','R_CB (V)')     
        }else if(c=='PDgtHC_3gt1'){
                xticks = c('R_MTG (TE1p)')
        }else if(c=='PDgtHC_2gt1'){
            xticks = c('R_PUT')
        }
        
  # One-way anova on average volume is the simplest
  vbm_test <- vbm_hc.vs.pd %>%
          filter(Contrast == c) %>%
          filter(pseudonym %in% funcsubs$pseudonym)
  vbm_test <- vbm_test[,colSums(is.na(vbm_test))<nrow(vbm_test)]
  vols <- vbm_test %>% select(starts_with('ROI'))
  avg_vols <- apply(vols, 1, mean)
  vbm_test <- bind_cols(vbm_test, Avg = avg_vols)
  # In order to analyze the side corresponding to the functional result, we need
  # to use different estimates depending on whether the functional beta images were
  # flipped or not. If betas were flipped, then we need to take estimates from the 
  # region that is contralateral to the significant cluster that came out of the 
  # functional analysis.
  idx <- ((vbm_test$L2Rflip==1 & vbm_test$MaskFlip==1) | (vbm_test$L2Rflip==0 & vbm_test$MaskFlip==0))
  vbm_test <- vbm_test[idx,]
  m <- lm(log(Avg) ~ group + Age_Dmean + NpsEducYears_Dmean + PrefHand_num + TIV_Dmean, data = vbm_test)
  # outliers <- outlierTest(m)[[1]] %>% names() %>% as.numeric()
  # m <- lm(Avg ~ group + Age_Dmean + TIV_Dmean, data = vbm_test[-c(outliers), ])
  # summary(m) %>% print()
  Anova(m,type=3) %>% print()
  eta_squared(m, alternative = 'two.sided') %>% kable(.,'pipe', digits = 3) %>% print()
  em <- emmeans(m, pairwise ~ group, adjust='mvt', type = 'response')
  kable(em$emmeans,'pipe', digits = 3) %>% print()
  kable(em$contrasts,'pipe', digits = 3) %>% print()
  
  box_by_roi <- vbm_test %>%
          pivot_longer(cols = starts_with('ROI_'),
                       values_to = 'volume',
                       names_to = 'ROI',
                       names_prefix = 'ROI_') %>%
          ggplot(aes(y = volume, x = ROI, fill = group)) +
          geom_boxplot() +
          scale_x_discrete(labels = xticks) + 
          ggtitle(c)
  
  box_by_avg <- vbm_test %>%
          ggplot(aes(y = Avg, fill = group)) +
          geom_boxplot() +
          ggtitle(c)
  
  box <- ggarrange(box_by_roi, box_by_avg, common.legend = TRUE)
  print(box)
  
  # # PCA perhaps? Probably not.
  # data.pca <- vbm_test %>% select(starts_with('ROI_'))
  # if(ncol(data.pca)>1){
  #         pca <- prcomp(data.pca, center = TRUE, scale. = TRUE)
  #         fviz_pca_biplot(pca, geom.ind = "point", pointshape = 21, 
  #                         pointsize = 2, 
  #                         fill.ind = vbm_test$group, 
  #                         col.ind = "black", 
  #                         palette = "jco", 
  #                         addEllipses = TRUE,
  #                         label = "var",
  #                         col.var = "black",
  #                         repel = TRUE,
  #                         legend.title = "Group") +
  #                 ggtitle("2D PCA-plot from 30 feature dataset") +
  #                 theme(plot.title = element_text(hjust = 0.5))
  #}
  
}

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
N <- vbm_hcgtpd.wb  %>% 
        group_by(pseudonym, group) %>%
        summarise(pseudonym=first(pseudonym),
                  group=first(group)) %>%
        na.omit() %>%
        ungroup() %>%
        select(group) %>%
        table()
plot <- raincloudplot_1Factor(data=vbm_hcgtpd.wb, y='occiptemp', groupvar='group',
                           title = 'Influence of Parkinson\'s disease on\noccipito-temporal grey matter volume', ylab = 'Grey matter volume', xlab = '',
                           xticklabs = c(paste('Control', ' (n=', N[1],')', sep=''),
                                         paste('PD-On', ' (n=', N[2],')', sep='')),
                           color_scheme='mako', provided_summary = 'None') +
        ylim(0.29,0.56)
y <- 0.56
d = 0.02
segmap <- data.frame(
        x =    c(1.00, 1.00, 2.00),
        xend = c(2.00, 1.00, 2.00),
        y =    c(y,    y,    y),
        yend = c(y,    y-d*1,y-d*1)
)
sigmap <- data.frame(
        x =     c(1.5),
        y =     c(y),
        label = c('***')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/VBM_WholeBrain_HCvsPD_OccTmp.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

corrdat <- vbm_hcgtpd.wb %>%
        mutate(GMV = (occiptemp+vmPFC)/2,
               Age = Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               PrefHand_num=factor(PrefHand_num),
               TIV = TIV-mean(TIV,na.rm=T),
               Up3OfBradySum=Up3OfBradySum-mean(Up3OfBradySum,na.rm=T),
               CognitiveComposite=CognitiveComposite-mean(CognitiveComposite,na.rm=T)) %>%
        na.omit()
m <- lm(log(GMV) ~ Up3OfBradySum+CognitiveComposite + Age + NpsEducYears + PrefHand_num + TIV, data = corrdat)
s <- summary(m)
print(s)
anova <- Anova(m, type=3)
print(anova)
eta_squared(m) %>% print()
ggemmeans(m, terms=c('Up3OfBradySum')) %>% plot()
ggemmeans(m, terms=c('CognitiveComposite')) %>% plot()

```

## Subtypes

```{r echo=FALSE,message=FALSE,warning=FALSE}

cons <- vbm_subtypes$Contrast %>% factor() %>% levels()
for(c in cons){
  
  cat(c)
        if(c=='IMgtDM_3gt1'){
                xticks = c('L_MFG (6a)')     
        }else if(c=='MMPgtDM_3gt1'){
                xticks = c('R_PMC (i6-8)', 'R_SPL (7A)', 'R_SPL (7P)', 'R_IPL (PFm)')
        }else if(c=='MMPgtDM_Mean'){
                xticks = c('R_PostCG (2)')
        }
  
  # # MANOVA followed by univariate anovas and LDA
  # vbm_test <- vbm_subtypes %>%
  #   filter(Contrast == c)
  # dv <- vbm_test %>% select(starts_with('ROI_')) %>% as.matrix()
  # iv <- vbm_test %>% select(Subtype) %>% as.matrix()
  # maov <- manova(dv ~ iv, data = vbm_test)
  # s <- summary(maov)
  # s.aov <- summary.aov(maov)
  # effsize <- effectsize(maov)
  # lda <- lda(iv ~ dv, CV = FALSE)
  # lda_df <- data.frame(
  #   groups = vbm_test[, 'Subtype'],
  #   lda = predict(lda)$x
  # )
  # ggplot(lda_df) + 
  #   geom_point(aes(x = lda.LD1, y = lda.LD2, color = Subtype), size = 4) +
  #   theme_classic()
  
  # Group x ROI ANOVA also possible...
  
  # One-way anova on average volume is the simplest
  vbm_test <- vbm_subtypes %>%
    filter(Contrast == c) %>%
          filter(pseudonym %in% funcsubs$pseudonym)
  vbm_test <- vbm_test[,colSums(is.na(vbm_test))<nrow(vbm_test)]
  g <- tibble(MMP = str_detect(c,'MMP'), IM = str_detect(c,'IM'), DM = str_detect(c, 'DM'))
  if(g$MMP & g$IM){
    vbm_test <- vbm_test %>% filter(Subtype == 0 | Subtype == 1)
  }else if(g$MMP & g$DM){
    vbm_test <- vbm_test %>% filter(Subtype == 0 | Subtype == 2)
  }else if(g$IM & g$DM){
    vbm_test <- vbm_test %>% filter(Subtype == 1 | Subtype == 2)
  }
  vols <- vbm_test %>% select(starts_with('ROI'))
  avg_vols <- apply(vols, 1, mean)
  vbm_test <- bind_cols(vbm_test, Avg = avg_vols)
  idx <- ((vbm_test$L2Rflip==1 & vbm_test$MaskFlip==1) | (vbm_test$L2Rflip==0 & vbm_test$MaskFlip==0))
  vbm_test <- vbm_test[idx,]
  m <- lm(log(Avg) ~ Subtype + Age_Dmean + TIV_Dmean, data = vbm_test)
  # summary(m) %>% print()
  Anova(m,type=3) %>% print()
  eta_squared(m, alternative = 'two.sided') %>% kable(.,'pipe', digits = 3) %>% print()
  em <- emmeans(m, pairwise ~ Subtype, adjust='mvt', type = 'response')
  kable(em$emmeans,'pipe', digits = 3) %>% print()
  kable(em$contrasts,'pipe', digits = 3) %>% print()
  
  box_by_roi <- vbm_test %>%
          pivot_longer(cols = starts_with('ROI_'),
                       values_to = 'volume',
                       names_to = 'ROI',
                       names_prefix = 'ROI_') %>%
          ggplot(aes(y = volume, x = ROI, fill = Subtype)) +
          geom_boxplot() +
          scale_x_discrete(labels = xticks) + 
          ggtitle(c)
  
  box_by_avg <- vbm_test %>%
          ggplot(aes(y = Avg, fill = Subtype)) +
          geom_boxplot() +
          ggtitle(c)
  
  box <- ggarrange(box_by_roi, box_by_avg, common.legend = TRUE)
  print(box)
  
}

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
N <- vbm_subtype.wb  %>% 
        group_by(pseudonym, Subtype) %>%
        summarise(first(pseudonym),
                  first(group)) %>%
        na.omit() %>%
        ungroup() %>%
        select(Subtype) %>%
        table()
plot <- raincloudplot_1Factor(data=vbm_subtype.wb, y='vmPFC', groupvar='Subtype',
                           title = 'Influence of subtypes on medial\nprefrontal cortex grey matter volume', ylab = 'Grey matter volume', xlab = '',
                           xticklabs = c(paste('MMP', ' (n=', N[1],')', sep=''),
                                         paste('IM', ' (n=', N[2],')', sep=''),
                                         paste('DM', ' (n=', N[3],')', sep='')),
                           color_scheme='viridis', provided_summary = 'None') +
        ylim(0.24,0.55)
y <- 0.55
d = 0.02
segmap <- data.frame(
        x =    c(1.00, 1.00, 3.00),
        xend = c(3.00, 1.00, 3.00),
        y =    c(y,    y,    y),
        yend = c(y,    y-d*1,y-d*1)
)
sigmap <- data.frame(
        x =     c(2),
        y =     c(y),
        label = c('*')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/VBM_WholeBrain_Subtypes_mPFC.tiff',
          plot, dpi=300, device='tiff', base_width = 5)

corrdat <- vbm_subtype.wb %>%
        mutate(GMV = vmPFC,
               Age = Age-mean(Age,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               PrefHand_num=factor(PrefHand_num),
               TIV = TIV-mean(TIV,na.rm=T),
               Up3OfBradySum=Up3OfBradySum-mean(Up3OfBradySum,na.rm=T),
               CognitiveComposite=CognitiveComposite-mean(CognitiveComposite,na.rm=T)) %>%
        na.omit()
m <- lm(log(GMV) ~ Up3OfBradySum+CognitiveComposite + Age + NpsEducYears + PrefHand_num + TIV, data = corrdat)
s <- summary(m)
print(s)
anova <- Anova(m, type=3)
print(anova)
eta_squared(m) %>% print()
ggemmeans(m, terms=c('Up3OfBradySum')) %>% plot()
ggemmeans(m, terms=c('CognitiveComposite')) %>% plot()

```

## HC vs Subtypes

```{r echo=FALSE,message=FALSE,warning=FALSE}

cons <- vbm_hc.vs.subtypes$Contrast %>% factor() %>% levels()
cons <- cons[!str_detect(cons,'HC.*Mean')]
for(c in cons){
        
        cat(c)
        if(c=='HCgtDM_3gt1'){
                xticks = c('L_MFG (6a)')
        }else if(c=='MMPgtHC_3gt1'){
                xticks = c('R_IPL (PFm)', 'R_MFG (8Av)', 'R_MTG (TE1p)', 'R_SFG (9a)')
        }else if(c=='IMgtHC_2gt1'){
            xticks = c('R_PUT')
        }
        
        # One-way anova on average volume is the simplest
        vbm_test <- vbm_hc.vs.subtypes %>%
                filter(Contrast == c) %>%
                filter(pseudonym %in% funcsubs$pseudonym)
        vbm_test <- vbm_test[,colSums(is.na(vbm_test))<nrow(vbm_test)]
        g <- tibble(HC = str_detect(c,'HC'), MMP = str_detect(c,'MMP'), IM = str_detect(c,'IM'), DM = str_detect(c, 'DM'))
        if(g$HC & g$MMP){
                vbm_test <- vbm_test %>% filter(Subtype == '0_Healthy' | Subtype == '1_Mild-Motor')
        }else if(g$HC & g$IM){
                vbm_test <- vbm_test %>% filter(Subtype == '0_Healthy' | Subtype == '2_Intermediate')
        }else if(g$HC & g$DM){
                vbm_test <- vbm_test %>% filter(Subtype == '0_Healthy' | Subtype == '3_Diffuse-Malignant')
        }
        vols <- vbm_test %>% select(starts_with('ROI_'))
        avg_vols <- apply(vols, 1, mean)
        vbm_test <- bind_cols(vbm_test, Avg = avg_vols)
        idx <- ((vbm_test$L2Rflip==1 & vbm_test$MaskFlip==1) | (vbm_test$L2Rflip==0 & vbm_test$MaskFlip==0))
        vbm_test <- vbm_test[idx,]
        # # Check outliers
        # summary <- vbm_test %>%
        #   summarise(avg=mean(Avg),sd=sd(Avg))
        # outliers <- vbm_test %>%
        #   mutate(Outlier = if_else(Avg > summary$avg+3*summary$sd | Avg < summary$avg-3*summary$sd, 1, 0)) %>%
        #   filter(Outlier==1)
        # vbm_test_clean <- vbm_test %>% filter(!(pseudonym %in% outliers$pseudonym))
        
        m <- lm(log(Avg) ~ Subtype + Age_Dmean + NpsEducYears_Dmean + PrefHand_num + TIV_Dmean, data = vbm_test)
        # summary(m) %>% print()
        Anova(m,type=3) %>% print()
        eta_squared(m, alternative = 'two.sided') %>% kable(.,'pipe', digits = 3) %>% print()
        em <- emmeans(m, pairwise ~ Subtype, adjust='mvt', type = 'response')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        
        box_by_roi <- vbm_test %>%
                pivot_longer(cols = starts_with('ROI_'),
                             values_to = 'volume',
                             names_to = 'ROI',
                             names_prefix = 'ROI_') %>%
                ggplot(aes(y = volume, x = ROI, fill = Subtype)) +
                geom_boxplot() +
                scale_x_discrete(labels = xticks) + 
                ggtitle(c)
        
        box_by_avg <- vbm_test %>%
                ggplot(aes(y = Avg, fill = Subtype)) +
                geom_boxplot() +
                ggtitle(c)
        
        box <- ggarrange(box_by_roi, box_by_avg, common.legend = TRUE)
        print(box)
        
        # # Post hoc by region
        # if(c=='MMPgtHC_3gt1'){
        #   vbm_test.sep <- vbm_test %>%
        #     pivot_longer(cols = starts_with('ROI'),
        #                  names_to = 'ROI',
        #                  values_to = 'GMV') %>%
        #     mutate(ROI = factor(ROI, labels = xticks, levels = c('ROI_1','ROI_2','ROI_3','ROI_4')))
        #   m.sep <- lm(log(GMV) ~ Subtype + Age_Dmean + TIV_Dmean, data = vbm_test.sep[vbm_test.sep$ROI=='R_MTG (TE1p)',])
        #   Anova(m.sep,type=3) %>% print()
        #   eta_squared(m.sep, alternative = 'two.sided') %>% kable(.,'pipe', digits = 3) %>% print()
        # }
        
}

# Post hoc exploration of structure vs function
#
# MMPvsHC.vbm <- vbm_hc.vs.subtypes %>%
#         filter(Subtype=='0_Healthy' | Subtype=='1_Mild-Motor',
#                Contrast=='MMPgtHC_3gt1')
# 
# MMPvsHC.mtg <- read_csv("P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/HcSubtypes_x_ExtInt2Int3Catch_NoOutliers/marsbar/MMP_HC_(Int3_Ext)_23_58_30.csv") %>% select(-c(Group,scans))
# MMPvsHC.pmc <- read_csv("P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/HcSubtypes_x_ExtInt2Int3Catch_NoOutliers/marsbar/MMP_HC_(Int3_Ext)_27_11_40.csv") %>% select(-c(Group,scans))
# MMPvsHC.fp <- read_csv("P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/HcSubtypes_x_ExtInt2Int3Catch_NoOutliers/marsbar/MMP_HC_(Int3_Ext)_51_-63_46.csv") %>% select(-c(Group,scans))
# MMPvsHC.ipl <- read_csv("P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Baseline/HcSubtypes_x_ExtInt2Int3Catch_NoOutliers/marsbar/MMP_HC_(Int3_Ext)_61_-37_-14.csv") %>% select(-c(Group,scans))
# 
# disease_severity <- dfClin %>%
#   filter(ParticipantType == 'PD_POM') %>%
#   filter(Subtype == '1_Mild-Motor') %>%
#   filter(TimepointNr == 0) %>%
#   select(pseudonym, MotorComposite, Up3OfTotal, Up3OfAppendicularSum,
#          CognitiveComposite, SCOPA_AUTSum, RBDSQSum, MonthSinceDiag)
# 
# struc.vs.fun <- full_join(MMPvsHC.mtg,MMPvsHC.vbm, by = 'pseudonym') %>%
#         arrange(pseudonym) %>%
#         na.omit() %>%
#         filter(Cond != 'Catch') %>%
#         select(-c(scan, L2Rflip, Contrast, group)) %>%
#         pivot_wider(id_cols = c('pseudonym', 'Subtype', 'MaskFlip', 'Age', 'TIV', 'ROI_1', 'ROI_2', 'ROI_3', 'ROI_4'),
#                     names_from = Cond, values_from = Vals) %>%
#         mutate(Avg.vbm = (ROI_1 + ROI_2 + ROI_3 + ROI_4) / 4,
#                Diff.3gt1 = Int3 - Ext,
#                Diff.3gt2 = Int3 - Int2) %>%
#   left_join(., disease_severity, by = 'pseudonym')
# 
# struc.vs.fun %>% select(Subtype) %>% table()
# 
# # Is there an association between brain activity and structure?
# ggplot(struc.vs.fun, aes(x=Avg.vbm, y=Diff.3gt1, color=Subtype)) + 
#         geom_point() + 
#         geom_smooth(method='lm') + 
#         facet_grid(MaskFlip~Subtype)
# 
# m.hc <- lmer(Avg.vbm ~ Diff.3gt1*MaskFlip+Age+TIV+(1|pseudonym), data = struc.vs.fun, subset = (struc.vs.fun$Subtype=='0_Healthy'))
# summary(m.hc)
# m.mmp <- lmer(Avg.vbm ~ Diff.3gt1*MaskFlip+Age+TIV+(1|pseudonym), data = struc.vs.fun, subset = (struc.vs.fun$Subtype=='1_Mild-Motor'))
# summary(m.mmp)
# 
# # Is there an association between structure and symptom severity?
# struc.vs.fun %>%
#   filter(Subtype == '1_Mild-Motor') %>%
#   ggplot(aes(x=Avg.vbm, y=Up3OfTotal, color=Subtype)) + 
#   geom_point() +
#   geom_smooth(method='lm') + 
#         facet_grid(~ MaskFlip)
# m.mmp <- lmer(Avg.vbm ~ Up3OfAppendicularSum*MaskFlip + Age + TIV + (1|pseudonym), data = struc.vs.fun, subset = (struc.vs.fun$Subtype=='1_Mild-Motor'))
# anova(m.mmp) # Larger volumes = More severe symptoms

# # Is there an association between task performance and structure?
# RTs <- tmp.for.struc %>%
#   ungroup() %>%
#   filter(ParticipantType=='MMP') %>%
#   mutate(ParticipantType='1_Mild-Motor') %>%
#   pivot_wider(id_cols = c('pseudonym','ParticipantType'),
#               names_from = trial_type,
#               values_from = response_time) %>%
#   mutate(RT.Avg = (`1choice` + `2choice` + `3choice`)/3,
#          RT.Diff.3gt1 = `3choice` - `1choice`) %>%
#   rename(Subtype = ParticipantType) %>%
#   select(pseudonym, Subtype, RT.Avg, RT.Diff.3gt1)
# 
# struc.vs.fun2 <- left_join(struc.vs.fun, RTs, by=c('pseudonym','Subtype')) %>%
#   filter(Subtype == '1_Mild-Motor')
# 
# struc.vs.fun2 %>%
#   ggplot(aes(x=Avg.vbm,y=RT.Avg)) + 
#   geom_point() + 
#   geom_smooth(method='lm')
# m <- lm(Avg.vbm ~ RT.Avg + Age + TIV, data = struc.vs.fun2)
# anova(m)  # Smaller volumes = Slower avg RTs
# 
# struc.vs.fun2 %>%
#   ggplot(aes(x=Avg.vbm,y=RT.Diff.3gt1)) + 
#   geom_point() + 
#   geom_smooth(method='lm')
# m <- lm(Avg.vbm ~ RT.Diff.3gt1 + Age + TIV, data = struc.vs.fun2)
# anova(m)
# 
# m <- lm(RT.Avg ~ Up3OfTotal, data = struc.vs.fun2)


```

## Brain-structure correlations

```{r echo=FALSE,message=FALSE,warning=FALSE, eval=FALSE}

cons <- vbm_pd.for.corr$Contrast %>% factor() %>% levels()
corrtab.brady = c()
corrtab.brady <- tibble(Contrast=cons,Estimate=NA,SE=NA,CI.upr=NA,CI.lwr=NA,T.val=NA,df=NA,
                  P.val=NA,P.val.corr=NA,Cohen.D=NA,Sig=0,Sig.corr=NA)
corrtab.cogcom = c()
corrtab.cogcom <- tibble(Contrast=cons,Estimate=NA,SE=NA,CI.upr=NA,CI.lwr=NA,T.val=NA,df=NA,
                  P.val=NA,P.val.corr=NA,Cohen.D=NA,Sig=0,Sig.corr=NA)
counter=1
while(counter <= length(cons)){
  
        c <- cons[counter]
        cat(c)
        
        # One-way anova on average volume is the simplest
        vbm_test <- vbm_pd.for.corr %>%
                filter(Contrast == c) %>%
                filter(pseudonym %in% funcsubs$pseudonym)
        vbm_test <- vbm_test[,colSums(is.na(vbm_test))<nrow(vbm_test)]
        vols <- vbm_test %>% select(starts_with('ROI'))
        avg_vols <- apply(vols, 1, mean)
        vbm_test <- bind_cols(vbm_test, Avg = avg_vols)
        # In order to analyze the side corresponding to the functional result, we need
        # to use different estimates depending on whether the functional beta images were
        # flipped or not. If betas were flipped, then we need to take estimates from the 
        # region that is contralateral to the significant cluster that came out of the 
        # functional analysis.
        idx <- ((vbm_test$L2Rflip==1 & vbm_test$MaskFlip==1) | (vbm_test$L2Rflip==0 & vbm_test$MaskFlip==0))
        vbm_test <- vbm_test[idx,]
        
        cat('\nStructure-Clinical correlation')
        clinscore <- dfClin %>%
                filter(ParticipantType=='PD_POM',
                       TimepointNr==0) %>%
                select(pseudonym, Up3OfBradySum, CognitiveComposite) %>%
                mutate(Up3OfBradySum_Dmean = Up3OfBradySum - mean(Up3OfBradySum,na.rm=T),
                       CognitiveComposite_Dmean = CognitiveComposite - mean(CognitiveComposite,na.rm=T))
        vbm_test.clin <- vbm_test %>%
                left_join(., clinscore, by='pseudonym')
        
        m.brady <- lm(log(Avg) ~ Up3OfBradySum_Dmean + Age_Dmean + NpsEducYears_Dmean + factor(PrefHand_num) + TIV_Dmean, data = vbm_test.clin)
        s.brady <- summary(m.brady)
        print(s.brady)
        Anova(m.brady, type=3)  %>% kable(.,'pipe', digits = 3) %>% print()
        eta_squared(m.brady, alternative = 'two.sided') %>% kable(.,'pipe', digits = 3) %>% print()
        g.brady <- ggplot(vbm_test.clin, aes(x=Up3OfBradySum,y=Avg)) +
                geom_point() +
                geom_smooth(method='lm') +
                ggtitle(c)
        
        m.cogcom <- lm(log(Avg) ~ CognitiveComposite_Dmean + Age_Dmean + NpsEducYears_Dmean + factor(PrefHand_num) + TIV_Dmean, data = vbm_test.clin)
        s.cogcom <- summary(m.cogcom)
        print(s.cogcom)
        Anova(m.cogcom, type=3)  %>% kable(.,'pipe', digits = 3) %>% print()
        eta_squared(m.cogcom, alternative = 'two.sided') %>% kable(.,'pipe', digits = 3) %>% print()
        g.cogcom <- ggplot(vbm_test.clin, aes(x=CognitiveComposite,y=Avg)) +
                geom_point() +
                geom_smooth(method='lm') +
                ggtitle(c)
        
        m.both <- lm(log(Avg) ~ Up3OfBradySum_Dmean + CognitiveComposite_Dmean + Age_Dmean + NpsEducYears_Dmean + factor(PrefHand_num) + TIV_Dmean, data = vbm_test.clin)
        s.both <- summary(m.both)
        print(s.both)
        Anova(m.both, type=3)  %>% kable(.,'pipe', digits = 3) %>% print()
        eta_squared(m.both, alternative = 'two.sided') %>% kable(.,'pipe', digits = 3) %>% print()
        
        g <- ggarrange(g.brady,g.cogcom,nrow=2,ncol=2)
        print(g)
        
        corrtab.brady$Estimate[counter] <- s.brady$coefficients[2,1]
        corrtab.brady$SE[counter] <- s.brady$coefficients[2,2]
        corrtab.brady$CI.upr[counter] <- confint(m.brady)[2,2]
        corrtab.brady$CI.lwr[counter] <- confint(m.brady)[2,1]
        corrtab.brady$T.val[counter] <- s.brady$coefficients[2,3]
        corrtab.brady$df[counter] <- df.residual(m.brady)
        corrtab.brady$P.val[counter] <- s.brady$coefficients[2,4]
        corrtab.brady$P.val.corr[counter] <- p.adjust(p=corrtab.brady$P.val[counter], method='bonferroni', n=length(cons))
        d <- t_to_d(corrtab.brady$T.val[counter],
                    df_error = df.residual(m.brady),
                    alternative = 'two.sided')
        corrtab.brady$Cohen.D[counter] <- d$d
        corrtab.brady$Sig[counter] <- if_else(corrtab.brady$P.val[counter]<0.05,1,0)
        corrtab.brady$Sig.corr[counter] <- if_else(corrtab.brady$P.val.corr[counter]<0.05,1,0)
        
        corrtab.cogcom$Estimate[counter] <- s.cogcom$coefficients[2,1]
        corrtab.cogcom$SE[counter] <- s.cogcom$coefficients[2,2]
        corrtab.cogcom$CI.upr[counter] <- confint(m.cogcom)[2,2]
        corrtab.cogcom$CI.lwr[counter] <- confint(m.cogcom)[2,1]
        corrtab.cogcom$T.val[counter] <- s.cogcom$coefficients[2,3]
        corrtab.cogcom$df[counter] <- df.residual(m.cogcom)
        corrtab.cogcom$P.val[counter] <- s.cogcom$coefficients[2,4]
        corrtab.cogcom$P.val.corr[counter] <- p.adjust(p=corrtab.cogcom$P.val[counter], method='bonferroni', n=length(cons))
        d <- t_to_d(corrtab.cogcom$T.val[counter],
                    df_error = df.residual(m.cogcom),
                    alternative = 'two.sided')
        corrtab.cogcom$Cohen.D[counter] <- d$d
        corrtab.cogcom$Sig[counter] <- if_else(corrtab.cogcom$P.val[counter]<0.05,1,0)
        corrtab.cogcom$Sig.corr[counter] <- if_else(corrtab.cogcom$P.val.corr[counter]<0.05,1,0)
        
        counter=counter+1
  
}

corrtab.brady.kable <- kable(corrtab.brady, 'pipe', digits = 5)
print(corrtab.brady.kable)

corrtab.cogcom.kable <- kable(corrtab.cogcom, 'pipe', digits = 5)
print(corrtab.cogcom.kable)

```

# Right handed MMP with matched controls

```{r echo=FALSE, message=FALSE}

df.Control_right <- df %>% 
        filter(Subtype == '1_Mild-Motor' | Subtype == '0_Healthy') %>%
        group_by(pseudonym, Subtype) %>%
        summarise(RespondingHand=first(RespondingHand),
                  PrefHand=first(PrefHand),
                  Age=first(Age),
                  Gender=first(Gender),
                  NpsEducYears=first(NpsEducYears)) %>%
        filter(RespondingHand=='Right' & PrefHand=='Right') %>% 
        ungroup() %>%
        mutate(Subtype = factor(Subtype))

summary_factorlist(df.Control_right, 
                   dependent = 'Subtype',
                   explanatory = c('Age','Gender','NpsEducYears'),
                   p = T) %>% 
        print()

write_csv(df.Control_right, 'P:/3024006.02/Data/matlab/right_hand_responders(MMP_HC).csv')

```


